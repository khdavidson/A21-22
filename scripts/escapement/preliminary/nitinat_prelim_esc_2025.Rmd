---
title: "Nitinat escapement 2025 (PRELIM)"
author: "South Coast StA"
date: "Last update: `r Sys.Date()`"
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_collapsed: false 
    toc_depth: 5
    number_sections: true
knit: (function(inputFile, encoding) { 
  rmarkdown::render(inputFile, encoding=encoding, output_file=paste0(substr(inputFile,1,nchar(inputFile)-4), "_PRELIMINARY_", format(Sys.Date(), 
  sep="_", "%Y-%m-%d"), '.html'))
  }
  )
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F, warning=F, message=F)


# Load libraries ----------------------------
library(tidyverse)



# Helpers ----------------------------
options(scipen = 9999999)
"%notin%" <- Negate("%in%")
analysis_year <- 2025               # ***** UPDATE EACH YEAR ******



# ============================= EXCEL SIL DATA ============================

# SIL data from SIL+AUC Databse export for Area 22 ---------------------
nitinat.SIL <- readxl::read_excel(path=list.files(path=paste0(here::here("data", "escapement", "prelim-inseason", analysis_year)),
                                                  pattern="SILAUC_Export",
                                                  full.names=T),
                                  sheet=1) %>% 
  mutate(SBJ_ID = case_match(SBJ_ID,
                             1 ~ "Sockeye",
                             2 ~ "Coho",
                             3 ~ "Pink",
                             4 ~ "Chum",
                             5 ~ "Chinook",
                             6 ~ "Rainbow Trout",
                             515039223 ~ "Steelhead",
                             8 ~ "Cutthroat Trout",
                             TRUE ~ "FLAG"),
         date = lubridate::ymd(stringr::str_sub(START_DTT, start=1, end=10)),
         segment_category = case_when(SEGMENT_NAME %in% c("18-17", "17-16", "16-15", "15-14", "14-13", "13-12", 
                                                          "12-11", "11-10", "10-9", "9-8", "8-7", "7-6", "6-5", 
                                                          "5-4", "4-3", "3-2", "2-1", "1-0",
                                                          "0-Lake", "7-0", "12-7", "17-12") ~ "Lower",
                                      TRUE ~ "Upper"),
         survey_type = case_when(STREAM_MTP_ID==6 & SEGMENT_NAME %in% c("35-34", "34-29", "29-23", "23-17", 
                                                                        "17-12", "12-7", "7-0", "0-Lake") ~ "Heli",
                                 STREAM_MTP_ID==3 ~ "Snorkel",
                                 TRUE ~ "FLAG")) %>%
  filter(!grepl("san juan|gordon|harris|lens|renfrew|jordan", NAME, ignore.case=T))

nitinat.SIL$SEGMENT_NAME <- factor(nitinat.SIL$SEGMENT_NAME, levels=c("35-34", "34-33", 
                                                                      "34-29", 
                                                                      "33-32", "32-31", "31-30", "30-29", "29-28",
                                                                      "29-23",
                                                                      "28-27", "27-26", "26-25", "25-24", "24-23", "23-22", 
                                                                      "23-17",
                                                                      "22-21", "21-20", "20-19", "19-18", "18-17", "17-16", 
                                                                      "17-12", 
                                                                      "16-15", "15-14", "14-13", "13-12", "12-11", 
                                                                      "12-7", 
                                                                      "11-10", "10-9", "9-8", "8-7", "7-6",
                                                                      "7-0", 
                                                                      "6-5", "5-4", "4-3", "3-2", "2-1", "1-0",
                                                                      "0-Lake", ordered=T))



# ============================= SIL+AUC DATABASE data ============================

# AUC Data Analysis Table ---------------------
# MAYBE DELETE THIS TABLE READ - MAY NOT NEED IT 
#   This table only fills in after you go through the Escapement Estimates > AUC Calculator and update your % pop/OE 
#   expansions
# AUCdataTable <- readxl::read_excel(path=paste0(here::here("data", "escapement", "prelim-inseason", 
#                                                           analysis_year,
#                                                           "AUC_DataAnalysisTable_area21-22_"),
#                                                analysis_year,
#                                                ".xlsx"))
escEstAUCsource <- readxl::read_excel(path=paste0(here::here("data", "escapement", "prelim-inseason", 
                                                           analysis_year,
                                                           "EscEstAUCSource_area21-22_"),
                                                analysis_year,
                                                ".xlsx")) %>% 
  left_join(.,
            readxl::read_excel(path=here::here("data", "escapement", "prelim-inseason", "WaterbodiesValues.xlsx")) %>% 
              mutate(AREA = case_when(NAME=="TUCK LAKE" ~ "22",
                                      TRUE ~ AREA)) %>%
              select(AREA, NAME, WATERSHED_CDE) %>% 
              rename(WatershedCode = WATERSHED_CDE) %>% 
              filter(!is.na(WatershedCode)) %>% 
              group_by(AREA, NAME, WatershedCode) %>% 
              filter(AREA %in% c(20, 21, 22)) %>% 
              group_by(WatershedCode) %>% 
              mutate(n=n(),
                     system = case_when(n>1 ~ paste0("system", seq(1,length(n),by=1)),
                                        n==1 ~ "system1")) %>% 
              group_by(WatershedCode) %>% 
              pivot_wider(names_from=system, values_from=NAME) %>% 
              select(-n) %>% 
              unite("SystemName", system1:system3, sep=", ", remove=T, na.rm=T) %>% 
              mutate(SystemName = str_to_title(SystemName)),
            na_matches="never", relationship="many-to-one")  


# EscEstSppHeader table ---------------------
#   This table only fills in after you go through the Escapement Estimates > AUC Calculator and fill in the AUC/PL+D
#   sections. Unfortunately it's a bit iterative...
escEstSpp <- readxl::read_excel(path=paste0(here::here("data", "escapement", "prelim-inseason", 
                                                       analysis_year,
                                                       "EscEstSppHeader_area20-22_"),
                                            analysis_year,
                                            ".xlsx")) %>% 
  left_join(.,
            readxl::read_excel(path=here::here("data", "escapement", "prelim-inseason", "WaterbodiesValues.xlsx")) %>% 
              mutate(AREA = case_when(NAME=="TUCK LAKE" ~ "22",
                                      TRUE ~ AREA)) %>%
              select(AREA, NAME, WATERSHED_CDE) %>% 
              rename(WatershedCode = WATERSHED_CDE) %>% 
              filter(!is.na(WatershedCode)) %>% 
              group_by(AREA, NAME, WatershedCode) %>% 
              filter(AREA %in% c(20,21,22)) %>% 
              group_by(WatershedCode) %>% 
              mutate(n=n(),
                     system = case_when(n>1 ~ paste0("system", seq(1,length(n),by=1)),
                                        n==1 ~ "system1")) %>% 
              group_by(WatershedCode) %>% 
              pivot_wider(names_from=system, values_from=NAME) %>% 
              select(-n) %>% 
              unite("SystemName", system1:system3, sep=", ", remove=T, na.rm=T) %>% 
              mutate(SystemName = str_to_title(SystemName)),
            na_matches="never", relationship="many-to-one") %>%
  mutate(AdultMidResidenceTime_R = round((AdultShortResidenceTime + AdultLongResidenceTime)/2,1),
         JackMidResidenceTime_R = round((JackShortResidenceTime + JackLongResidenceTime)/2,1),
         AdultExpAUCMidValue_R = round(AdultExpAUCSumOfFishDays/AdultMidResidenceTime_R,0),
         JackExpAUCMidValue_R = round(JackExpAUCSumOfFishDays/JackMidResidenceTime_R,0)) %>% 
  relocate(AdultMidResidenceTime_R, .before = AdultLongResidenceTime) %>%
  relocate(JackMidResidenceTime_R, .before = JackLongResidenceTime) %>% 
  relocate(AdultExpAUCMidValue_R, .before=AdultExpAUCHighValue) %>% 
  relocate(JackExpAUCMidValue_R, .before=JackExpAUCHighValue) %>% 
  mutate(AdultNaturalReco = case_when(AdultNaturalReco<0 ~ 0,
                                      TRUE ~ AdultNaturalReco))



# EscEstAUCResults table --------------------- 
#   This table only fills in after you go through the Escapement Estimates > AUC Calculator and fill in the AUC/PL+D
#   sections. Unfortunately it's a bit iterative...
escEstAUC <- readxl::read_excel(path=paste0(here::here("data", "escapement", "prelim-inseason", 
                                                       analysis_year,
                                                       "EscEstAUCResults_area20-22_"),
                                            analysis_year,
                                            ".xlsx")) %>% 
  left_join(.,
            readxl::read_excel(path=here::here("data", "escapement", "prelim-inseason", "WaterbodiesValues.xlsx")) %>% 
              mutate(AREA = case_when(NAME=="TUCK LAKE" ~ "22",
                                      TRUE ~ AREA)) %>%
              select(AREA, NAME, WATERSHED_CDE) %>% 
              rename(WatershedCode = WATERSHED_CDE) %>% 
              filter(!is.na(WatershedCode)) %>% 
              group_by(AREA, NAME, WatershedCode) %>% 
              filter(AREA %in% c(20,21,22)) %>% 
              group_by(WatershedCode) %>% 
              mutate(n=n(),
                     system = case_when(n>1 ~ paste0("system", seq(1,length(n),by=1)),
                                        n==1 ~ "system1")) %>% 
              group_by(WatershedCode) %>% 
              pivot_wider(names_from=system, values_from=NAME) %>% 
              #select(-n) %>% 
              unite("SystemName", system1:system3, sep=", ", remove=T, na.rm=T) %>% 
              mutate(SystemName = str_to_title(SystemName)),
            na_matches="never", relationship="many-to-one") %>% 
  # **** UPDATE HELI DATE EACH YEAR! MAY BE SPECIES SPECIFIC: ****
  mutate(method = case_when(ShortSpecies=="CM" & DateRange== "2025/10/16 - 2025/10/21" ~ "heli", 
                            TRUE ~ "snorkel"),
         across(c(RawAdultFishDays:ExpJackFishDays), ~replace_na(., 0)))



# ============================= EPRPO HATCHERY ============================

# CHINOOK swim-ins ----------------------------
nrh.cn <- readxl::read_excel(path=list.files(path=paste0("//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/ESCAPEMENT/Data/",
                                                         analysis_year,
                                                         "/SILs/Area 22/"),
                                             pattern="^Adult_Management - Nitinat CN",
                                             full.names = T),
                             skip=1) %>%
  janitor::clean_names()


# CHUM swim-ins ----------------------------
nrh.cm <- readxl::read_excel(path=list.files(path=paste0("//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/ESCAPEMENT/Data/",
                                                         analysis_year,
                                                         "/SILs/Area 22/"),
                                             pattern="^Adult_Management - Nitinat CM",
                                             full.names = T),
                             skip=1) %>%
  janitor::clean_names()
  # list.files(paste0(path="//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/ESCAPEMENT/Data/",
  #                           analysis_year,
  #                           "/SILs/Area 21-22/"),
  #                    pattern = "^Adult_Management - Nitinat CM", full.names = T) %>%
  # map(~readxl::read_excel(path=.x, trim_ws=T, guess_max=20000, sheet="Adult Management", skip=1), id="path") %>%
  # list_rbind() %>%
  # select_all(~gsub("\\s+|\\.", "", .))  


# COHO swim-ins ----------------------------
nrh.co <- readxl::read_excel(path=list.files(path=paste0("//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/ESCAPEMENT/Data/",
                                                         analysis_year,
                                                         "/SILs/Area 22/"),
                                             pattern="^Adult_Management - Nitinat CO",
                                             full.names = T),
                             skip=1) %>%
  janitor::clean_names()



# ============================= ENVIRO ============================
nitinat.water <- 
  lapply(list.files(path = here::here("data", "enviro"),
                    pattern = "NitinatWaterLevelHydrometData_20*",
                    full.names = TRUE),
         read.csv, skip=1) %>%
  do.call("rbind",.) %>%
  separate(Received, sep=" ", c("date", "time", "stamp")) %>%
  mutate(date2 = case_when(is.na(TL.Battery.V) ~ lubridate::mdy(date),
                          !is.na(TL.Battery.V) ~ lubridate::dmy(date)),
        year = lubridate::year(date2),
        month = lubridate::month(date2, label=T, abbr=T),
        DOY = lubridate::yday(date2),
        Water.Level.m = case_when(grepl("\\*", Water.Level.m) ~ NA,
                                  TRUE ~ as.numeric(Water.Level.m)),
        label_group = case_when(year<analysis_year ~ "Historical",
                                        year==analysis_year ~ as.character(year)),
        hour = as.numeric(stringr::str_sub(stringr::str_pad(time, width=5, pad = "0"), 1,2)),
        hour = case_when(hour==12 & stamp=="AM" ~ 0,
                         TRUE ~ hour)) %>%
  print()


# Export compiled file for sharing: 
writexl::write_xlsx(nitinat.water, paste0(here::here("data", "enviro", "Nitinat River weather station data "),
                                          min(nitinat.water$year), "-", max(nitinat.water$year),
                                          " (", Sys.Date(), ").xlsx"))



# San Juan water data for comparison---
SJ.water <- full_join(
  read.csv(file=list.files(path = here::here("data", "enviro"),
                           pattern = "SANJUAN_historical*",
                           full.names = TRUE),
           skip=1) %>%
    mutate(PARAM = case_when(PARAM==1 ~ "discharge (cms)",
                             PARAM==2 ~ "level (m)"),
           Date = lubridate::ymd(Date),
           year = lubridate::year(Date),
           month = lubridate::month(Date, label=T, abbr=T),
           DOY = lubridate::yday(Date)),
  
    read.csv(file=list.files(path = here::here("data", "enviro"),
                           pattern = "SANJUAN_realtime*",
                           full.names = TRUE),
           skip=9) %>%
    mutate(Parameter = case_when(Parameter==46 ~ "level (m)"),
           Date = lubridate::ymd(stringr::str_sub(string=Date..PST., start=1, end=10)),
           time = stringr::str_sub(string=Date..PST., start=12, end=19),
           year = lubridate::year(Date..PST.),
           month = lubridate::month(Date..PST., label=T, abbr=T),
           DOY = lubridate::yday(Date..PST.)) %>% 
    rename(PARAM=Parameter,
           Value=Value..m.)
)




# ============================= HISTORICAL DATA ============================

# Run timing ----------------------------
nit.rtStWk <- readxl::read_excel(path=#paste0(here::here("data", "escapement"), sep="/", 
                                      #       list.files(path=here::here("data", "escapement"),
                                      #                  pattern="run timing tables (updated)*")), 
                                   "//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/ESCAPEMENT/Data/run timing tables (updated).xlsx",
                                 sheet="Nitinat", guess_max=10000, trim_ws=T, 
                                 range=cellranger::cell_limits(c(4, 1), c(NA, NA))) %>% 
  select(-c(`...24`:`...75`)) %>%
  rename(year=`...1`) %>% 
  filter(if_any(everything(), ~ !is.na(.)), !grepl("Table", year), !grepl("Year", year), !is.na(year)) %>% 
  mutate(species = c(rep("chinook", nrow(.)/3), rep("coho", nrow(.)/3), rep("chum", nrow(.)/3)),
         `9-2` = case_when(`9-2`=="1000-2000" ~ as.numeric(1500),
                          TRUE ~ as.numeric(`9-2`)),
         across(c(`8-1`:`12-4`), ~as.numeric(.)),
         plot_group = case_when(year==analysis_year ~ year,
                                year!=analysis_year ~ paste0(min(year), 
                                                               sep="-", (analysis_year-1)))) %>%
  pivot_longer(cols = c(`8-1`:`12-4`), names_to = "stat_week", values_to = "count") %>% 
  print()

nit.rtStWk$stat_week <- factor(nit.rtStWk$stat_week,
                               levels=c("8-1","8-2","8-3","8-4",
                                        "9-1","9-2","9-3","9-4",
                                        "10-1","10-2","10-3","10-4","10-5",
                                        "11-1","11-2","11-3","11-4","11-5",
                                        "12-1","12-2","12-3","12-4", ordered=T)) 


# TIME SERIES ----------------------------
# Option 1. Run outside of RMarkdown if need to refresh escapement each year: 
  #source(here::here("scripts", "functions", "pullNusedsData.R")) 
  # saves as a2122_nuseds_escapement

# Option 2. Source() above exports the file, read in the escapement data dump from the repo
a2122_nuseds_escapement <- readxl::read_excel(path=list.files(path=here::here("outputs"),
                                                              pattern="R_OUT - Area21-22_Escapement_allSpp-allYrs",
                                                              full.names=T),
                                              sheet=1)


# New Escapement Index
NEI <- readxl::read_excel(path="//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/ESCAPEMENT/Data/NEW ESCAPEMENT INDEX.xls", sheet = "EscData", skip=4) %>% 
  filter(System=="Nitinat")



# ESCAPEMENT GOALS ----------------------------
nit.esc.goal <- read.csv(here::here("data", "escapement", "wcviCK-BootstrappedRPs.csv")) %>% 
  filter(Stock=="Nitinat")
```

<br>

<br>


# **Infilling/specialty expansion of specific surveys**

*This section is reserved for deeper dives into specific surveys or days where specialty expansions might be required (e.g., important sections missed, partial surveys around peak of spawn, etc.). This section could be blank in years where no detailed exploration/analysis is needed to determine a survey's expansion!*

- Oct 8: 3 bears fishing at 2-1, did not swim area to avoid them and missed some fish. 
- Oct 16: 5 bears fishing around marker 1 (just u/s; in 2-1), did not swim had to avoid, missed fish. 





















# **Sockeye**            

<br>

Snorkel and heli surveys were primarily timed for Chinook and Chum. Sockeye counts are incidental and should be considered low-quality/incomplete. 

<br>

## Area 21-22 raw vs expanded counts

Counts are expanded for both % population surveyed and/or observer efficiency, depending on survey conditions.  

```{r}
ggplot() +
  geom_bar(data=escEstAUCsource %>% 
             filter(ShortSpecies=="SK") %>% 
             pivot_longer(c(LiveAdults:TotalJacks,ExpLiveAdults:ExpTotalJacks), names_to="est_type", values_to="n") %>% 
             filter(est_type %in% c("LiveAdults", "ExpLiveAdults")), 
           aes(x=as.Date(SDate), y=n, colour=est_type, fill=est_type), stat="identity", position=position_dodge(width=5),
           alpha=0.5, width=5) +
  labs(x="", y="Adult Sockeye counts") +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1),
        legend.position = "bottom",
        legend.title = element_blank()) +
  facet_wrap(~SystemName, scales="free")
```

Figure: Observed live Adult sockeye (blue) and the same counts expanded for % population and/or OE (pink). 

<br>

<br>

## Counts & environmentals


```{r}
#pdf(file = here::here("outputs", "figures", paste0(analysis_year, " SK count-enviro.pdf")),   
#    width = 11, # The width of the plot in inches
#    height = 8.5) # The height of the plot in inches

ggplot() +
  # Plot water data -------------
geom_ribbon(data=nitinat.water %>% 
              filter(year==analysis_year, month%in%c("Aug", "Sep", "Oct", "Nov")) %>%
              group_by(date2) %>% 
              summarize(min=min(Water.Level.m), max=max(Water.Level.m)), 
            aes(x=as.Date(date2), ymin=min*200, ymax=max*200), fill="dodger blue", alpha=0.5) +
  geom_line(data=nitinat.water %>% 
              filter(year==analysis_year, month%in%c("Aug", "Sep", "Oct", "Nov")) %>%
              group_by(date2) %>% 
              summarize(mean = mean(Water.Level.m)), 
            aes(x=as.Date(date2), y=mean*200), colour="dodger blue") +
  geom_bar(data=nitinat.SIL %>% 
             filter(SBJ_ID=="Sockeye", NAME=="NITINAT RIVER") %>% 
             group_by(START_DTT, survey_type, segment_category) %>% 
             summarize(n=sum(SGA_LIVE_ADULTS_OBSERVED, na.rm=T)), 
           aes(x=as.Date(START_DTT), y=n, group=survey_type, fill=segment_category, colour=segment_category), 
           stat="identity", position="stack", alpha=0.7, width=5) +
  labs(x="", y="Observed adult Sockeye") +
  scale_y_continuous(sec.axis = sec_axis(~./200, name="Water level (m)")) +
  scale_x_date(date_breaks="7 day", date_labels="%b %d") +
  labs(x="", Y="Live chinook", fill="Segment", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1, size=10),
        axis.text = element_text(size=10),
        axis.title = element_text(face="bold", size=12),
        legend.text = element_text(size=10),
        legend.title = element_text(size=15))

#dev.off()
```

Figure: Sockeye counts (raw live adults), water levels (blue line)

<br>

<br>

## Behaviour & carcasses

```{r}
ggplot() +
    # ---- DEAD -----
  geom_point(data=nitinat.SIL %>%
               filter(NAME=="NITINAT RIVER" & SBJ_ID =="Sockeye") %>%
               group_by(date, SBJ_ID) %>%
               summarize(total_adults_ded=sum(SGA_DEAD_ADULTS_OBSERVED, na.rm=T)) %>% 
               filter(total_adults_ded>0),
             aes(x=date, y=total_adults_ded), colour="black") +
  # # ---- DEAD -----  
  geom_line(data=nitinat.SIL %>%
               filter(NAME=="NITINAT RIVER" & SBJ_ID =="Sockeye") %>%
               group_by(date, SBJ_ID) %>%
               summarize(total_adults_ded=sum(SGA_DEAD_ADULTS_OBSERVED, na.rm=T)) %>% 
               filter(total_adults_ded>0),
            aes(x=date, y=total_adults_ded), colour="black") +
  # ---- LIVE ----
  geom_bar(data=nitinat.SIL %>% 
             filter(NAME=="NITINAT RIVER" & SBJ_ID =="Sockeye") %>%
             group_by(date, SBJ_ID, segment_category, survey_type) %>% 
             summarize(adults_spawning = sum(SGA_LIVE_ADULTS_SPAWNING, na.rm=T),
                       adults_holding = sum(SGA_LIVE_ADULTS_HOLDING, na.rm=T)) %>%
             pivot_longer(cols=c(adults_spawning, adults_holding), names_to = "behaviour", values_to = "count"), 
           aes(x=date, y=count, colour=segment_category, fill=behaviour), stat="identity", 
           position = "stack", alpha=0.8, width=7, linewidth = 1) +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d")+
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="Observed adult Sockeye", fill="Behaviour", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```
<br>

Figure: Top: Expanded live Sockeye (bars) and carcasses (black line) in the Nitinat mainstem. Bottom: Spawning (gray bars) and holding (white bars) adult Sockeye and carcasses (black line). 

<br>

```{r}
ggplot() +
  geom_hline(aes(yintercept="18-17")) +
  geom_hline(aes(yintercept="13-12"), linetype = "dashed") +
  geom_tile(data = nitinat.SIL %>% 
              filter(SBJ_ID=="Sockeye", NAME=="NITINAT RIVER") %>%
              group_by(START_DTT, SEGMENT_NAME) %>% 
              summarize(total = sum(SGA_LIVE_ADULTS_OBSERVED, na.rm=T),
                        perc_spawn = sum(SGA_LIVE_ADULTS_SPAWNING, na.rm=T) / total),
            aes(x=as.Date(START_DTT), y=SEGMENT_NAME, fill=perc_spawn)) +
  scale_x_date(date_labels = "%b %d") +
  scale_y_discrete(limits=rev) +
  scale_fill_viridis_c(na.value = "gray90") +
  labs(y="River segment", fill="Percent spawning") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1),
        axis.title.x = element_blank(),
        axis.title = element_text(face="bold"),
        legend.title = element_text(face="bold"))
```

Figure:  Sockeye spawning behaviour by reach break over each survey (snorkel and heli, if done). Solid black line denotes the differentiation between upper and lower Nitinat; dashed black line indicates where the hatchery is located along the river. Note heli and snorkel reach breaks are not the same. If any reach break is blank, it implies the surveyors missed the marker, and both reach counts were included in the one before. Counts with no Sockeye and/or no spawning Sockeye are indicated as gray (division by zero). 

<br>

<br>

## Snorkel & swim-in counts

There are no swim-ins for Nitinat sockeye as they are not enhanced. 

<br>

<br>

## Tributaries (River and Lake)

Sockeye were present in Hobiton and Campus Creeks in 2023, but the primary enumeration method is by NTC and DFN echosounder. 
Hobiton was swum once late May due to delays in the echosounder installation, and again in late August during drought conditions to assess whether pre-spawn mortalities were occurring in the creek. Only one pre-spawn jack was noted, the remaining dead were too deep or too decomposed to assess mortality. 

```{r}
nitinat.SIL %>% 
  filter(SBJ_ID=="Sockeye", NAME !="NITINAT RIVER") %>% 
  group_by(date, NAME) %>% 
  summarize(ad_live = sum(SGA_LIVE_ADULTS_OBSERVED, na.rm=T),
            exp_ad_livve = sum(SGA_LIVE_ADULTS_ESTIMATED, na.rm=T),
            dead_adults = sum(SGA_DEAD_ADULTS_OBSERVED, na.rm=T),
            jk_live = sum(SGA_LIVE_JACKS_ESTIMATED, na.rm=T),
            jk_dead = sum(SGA_DEAD_JACKS_ESTIMATED, na.rm=T)) %>%
  mutate(across(c(ad_live:jk_dead), ~round(., 0))) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1), valign="middle", target=1) 
```

<br>

```{r}
ggplot() +
  geom_bar(data=nitinat.SIL %>% 
             filter(SBJ_ID=="Sockeye", grepl("NITINAT|PARKER|WORTHLESS|JASPER|NONAME", NAME, ignore.case=T)) %>% 
             # mutate(trib_status = case_when(grepl("LITTLE NITINAT|PARKER|WORTHLESS|JASPER|NONAME", NAME, 
             #                                      ignore.case=T) ~ "Tributary",
             #                                TRUE ~ "Mainstem")) %>%
             group_by(NAME, START_DTT) %>% 
             summarize(Spawning=sum(SGA_LIVE_ADULTS_SPAWNING, na.rm=T),
                       Holding = sum(SGA_LIVE_ADULTS_HOLDING, na.rm=T)) %>% 
             pivot_longer(cols=c(Spawning, Holding), names_to="behaviour", values_to="count"), 
           aes(x=as.Date(START_DTT), y=count, fill=behaviour, colour=NAME), 
           stat="identity", position=position_dodge(width=4), alpha=0.7, size=1, width=4, linewidth = 1) +
  # geom_bar(data = tribs.sil %>% 
  #            filter(species=="Chinook") %>% 
  #            group_by(system, date) %>% 
  #            summarize(Spawning=sum(`adults # spawning`),
  #                      Holding = sum(`adults # holding`)) %>% 
  #            pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"),
  #          aes(x=as.Date(date), y=count*1, colour=system, fill=behaviour), stat="identity",  alpha=0.8, size=1, width=1) +
  scale_y_continuous(sec.axis = sec_axis(~./1, name="Trib count")) +
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="mainstem count") +
  theme_bw()
```

Figure: Mainstem Nitinat (pink) and trib (blue) counts for Sockeye adults (raw).  

<br>

<br>

## AUC assessments

<br>

The information below is meant to assist with determining if AUC is an appropriate method, and whether to include/exclude certain surveys. 
**Note that removals of surveys that are deemed irrelevant for a species/year has already been in the database prior to exporting the AUCresults file. This script does not really help with that unless you "restore to default" AUC data in the database and do some extra plotting yourself** 

<br>

Table: AUC math for systems receiving AUC estimate in `r analysis_year`

```{r}
escEstAUC %>%
  filter(AREA!="20", ShortSpecies=="SK", grepl("Nitinat", SystemName)) 
```

<br>

```{r}
ggplot() +
  geom_line(data=escEstAUC %>% 
              mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
              filter(ShortSpecies=="SK", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)), 
            aes(x=as.Date(DateRange), y=ExpAdultFishDays)) +
  geom_point(data=escEstAUC %>% 
               mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
               filter(ShortSpecies=="SK", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)), 
             aes(x=as.Date(DateRange), y=ExpAdultFishDays, fill=method, colour=method), shape=21, size=4) +
  scale_fill_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
  scale_colour_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
  scale_x_date(date_breaks="5 day", date_labels="%b %d") +
  labs(x="", y="Fish-days", fill="Survey method", colour="Survey method") +
  theme_bw()
```

Figure: AUC curve for Nitinat mainstem Sockeye. Note in 2024 this had already excluded the heli survey, but in future would likely also include the flight for reference. 

<br>

<br>

## Area 21-22 preliminary escapement estimates  

<br>

Table: Escapement estimates for each system. 

```{r}
escEstSpp %>% 
  filter(ShortSpecies=="SK", AREA!="20") %>% 
  select(-c(WatershedCode, contains("Recommend"), EstimateConfidence, OptimumEscapement, #n, 
            contains("Raw"), contains("FishDays"))) %>% 
  relocate(c(SystemName, AREA), .before=ShortSpecies) %>% 
  rename(FinalAdultEstimate = AdultNaturalReco,
         FinalJackEstimate = JackNaturalReco) %>% 
  mutate(across(FinalJackEstimate:FinalAdultEstimate, ~case_when(.<0 ~ 0,
                                                                 TRUE ~ .))) %>%
  select(-c(Notes)) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1:4), valign="middle", target=1) 
```

<br>

<br>

### Estimate decision:

 

<br>

<br>

## `r analysis_year` compared to historical run timing and abundance

Run timing information is not available for Nitinat Sockeye.

<br>

```{r}
ggplot()  +
  geom_bar(data=a2122_nuseds_escapement %>% 
             filter(waterbody_name=="NITINAT RIVER", `Species Qualified`=="SEL", 
                    est_type%in%c("Unspecified Return", "Natural Adult Spawners")) %>%
             group_by(year, est_type) %>%
             summarize(count = sum(estimate, na.rm=T)), 
           aes(x=year, y=count, colour=est_type, fill=est_type), stat="identity", alpha=0.8) +
  # geom_bar(data=escEstSpp %>% 
  #            filter(ShortSpecies=="SK", AREA!="20", grepl("Nitinat", SystemName)) %>% 
  #            select(Year, SystemName, AdultNaturalReco) %>% 
  #            summarize(n=sum(AdultNaturalReco)), 
  #          aes(x=analysis_year, y=n), stat="identity", colour="red", fill="dodger blue", alpha=0.4) +   
  scale_fill_manual(values=c("Unspecified Return" = "gray80",
                             "Natural Adult Spawners" = "dodger blue")) +
  scale_colour_manual(values=c("Unspecified Return" = "gray80",
                               "Natural Adult Spawners" = "dodger blue")) +
  scale_x_continuous(breaks=seq(min(a2122_nuseds_escapement$year), analysis_year, by=2)) +
  labs(x="Return Year", y="Sockeye spawners", fill="Estimate type", colour="Estimate type") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: `r analysis_year` preliminary adult Sockeye escapement estimate (red outline) relative to historical adult (blue) and unspecified (gray) escapement estimates. Gaps indicate years without estimates. 

<br>

<br>


























# **Coho**            

<br>

Six snorkel surveys were conducted in 2023, but only the latter ones can be considered representative for Coho (they were only seen on 4 of the 6 surveys).  

<br>

## Area 21-22 raw vs expanded counts

Counts are expanded for both % population surveyed and/or observer efficiency, depending on survey conditions.  

```{r}
ggplot() +
  geom_bar(data=escEstAUCsource %>% 
             filter(ShortSpecies=="CO") %>% 
             pivot_longer(c(LiveAdults:TotalJacks,ExpLiveAdults:ExpTotalJacks), names_to="est_type", values_to="n") %>% 
             filter(est_type %in% c("LiveAdults", "ExpLiveAdults")), 
           aes(x=as.Date(SDate), y=n, colour=est_type, fill=est_type), stat="identity", position=position_dodge(width=5),
           alpha=0.5, width=5) +
  labs(x="", y="Adult Coho counts") +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1),
        legend.position = "bottom",
        legend.title = element_blank()) +
  facet_wrap(~SystemName, scales="free")
```
s
Figure: Observed Adult Coho (blue) and the same counts expanded for % population and/or OE (pink). 

<br>

## Counts & environmentals

```{r}
pdf(file = here::here("outputs", "figures", paste0(analysis_year, " CO count-enviro.pdf")),   
    width = 11, # The width of the plot in inches
    height = 8.5) # The height of the plot in inches

ggplot() +
  # Plot water data -------------
geom_ribbon(data=nitinat.water %>% 
              filter(year==analysis_year, month%in%c("Aug", "Sep", "Oct", "Nov")) %>%
              group_by(date2) %>% 
              summarize(min=min(Water.Level.m), max=max(Water.Level.m)), 
            aes(x=as.Date(date2), ymin=min*1000, ymax=max*1000), fill="dodger blue", alpha=0.5) +
  geom_line(data=nitinat.water %>% 
              filter(year==analysis_year, month%in%c("Aug", "Sep", "Oct", "Nov")) %>%
              group_by(date2) %>% 
              summarize(mean = mean(Water.Level.m)), 
            aes(x=as.Date(date2), y=mean*1000), colour="dodger blue") +
  geom_bar(data=nitinat.SIL %>% 
             filter(SBJ_ID=="Coho", NAME=="NITINAT RIVER") %>% 
             group_by(START_DTT, survey_type, segment_category) %>% 
             summarize(n=sum(SGA_LIVE_ADULTS_OBSERVED, na.rm=T)), 
           aes(x=as.Date(START_DTT), y=n, group=survey_type, fill=segment_category, colour=segment_category), 
           stat="identity", position="stack", alpha=0.7, width=5) +
  labs(x="", y="Observed adult Coho") +
  scale_y_continuous(sec.axis = sec_axis(~./1000, name="Water level (m)")) +
  scale_x_date(date_breaks="7 day", date_labels="%b %d") +
  labs(x="", Y="Live chinook", fill="Segment", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1, size=10),
        axis.text = element_text(size=10),
        axis.title = element_text(face="bold", size=12),
        legend.text = element_text(size=10),
        legend.title = element_text(size=15))

dev.off()
```

Figure: Coho counts (raw live adults) and water levels (blue line) 

<br>

<br>

## Behaviour & carcasses

```{r}
ggplot() +
    # ---- DEAD -----
  geom_point(data=nitinat.SIL %>%
               filter(NAME=="NITINAT RIVER" & SBJ_ID =="Coho") %>%
               group_by(date, SBJ_ID) %>%
               summarize(total_adults_ded=sum(SGA_DEAD_ADULTS_OBSERVED, na.rm=T)) %>% 
               filter(total_adults_ded>0),
             aes(x=date, y=total_adults_ded), colour="black") +
  # # ---- DEAD -----  
  geom_line(data=nitinat.SIL %>%
               filter(NAME=="NITINAT RIVER" & SBJ_ID =="Coho") %>%
               group_by(date, SBJ_ID) %>%
               summarize(total_adults_ded=sum(SGA_DEAD_ADULTS_OBSERVED, na.rm=T)) %>% 
               filter(total_adults_ded>0),
            aes(x=date, y=total_adults_ded), colour="black") +
  # ---- LIVE ----
  geom_bar(data=nitinat.SIL %>% 
             filter(NAME=="NITINAT RIVER" & SBJ_ID =="Coho") %>%
             group_by(date, SBJ_ID, segment_category, survey_type) %>% 
             summarize(adults_spawning = sum(SGA_LIVE_ADULTS_SPAWNING, na.rm=T),
                       adults_holding = sum(SGA_LIVE_ADULTS_HOLDING, na.rm=T)) %>%
             pivot_longer(cols=c(adults_spawning, adults_holding), names_to = "behaviour", values_to = "count"), 
           aes(x=date, y=count, colour=segment_category, fill=behaviour), stat="identity", 
           position = "stack", alpha=0.8, width=7, linewidth = 1) +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d")+
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="Observed adult Coho", fill="Behaviour", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```
<br>

Figure: Expanded live adult Coho (bars) and carcasses (black line). Bar fill indicates behaviour (spawning=gray, holding=white), bar outline indicates river segment (upper=blue, lower=pink).

<br>

```{r}
ggplot() +
  geom_hline(aes(yintercept="18-17")) +
  geom_hline(aes(yintercept="13-12"), linetype = "dashed") +
  geom_tile(data = nitinat.SIL %>% 
              filter(SBJ_ID=="Coho", NAME=="NITINAT RIVER") %>%
              group_by(START_DTT, SEGMENT_NAME) %>% 
              summarize(total = sum(SGA_LIVE_ADULTS_OBSERVED, na.rm=T),
                        perc_spawn = sum(SGA_LIVE_ADULTS_SPAWNING, na.rm=T) / total),
            aes(x=as.Date(START_DTT), y=SEGMENT_NAME, fill=perc_spawn)) +
  scale_x_date(date_labels = "%b %d") +
  scale_y_discrete(limits=rev) +
  scale_fill_viridis_c(na.value = "gray90") +
  labs(y="River segment", fill="Percent spawning") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1),
        axis.title.x = element_blank(),
        axis.title = element_text(face="bold"),
        legend.title = element_text(face="bold"))
```

Figure:  Coho spawning behaviour by reach break over each survey (snorkel and heli, if done). Solid black line denotes the differentiation between upper and lower Nitinat; dashed black line indicates where the hatchery is located along the river. Note heli and snorkel reach breaks are not the same. If any reach break is blank, it implies the surveyors missed the marker, and both reach counts were included in the one before. Counts with no Coho and/or no spawning Coho are indicated as gray (division by zero). 

<br>

<br>

## Snorkel, angling & swim-in counts

```{r}
ggplot() +
  geom_bar(data=nitinat.SIL %>% 
             filter(SBJ_ID=="Coho", NAME=="NITINAT RIVER") %>% 
             group_by(START_DTT, survey_type, segment_category) %>% 
             summarize(Spawning = sum(SGA_LIVE_ADULTS_SPAWNING, na.rm=T),
                       Holding = sum(SGA_LIVE_ADULTS_HOLDING, na.rm=T)) %>% 
             pivot_longer(cols=c(Spawning, Holding), names_to="behaviour", values_to="count"),
             # mutate(date = case_when(type=="Heli Flight" ~ as.Date("2025-10-21"),
             #                         TRUE ~ date)), 
           aes(x=as.Date(START_DTT), y=count, fill=behaviour, colour=segment_category), 
           stat="identity", position="stack", alpha=0.7, size=1, width=1) +
  geom_bar(data=nrh.co %>% 
             filter(parent_activity_type=="Adult Capture", grepl("Swim Ins", inventory_lot)) %>% 
             group_by(activity_start_date) %>% 
             summarize(n=sum(total_count,na.rm=T)),
           aes(x=as.Date(activity_start_date), y=n*1), fill="black", stat="identity", alpha=0.5, width=1) +

  ## ******* NEED ANGLING DATES FROM CAROLINE??? 
  
  # geom_bar(data=nrh.co %>%
  #            filter(OperationsLocation!="Nitinat Lake", !is.na(OperationsLocation), ActivityType=="Deposit to Holding")%>%
  #            group_by(ActivityStartDate) %>% 
  #            summarize(n=sum(TotalCount)),
  #          aes(x=as.Date(ActivityStartDate), y=n*10), stat="identity", fill="green", alpha=0.7) +
  scale_y_continuous(sec.axis = sec_axis(~./10, name="Swim-Ins/Angling")) +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d") +
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="Adult Coho", fill="Behaviour", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: Expanded adult Coho counts (large bars) and ALL swim-ins (narrow black bars, including jacks). Adult bar fill colours indicate behaviour (spawning=gray, holding=white), bar line colour indicates river segment (lower=pink, upper=blue). 

<br>

## Mark rate in lake

```{r}
ggplot(data=nrh.co %>%
         filter(parent_activity_type=="Adult Capture", grepl("Lake", inventory_lot, ignore.case=T), 
                grepl("Seine", capture_method)) %>% 
         group_by(activity_start_date, external_mark) %>% 
         summarize(n=sum(total_count)) %>% 
         group_by(activity_start_date) %>% 
         mutate(mark_rate = n/sum(n))) +
  geom_bar(aes(x=activity_start_date, y=mark_rate, fill=external_mark, colour=external_mark), 
           stat="identity", size=1, alpha=0.7) +
  theme_bw()
```

Figure: Mark rate of all coho caught in purse seine catches in Nitinat Lake. Excluded gillnet catch as mark rate is typically not examined. 

<br>

```{r}
co_markrateALL <- nrh.co %>%
  filter(parent_activity_type=="Adult Capture", grepl("Lake", inventory_lot, ignore.case=T), 
         grepl("Seine", capture_method)) %>% 
  group_by(external_mark) %>% 
  summarize(n=sum(total_count)) %>% 
  mutate(mark_rate = n/sum(n)) 

co_markrateADULT <- nrh.co %>%
  filter(parent_activity_type=="Adult Capture", grepl("Lake", inventory_lot, ignore.case=T), 
         grepl("Seine", capture_method)) %>% 
  filter(maturity_class%in%c("Male", "Female")) %>%
  group_by(external_mark) %>% 
  summarize(n=sum(total_count)) %>% 
  mutate(mark_rate = n/sum(n)) 
```


The overall mark rate of **ALL coho** caught in Nitinat Lake purse seine this year was **`r round(co_markrateALL[co_markrateALL$external_mark=="Clipped",]$mark_rate*100, 1)`%**. 

The overall mark rate of **ADULT coho** caught in Nitinat Lake purse seine this year was **`r round(co_markrateADULT[co_markrateADULT$external_mark=="Clipped",]$mark_rate*100, 1)`%**.

<br>

<br>

## Tributaries (River and Lake)

Live Coho were present in Campus, NoName and Worthless Creeks in 2023.

```{r}
nitinat.SIL %>% 
  filter(SBJ_ID=="Coho", NAME !="NITINAT RIVER") %>% 
  group_by(date, NAME) %>% 
  summarize(ad_live = sum(SGA_LIVE_ADULTS_OBSERVED, na.rm=T),
            exp_ad_livve = sum(SGA_LIVE_ADULTS_ESTIMATED, na.rm=T),
            dead_adults = sum(SGA_DEAD_ADULTS_OBSERVED, na.rm=T),
            jk_live = sum(SGA_LIVE_JACKS_ESTIMATED, na.rm=T),
            jk_dead = sum(SGA_DEAD_JACKS_ESTIMATED, na.rm=T)) %>%
  mutate(across(c(ad_live:jk_dead), ~round(., 0))) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1), valign="middle", target=1) 
```

<br>

```{r}
ggplot() +
  geom_bar(data=nitinat.SIL %>% 
             filter(SBJ_ID=="Coho", grepl("NITINAT|PARKER|WORTHLESS|JASPER|NONAME", NAME, ignore.case=T)) %>% 
             # mutate(trib_status = case_when(grepl("LITTLE NITINAT|PARKER|WORTHLESS|JASPER|NONAME", NAME, 
             #                                      ignore.case=T) ~ "Tributary",
             #                                TRUE ~ "Mainstem")) %>%
             group_by(NAME, START_DTT) %>% 
             summarize(Spawning=sum(SGA_LIVE_ADULTS_SPAWNING, na.rm=T),
                       Holding = sum(SGA_LIVE_ADULTS_HOLDING, na.rm=T)) %>% 
             pivot_longer(cols=c(Spawning, Holding), names_to="behaviour", values_to="count"), 
           aes(x=as.Date(START_DTT), y=count, fill=behaviour, colour=NAME), 
           stat="identity", position=position_dodge(width=4), alpha=0.7, size=1, width=4, linewidth = 1) +
  # geom_bar(data = tribs.sil %>% 
  #            filter(species=="Chinook") %>% 
  #            group_by(system, date) %>% 
  #            summarize(Spawning=sum(`adults # spawning`),
  #                      Holding = sum(`adults # holding`)) %>% 
  #            pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"),
  #          aes(x=as.Date(date), y=count*1, colour=system, fill=behaviour), stat="identity",  alpha=0.8, size=1, width=1) +
  scale_y_continuous(sec.axis = sec_axis(~./1, name="Trib count")) +
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="mainstem count") +
  theme_bw()
```

Figure: Mainstem Nitinat (pink) and trib (blue/green) counts for Coho adults (raw).  

<br>

<br>

## AUC assessments

<br>

The information below is meant to assist with determining if AUC is an appropriate method, and whether to include/exclude certain surveys. 

<br>

Table: AUC math for systems receiving AUC estimate in `r analysis_year`

```{r}
escEstAUC %>%
  filter(AREA!="20", ShortSpecies=="CO", grepl("Nitinat River, Nitinat Lake", SystemName)) 
```

<br>

```{r}
ggplot() +
  geom_line(data=escEstAUC %>% 
              mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
              filter(ShortSpecies=="CO", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)), 
            aes(x=as.Date(dateplot), y=ExpAdultFishDays)) +
  geom_point(data=escEstAUC %>% 
               mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
               filter(ShortSpecies=="CO", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)), 
             aes(x=as.Date(dateplot), y=ExpAdultFishDays, fill=method, colour=method), shape=21, size=4) +
  scale_fill_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
  scale_colour_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
  labs(x="", y="Fish-days", fill="Survey method", colour="Survey method") +
  theme_bw()
```

Figure: AUC curve for Nitinat mainstem Coho. Note in 2023 this had already excluded the heli survey, but in future would likely also include the flight for reference. 

<br>

<br>


## Area 21-22 preliminary escapement estimates (AUC/PL+D) 

<br>

```{r}
escEstSpp %>% 
  filter(ShortSpecies=="CO", AREA!="20") %>% 
  select(-c(WatershedCode, contains("Recommend"), EstimateConfidence, OptimumEscapement, #n, 
            contains("Raw"), contains("FishDays"))) %>% 
  relocate(c(SystemName, AREA), .before=ShortSpecies) %>% 
  rename(FinalAdultEstimate = AdultNaturalReco,
         FinalJackEstimate = JackNaturalReco) %>% 
  mutate(across(FinalJackEstimate:FinalAdultEstimate, ~case_when(.<0 ~ 0,
                                                                 TRUE ~ .))) %>%
  select(-c(Notes)) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1:4), valign="middle", target=1) 
```

<br>

### Estimate decision:





<br>

<br>

## `r analysis_year` compared to historical run timing and abundance

```{r}
ggplot() +
  geom_point(data=nit.rtStWk%>%filter(species=="coho"),
             aes(x=stat_week, y=count, colour=plot_group, fill=plot_group, size=plot_group),
             shape=21, alpha=0.7) +
  scale_fill_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_colour_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_size_manual(breaks=waiver(), values=c(1.5,3.5)) +
  labs(x="Stat week", y="Live adult Coho", fill="Year:", colour="Year:", size="Year:") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.box = "horizontal")
```

Figure: Raw swim counts (blue) from this year compared to historical raw swim counts. Stat weeks indicate the month (8=August, 12=December) and week of momth (1=first week, 2=2nd week, etc.), e.g., 81=First week of August, 91=First week of September, etc. 

<br>

```{r}
ggplot()  +
  geom_bar(data=a2122_nuseds_escapement %>% 
             filter(waterbody_name=="NITINAT RIVER", `Species Qualified`=="CO", 
                    est_type%in%c("Unspecified Return", "Natural Adult Spawners")) %>%
             group_by(year, est_type) %>%
             summarize(count = sum(estimate, na.rm=T)), 
           aes(x=year, y=count, colour=est_type, fill=est_type), stat="identity", alpha=0.8) +
  # geom_bar(data=escEstSpp %>% 
  #            filter(ShortSpecies=="CO", AREA!="20", grepl("Nitinat", SystemName)) %>% 
  #            select(Year, SystemName, AdultNaturalReco) %>% 
  #            summarize(n=sum(AdultNaturalReco)), 
  #          aes(x=analysis_year, y=n), stat="identity", colour="red", fill="dodger blue", alpha=0.4) +   
  scale_fill_manual(values=c("Unspecified Return" = "gray80",
                             "Natural Adult Spawners" = "dodger blue")) +
  scale_colour_manual(values=c("Unspecified Return" = "gray80",
                               "Natural Adult Spawners" = "dodger blue")) +
  scale_x_continuous(breaks=seq(min(a2122_nuseds_escapement$year), analysis_year, by=2)) +
  labs(x="Return Year", y="Coho spawners", fill="Estimate type", colour="Estimate type") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: `r analysis_year` preliminary adult Coho escapement estimate (red outline) relative to historical adult (blue) and unspecified (gray) escapement estimates. Gaps indicate years without estimates. 

<br>

<br>























# **Chum** 

<br>

Six snorkel surveys and one helicopter survey were conducted for Chum in 2023. The heli survey may have been slightly early for Chum. 

<br>

## Area 21-22 raw vs expanded counts

Counts are expanded for both % population surveyed and/or observer efficiency, depending on survey conditions.  

```{r}
ggplot() +
  geom_bar(data=escEstAUCsource %>% 
             filter(ShortSpecies=="CM") %>% 
             pivot_longer(c(LiveAdults:TotalJacks,ExpLiveAdults:ExpTotalJacks), names_to="est_type", values_to="n") %>% 
             filter(est_type %in% c("LiveAdults", "ExpLiveAdults")), 
           aes(x=as.Date(SDate), y=n, colour=est_type, fill=est_type), stat="identity", position=position_dodge(width=5),
           alpha=0.5, width=5) +
  labs(x="", y="Adult Chum counts") +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1),
        legend.position = "bottom",
        legend.title = element_blank()) +
  facet_wrap(~SystemName, scales="free")
```

Figure: Observed Adult Chum (blue) and the same counts expanded for % population and/or OE (pink).

<br>

## Counts & environmentals

```{r}
# pdf(file = here::here("outputs", "figures", paste0(analysis_year, " CM count-enviro.pdf")),   
#     width = 11, # The width of the plot in inches
#     height = 8.5) # The height of the plot in inches

ggplot() +
  # Plot water data -------------
geom_ribbon(data=nitinat.water %>% 
              filter(year==analysis_year, month%in%c("Aug", "Sep", "Oct", "Nov")) %>%
              group_by(date2) %>% 
              summarize(min=min(Water.Level.m), max=max(Water.Level.m)), 
            aes(x=as.Date(date2), ymin=min*5000, ymax=max*5000), fill="dodger blue", alpha=0.5) +
  geom_line(data=nitinat.water %>% 
              filter(year==analysis_year, month%in%c("Aug", "Sep", "Oct", "Nov")) %>%
              group_by(date2) %>% 
              summarize(mean = mean(Water.Level.m)), 
            aes(x=as.Date(date2), y=mean*5000), colour="dodger blue") +
  geom_bar(data=nitinat.SIL %>% 
             filter(SBJ_ID=="Chum", NAME=="NITINAT RIVER") %>% 
             group_by(START_DTT, survey_type, segment_category) %>% 
             summarize(n=sum(SGA_LIVE_ADULTS_OBSERVED, na.rm=T)), 
           aes(x=as.Date(START_DTT), y=n, group=survey_type, fill=segment_category, 
               linetype = survey_type),  colour="black", stat="identity", position="stack", alpha=0.7, width=5) +
  labs(x="", y="Observed adult Chum") +
  scale_y_continuous(sec.axis = sec_axis(~./5000, name="Water level (m)")) +
  scale_x_date(date_breaks="7 day", date_labels="%b %d") +
  scale_linetype_manual(values=c("Heli" = "solid", "Snorkel" = "dashed")) +
  labs(x="", Y="Live chinook", fill="Segment", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1, size=10),
        axis.text = element_text(size=10),
        axis.title = element_text(face="bold", size=12),
        legend.text = element_text(size=10),
        legend.title = element_text(size=15))

# dev.off()
```

Figure: Chum counts (raw live adults), water levels (blue line)

<br>

<br>

## Behaviour & carcasses

```{r}
ggplot() +
    # ---- DEAD -----
  geom_point(data=nitinat.SIL %>%
               filter(NAME=="NITINAT RIVER" & SBJ_ID =="Chum") %>%
               group_by(date, SBJ_ID) %>%
               summarize(total_adults_ded=sum(SGA_DEAD_ADULTS_OBSERVED, na.rm=T)) %>% 
               filter(total_adults_ded>0),
             aes(x=date, y=total_adults_ded), colour="black") +
  # # ---- DEAD -----  
  geom_line(data=nitinat.SIL %>%
               filter(NAME=="NITINAT RIVER" & SBJ_ID =="Chum") %>%
               group_by(date, SBJ_ID) %>%
               summarize(total_adults_ded=sum(SGA_DEAD_ADULTS_OBSERVED, na.rm=T)) %>% 
               filter(total_adults_ded>0),
            aes(x=date, y=total_adults_ded), colour="black") +
  # ---- LIVE ----
  geom_bar(data=nitinat.SIL %>% 
             filter(NAME=="NITINAT RIVER" & SBJ_ID =="Chum") %>%
             group_by(date, SBJ_ID, segment_category, survey_type) %>% 
             summarize(adults_spawning = sum(SGA_LIVE_ADULTS_SPAWNING, na.rm=T),
                       adults_holding = sum(SGA_LIVE_ADULTS_HOLDING, na.rm=T)) %>%
             pivot_longer(cols=c(adults_spawning, adults_holding), names_to = "behaviour", values_to = "count"), 
           aes(x=date, y=count, colour=segment_category, fill=behaviour), stat="identity", 
           position = "stack", alpha=0.8, width=2, linewidth = 1) +
  scale_x_date(date_breaks="3 day", date_labels = "%b %d")+
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="Observed adult Chum", fill="Behaviour", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```
<br>

Figure: Expanded live adult Chum (bars) and carcasses (black line). Bar fill indicates behaviour (spawning=gray, holding=white), bar outline indicates river segment (upper=blue, lower=pink)

<br>

```{r}
ggplot() +
  geom_hline(aes(yintercept="18-17")) +
  geom_hline(aes(yintercept="13-12"), linetype = "dashed") +
  geom_tile(data = nitinat.SIL %>% 
              filter(SBJ_ID=="Chum", NAME=="NITINAT RIVER") %>%
              group_by(START_DTT, SEGMENT_NAME) %>% 
              summarize(total = sum(SGA_LIVE_ADULTS_OBSERVED, na.rm=T),
                        perc_spawn = sum(SGA_LIVE_ADULTS_SPAWNING, na.rm=T) / total),
            aes(x=as.Date(START_DTT), y=SEGMENT_NAME, fill=perc_spawn)) +
  scale_x_date(date_labels = "%b %d") +
  scale_y_discrete(limits=rev) +
  scale_fill_viridis_c(na.value = "gray90") +
  labs(y="River segment", fill="Percent spawning") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1),
        axis.title.x = element_blank(),
        axis.title = element_text(face="bold"),
        legend.title = element_text(face="bold"))
```

Figure:  Chum spawning behaviour by reach break over each survey (snorkel and heli, if done). Solid black line denotes the differentiation between upper and lower Nitinat; dashed black line indicates where the hatchery is located along the river. Note heli and snorkel reach breaks are not the same. If any reach break is blank, it implies the surveyors missed the marker, and both reach counts were included in the one before. Counts with no Chum and/or no spawning Chum are indicated as gray (division by zero). 

<br>

<br>

## Snorkel & swim-in counts

```{r}
ggplot() +
  geom_bar(data=nitinat.SIL %>% 
             filter(SBJ_ID=="Chum", NAME=="NITINAT RIVER") %>% 
             group_by(START_DTT, survey_type, segment_category) %>% 
             summarize(Spawning = sum(SGA_LIVE_ADULTS_SPAWNING, na.rm=T),
                       Holding = sum(SGA_LIVE_ADULTS_HOLDING, na.rm=T)) %>% 
             pivot_longer(cols=c(Spawning, Holding), names_to="behaviour", values_to="count"),
             # mutate(date = case_when(type=="Heli Flight" ~ as.Date("2025-10-21"),
             #                         TRUE ~ date)), 
           aes(x=as.Date(START_DTT), y=count, fill=behaviour, colour=segment_category), 
           stat="identity", position="stack", alpha=0.7, size=1, width=1) +
  geom_bar(data=nrh.cm %>% 
             filter(parent_activity_type=="Adult Capture", grepl("Swim Ins", inventory_lot)) %>% 
             group_by(activity_start_date) %>% 
             summarize(n=sum(total_count,na.rm=T)),
           aes(x=as.Date(activity_start_date), y=n*1), fill="black", stat="identity", alpha=0.5, width=1) +
  scale_y_continuous(sec.axis = sec_axis(~./1, name="Swim ins")) +
  scale_x_date(date_breaks="2 day", date_labels = "%b %d") +
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="Adult Chum", fill="Behaviour", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: Expanded Chum counts (large bars) and swim-ins (narrow black bars). Adult bar fill colours indicate behaviour (spawning=gray, holding=white), bar line colour indicates river segment (lower=pink, upper=blue).

<br>

Total number of swim-ins this year is: `r nrh.cm %>% filter(parent_activity_type=="Adult Capture", grepl("Swim Ins", inventory_lot)) %>% summarize(sum(total_count))` adults. 

<br>

<br>

## Tributaries (River and Lake)

Live chum were present in Campus and Hobiton Creek in 2023, and dead chum were noted in NoName Creek. Opportunistic surveys of Caycuse and Doobah found no chum. 

```{r}
nitinat.SIL %>% 
  filter(SBJ_ID=="Chum", NAME !="NITINAT RIVER") %>% 
  group_by(date, NAME) %>% 
  summarize(ad_live = sum(SGA_LIVE_ADULTS_OBSERVED, na.rm=T),
            exp_ad_livve = sum(SGA_LIVE_ADULTS_ESTIMATED, na.rm=T),
            dead_adults = sum(SGA_DEAD_ADULTS_OBSERVED, na.rm=T),
            jk_live = sum(SGA_LIVE_JACKS_ESTIMATED, na.rm=T),
            jk_dead = sum(SGA_DEAD_JACKS_ESTIMATED, na.rm=T)) %>%
  mutate(across(c(ad_live:jk_dead), ~round(., 0))) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1), valign="middle", target=1) 
```

<br>

```{r}
ggplot() +
  geom_bar(data=nitinat.SIL %>% 
             filter(SBJ_ID=="Chum", grepl("NITINAT|PARKER|WORTHLESS|JASPER|NONAME", NAME, ignore.case=T)) %>% 
             # mutate(trib_status = case_when(grepl("LITTLE NITINAT|PARKER|WORTHLESS|JASPER|NONAME", NAME, 
             #                                      ignore.case=T) ~ "Tributary",
             #                                TRUE ~ "Mainstem")) %>%
             group_by(NAME, START_DTT) %>% 
             summarize(Spawning=sum(SGA_LIVE_ADULTS_SPAWNING, na.rm=T),
                       Holding = sum(SGA_LIVE_ADULTS_HOLDING, na.rm=T)) %>% 
             pivot_longer(cols=c(Spawning, Holding), names_to="behaviour", values_to="count"), 
           aes(x=as.Date(START_DTT), y=count, fill=behaviour, colour=NAME), 
           stat="identity", position=position_dodge(width=4), alpha=0.7, size=1, width=4, linewidth = 1) +
  # geom_bar(data = tribs.sil %>% 
  #            filter(species=="Chinook") %>% 
  #            group_by(system, date) %>% 
  #            summarize(Spawning=sum(`adults # spawning`),
  #                      Holding = sum(`adults # holding`)) %>% 
  #            pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"),
  #          aes(x=as.Date(date), y=count*1, colour=system, fill=behaviour), stat="identity",  alpha=0.8, size=1, width=1) +
  scale_y_continuous(sec.axis = sec_axis(~./1, name="Trib count")) +
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="mainstem count") +
  theme_bw()
```

Figure: Mainstem Nitinat (pink) and trib (blue/green) counts for Chum adults (raw).  

<br>

<br>

## AUC assessments

<br>

The information below is meant to assist with determining if AUC is an appropriate method, and whether to include/exclude certain surveys. 

<br>

Table: AUC math for systems receiving AUC estimate in `r analysis_year`

```{r}
escEstAUC %>%
  filter(AREA!="20", ShortSpecies=="CM", grepl("Nitinat", SystemName)) 
```

<br>

```{r}
ggpubr::ggarrange(
  # THIS PLOT FOR ALL SURVEYS: 
  ggplot() +
    geom_line(data=escEstAUC %>% 
                mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
                filter(ShortSpecies=="CM", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)), 
              aes(x=as.Date(dateplot), y=ExpAdultFishDays)) +
    geom_point(data=escEstAUC %>% 
                 mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
                 filter(ShortSpecies=="CM", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)), 
               aes(x=as.Date(dateplot), y=ExpAdultFishDays, fill=method, colour=method), shape=21, size=4) +
    scale_fill_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
    scale_colour_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
    scale_x_date(date_breaks="5 day", date_labels="%b %d") +
    labs(x="", y="Fish-days", fill="Survey method", colour="Survey method") +
    theme_bw(),
  
  
  # THIS PLOT TO VISUALIZE ANY SURVEYS YOU WANT TO POTENTIALLY OMIT: 
  ggplot() +
    geom_line(data=escEstAUC %>% 
                mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
                filter(ShortSpecies=="CM", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)) %>% 
                filter(dateplot!="2024/10/24"), 
              aes(x=as.Date(dateplot), y=ExpAdultFishDays)) +
    geom_point(data=escEstAUC %>% 
                 mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
                 filter(ShortSpecies=="CM", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)) %>% 
                 filter(dateplot!="2024/10/24"), 
               aes(x=as.Date(dateplot), y=ExpAdultFishDays, fill=method, colour=method), shape=21, size=4) +
    scale_fill_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
    scale_colour_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
    scale_x_date(date_breaks="5 day", date_labels="%b %d") +
    labs(x="", y="Fish-days", fill="Survey method", colour="Survey method") +
    theme_bw(),
  
  nrow=2)
```

Figure: AUC curve for Nitinat mainstem Chum.  

<br>

<br>

## Area 21-22 preliminary escapement estimates (AUC) 

<br>

Table: Escapement estimates for each system.   

```{r}
escEstSpp %>% 
  filter(ShortSpecies=="CM", AREA!="20") %>% 
  select(-c(WatershedCode, contains("Recommend"), EstimateConfidence, OptimumEscapement, #n, 
            contains("Raw"), contains("FishDays"))) %>% 
  relocate(c(SystemName, AREA), .before=ShortSpecies) %>% 
  rename(FinalAdultEstimate = AdultNaturalReco,
         FinalJackEstimate = JackNaturalReco) %>% 
  mutate(across(FinalJackEstimate:FinalAdultEstimate, ~case_when(.<0 ~ 0,
                                                                 TRUE ~ .))) %>%
  select(-c(Notes)) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1:4), valign="middle", target=1) 
```

<br>

### Estimate decision:

Assumed the following for broodstock operations:
- Swim-ins mostly came in after the peak heli count on Oct 21. There were only ~2100 holding Chum counted on that flight, but 8,334 Chum swam into the hatchery. The flight noted that counting was often difficult at edges and in deep, dark pools, so it's possible that fish holding in pools (not spawning) were missed. Therefore **the swim-ins should be in addition to the river escapement estimate**. 

Chum arrival this year was quite late for Nitinat, which also tracks elsewhere on the island: Johnstone Strait test fishery saw a very late, large bump of Chum just days before the fishery was set to close. This is reflected in several of the figures above. Note in the behavioural figures, Chum arrived and were immediately fungus-y and spawning. In particular, there was a massive bump sometime between Oct 16 and 21st; when we flew Oct 21 those fish were already all entirely spawning, which implies a very short residence time. For this reason, we selected the expanded AUC estimate with the shorter survey life (8 days). 

This means the estimate would be `r escEstSpp[escEstSpp$ShortSpecies=="CM",]$AdultExpAUCHighValue` and the swim-ins (`r nrh.cm %>% filter(parent_activity_type=="Adult Capture", maturity_class %in% c("Male", "Female"), grepl("Swim Ins", inventory_lot)) %>% summarize(n=sum(total_count,na.rm=T)) %>% pull(n)`) would be in addition to it (so they don't need to be accounted for here). 

Note this year may be a low estimate due to two lake turnover events: September 17 and October 14. On the Sept 17th event, the hatchery lost ~3000 Chinook broodstock that were being held in the lake pens. There was speculation that fish in the lake may have been able to swim away and avoid the low oxygen conditions, while those stuck in the pens died. However, the extent of the die off from both events is unknown. Hatchery staff reported the lake smelled like rotten eggs on Oct 14 as well (presumably due to anoxic layer coming to surface). The early event would have impacted Chinook more, while the later event would have impacted Chum more (if there were impacts). 

<br>

<br>

## `r analysis_year` compared to historical run timing

```{r}
ggplot() +
  geom_point(data=nit.rtStWk%>%filter(species=="chum"),
             aes(x=stat_week, y=count, colour=plot_group, fill=plot_group, size=plot_group),
             shape=21, alpha=0.7) +
  scale_fill_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_colour_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_size_manual(breaks=waiver(), values=c(1.5,3.5)) +
  labs(x="Stat week", y="Live adult Chum", fill="Year:", colour="Year:", size="Year:") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.box = "horizontal")
```

Figure: Raw swim counts (blue) from this year compared to historical raw swim counts. Stat weeks indicate the month (8=August, 12=December) and week of momth (1=first week, 2=2nd week, etc.), e.g., 81=First week of August, 91=First week of September, etc. 

<br>

```{r}
ggplot()  +
  geom_bar(data=a2122_nuseds_escapement %>% 
             filter(waterbody_name=="NITINAT RIVER", `Species Qualified`=="CM", 
                    est_type%in%c("Unspecified Return", "Natural Adult Spawners")) %>%
             group_by(year, est_type) %>%
             summarize(count = sum(estimate, na.rm=T)), 
           aes(x=year, y=count, colour=est_type, fill=est_type), stat="identity", alpha=0.8) +
  # geom_bar(data=escEstSpp %>% 
  #            filter(ShortSpecies=="CM", AREA!="20", grepl("Nitinat", SystemName)) %>% 
  #            select(Year, SystemName, AdultNaturalReco) %>% 
  #            summarize(n=sum(AdultNaturalReco)), 
  #          aes(x=analysis_year, y=n), stat="identity", colour="red", fill="dodger blue", alpha=0.4) +   
  scale_fill_manual(values=c("Unspecified Return" = "gray80",
                             "Natural Adult Spawners" = "dodger blue")) +
  scale_colour_manual(values=c("Unspecified Return" = "gray80",
                               "Natural Adult Spawners" = "dodger blue")) +
  scale_x_continuous(breaks=seq(min(a2122_nuseds_escapement$year), analysis_year, by=2)) +
  labs(x="Return Year", y="Chum spawners", fill="Estimate type", colour="Estimate type") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: 2024 preliminary adult Chum escapement estimate (red outline) relative to historical adult (blue) and unspecified (gray) escapement estimates. There was no Chum estimate available in 1990. 

<br>

<br>




























# **Chinook**

Six snorkel surveys and one helicopter survey were conducted for Chinook in 2023. 

<br>

## Area 21-22 raw vs expanded counts

Counts are expanded for both % population surveyed and/or observer efficiency, depending on survey conditions.  

```{r}
ggplot() +
  geom_bar(data=escEstAUCsource %>% 
             filter(ShortSpecies=="CN") %>% 
             pivot_longer(c(LiveAdults:TotalJacks,ExpLiveAdults:ExpTotalJacks), names_to="est_type", values_to="n") %>% 
             filter(est_type %in% c("LiveAdults", "ExpLiveAdults")) %>% 
             mutate(n = replace_na(n, 0)), 
           aes(x=as.Date(SDate), y=n, colour=est_type, fill=est_type), stat="identity", position=position_dodge(width=5),
           alpha=0.5, width=5) +
  labs(x="", y="Adult Chinook counts") +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1),
        legend.position = "bottom",
        legend.title = element_blank()) +
  facet_wrap(~SystemName, scales="free")
```

Figure: Observed Adult Chinook (blue) and the same counts expanded for % population and/or OE (pink). 

<br>

## Counts & environmentals

```{r }
#pdf(file = here::here("outputs", "figures", paste0(analysis_year, " CN count-enviro.pdf")),   
#    width = 11, # The width of the plot in inches
#    height = 8.5) # The height of the plot in inches

ggplot() +
  # Plot water data -------------
geom_ribbon(data=nitinat.water %>% 
              filter(year==analysis_year, month%in%c("Aug", "Sep", "Oct", "Nov")) %>%
              group_by(date2) %>% 
              summarize(min=min(Water.Level.m), max=max(Water.Level.m)), 
            aes(x=as.Date(date2), ymin=min*1000, ymax=max*1000), fill="dodger blue", alpha=0.5) +
  geom_line(data=nitinat.water %>% 
              filter(year==analysis_year, month%in%c("Aug", "Sep", "Oct", "Nov")) %>%
              group_by(date2) %>% 
              summarize(mean = mean(Water.Level.m)), 
            aes(x=as.Date(date2), y=mean*1000), colour="dodger blue") +
  geom_bar(data=nitinat.SIL %>% 
             filter(SBJ_ID=="Chinook", NAME=="NITINAT RIVER") %>% 
             group_by(START_DTT, survey_type, segment_category) %>% 
             summarize(n=sum(SGA_LIVE_ADULTS_OBSERVED, na.rm=T)), 
           aes(x=as.Date(START_DTT), y=n, group=survey_type, fill=segment_category, 
               linetype = survey_type),  colour="black", stat="identity", position="stack", alpha=0.7, width=5) +
  labs(x="", y="Observed adult Chinook") +
  scale_y_continuous(sec.axis = sec_axis(~./1000, name="Water level (m)")) +
  scale_x_date(date_breaks="7 day", date_labels="%b %d") +
  labs(x="", Y="Live chinook", fill="Segment", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1, size=10),
        axis.text = element_text(size=10),
        axis.title = element_text(face="bold", size=12),
        legend.text = element_text(size=10),
        legend.title = element_text(size=15))

#dev.off()
```

Figure: Chinook counts (raw live adults), water levels (blue line)

<br>

<br>

## Behaviour & carcasses

```{r}
ggplot() +
    # ---- DEAD -----
  geom_point(data=nitinat.SIL %>%
               filter(NAME=="NITINAT RIVER" & SBJ_ID =="Chinook", survey_type!="Heli") %>%
               group_by(date, SBJ_ID) %>%
               summarize(total_adults_ded=sum(SGA_DEAD_ADULTS_OBSERVED, na.rm=T)) %>% 
               filter(total_adults_ded>0),
             aes(x=date, y=total_adults_ded), colour="black") +
  # # ---- DEAD -----  
  geom_line(data=nitinat.SIL %>%
               filter(NAME=="NITINAT RIVER" & SBJ_ID =="Chinook", survey_type!="Heli") %>%
               group_by(date, SBJ_ID) %>%
               summarize(total_adults_ded=sum(SGA_DEAD_ADULTS_OBSERVED, na.rm=T)) %>% 
               filter(total_adults_ded>0),
            aes(x=date, y=total_adults_ded), colour="black") +
  # ---- LIVE ----
  geom_bar(data=nitinat.SIL %>% 
             filter(NAME=="NITINAT RIVER" & SBJ_ID =="Chinook", survey_type!="Heli") %>%
             group_by(date, SBJ_ID, segment_category, survey_type) %>% 
             summarize(adults_spawning = sum(SGA_LIVE_ADULTS_SPAWNING, na.rm=T),
                       adults_holding = sum(SGA_LIVE_ADULTS_HOLDING, na.rm=T)) %>%
             pivot_longer(cols=c(adults_spawning, adults_holding), names_to = "behaviour", values_to = "count"), 
           aes(x=date, y=count, colour=segment_category, fill=behaviour), stat="identity", 
           position = "stack", alpha=0.8, width=5, linewidth = 1) +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d")+
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="Observed adult Chinook", fill="Behaviour", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```
<br>

Figure: Expanded live adult Chinook (bars) and carcasses (black line). Bar fill indicates behaviour (spawning=gray, holding=white), bar outline indicates river segment (upper=blue, lower=pink).

<br>

```{r}
ggplot() +
  geom_hline(aes(yintercept="18-17")) +
  geom_hline(aes(yintercept="13-12"), linetype = "dashed") +
  geom_tile(data = nitinat.SIL %>% 
              filter(SBJ_ID=="Chinook", NAME=="NITINAT RIVER") %>%
              group_by(START_DTT, SEGMENT_NAME) %>% 
              summarize(total = sum(SGA_LIVE_ADULTS_OBSERVED, na.rm=T),
                        perc_spawn = sum(SGA_LIVE_ADULTS_SPAWNING, na.rm=T) / total),
            aes(x=as.Date(START_DTT), y=SEGMENT_NAME, fill=perc_spawn)) +
  scale_x_date(date_labels = "%b %d") +
  scale_y_discrete(limits=rev) +
  scale_fill_viridis_c(na.value = "gray90") +
  labs(y="River segment", fill="Percent spawning") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1),
        axis.title.x = element_blank(),
        axis.title = element_text(face="bold"),
        legend.title = element_text(face="bold"))
```

Figure:  Chinook spawning behaviour by reach break over each survey (snorkel and heli, if done). Solid black line denotes the differentiation between upper and lower Nitinat; dashed black line indicates where the hatchery is located along the river. Note heli and snorkel reach breaks are not the same. If any reach break is blank, it implies the surveyors missed the marker, and both reach counts were included in the one before. Counts with no Chinook and/or no spawning Chinook are indicated as gray (division by zero). 

<br>

<br>

## Snorkel, river seine & swim-in counts

```{r}
ggplot() +
  geom_bar(data=nitinat.SIL %>% 
             filter(SBJ_ID=="Chinook", NAME=="NITINAT RIVER", survey_type!="Heli") %>% 
             group_by(START_DTT, survey_type, segment_category) %>% 
             summarize(Spawning = sum(SGA_LIVE_ADULTS_SPAWNING, na.rm=T),
                       Holding = sum(SGA_LIVE_ADULTS_HOLDING, na.rm=T)) %>% 
             pivot_longer(cols=c(Spawning, Holding), names_to="behaviour", values_to="count"),
             # mutate(date = case_when(type=="Heli Flight" ~ as.Date("2025-10-21"),
             #                         TRUE ~ date)), 
           aes(x=as.Date(START_DTT), y=count, fill=behaviour, colour=segment_category), 
           stat="identity", position="stack", alpha=0.7, size=1, width=1) +
  geom_bar(data=nrh.cn %>% 
             filter(parent_activity_type=="Adult Capture", grepl("Swim Ins", inventory_lot)) %>% 
             group_by(activity_start_date) %>% 
             summarize(n=sum(total_count,na.rm=T)),
           aes(x=as.Date(activity_start_date), y=n*1), fill="black", stat="identity", alpha=0.5, width=1) +
  
    geom_bar(data=nrh.cn %>% 
             filter(parent_activity_type=="Adult Capture", operations_location=="Nitinat R") %>% 
             group_by(activity_start_date) %>% 
             summarize(n=sum(total_count,na.rm=T)),
           aes(x=as.Date(activity_start_date), y=n*1), fill="red", stat="identity", width=1) +
  
  scale_y_continuous(sec.axis = sec_axis(~./1, name="Swim ins")) +
  scale_x_date(date_breaks="2 day", date_labels = "%b %d") +
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="Adult Chinook", fill="Behaviour", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: Expanded adult Chinook counts (large bars) and swim-ins (narrow black bars). Adult bar fill colours indicate behaviour (spawning=gray, holding=white), bar line colour indicates river segment (lower=pink, upper=blue). If a solid red bar is present, this indicates a river beach seine event for broodstock collection. 

<br>

Total number of swim-ins this year is: `r nrh.cn %>% filter(parent_activity_type=="Adult Capture", grepl("Swim Ins", inventory_lot)) %>% summarize(sum(total_count))`, of which `r nrh.cn %>% filter(parent_activity_type=="Adult Capture", grepl("Swim Ins", inventory_lot), maturity_class!="Jack") %>% summarize(sum(total_count))` were adults. 

The total number collected from river beach seining is: `r nrh.cn %>% filter(parent_activity_type=="Adult Capture", operations_location=="Nitinat R") %>% summarize(sum(total_count))`, of which `r nrh.cn %>% filter(parent_activity_type=="Adult Capture", operations_location=="Nitinat R", maturity_class!="Jack") %>% summarize(sum(total_count))` were adults. 

<br>

<br>

## Tributaries (River and Lake)

The following section is largely to help with determining whether Nitinat River trib counts (Parker, Worthless, Jasper, NoName, Little Nitinat) need to be in addition to the mainstem count, or if we think the fish that ended up in the tribs were captured in the mainstem swims (so don't need to be in addition to, and should be subtracted from the mainstem count). 

In some years there aren't tributary surveys, so this may not apply. 

```{r}
nitinat.SIL %>% 
  filter(SBJ_ID=="Chinook", NAME !="NITINAT RIVER") %>% 
  group_by(date, NAME) %>% 
  summarize(ad_live = sum(SGA_LIVE_ADULTS_OBSERVED, na.rm=T),
            exp_ad_livve = sum(SGA_LIVE_ADULTS_ESTIMATED, na.rm=T),
            dead_adults = sum(SGA_DEAD_ADULTS_OBSERVED, na.rm=T),
            jk_live = sum(SGA_LIVE_JACKS_ESTIMATED, na.rm=T),
            jk_dead = sum(SGA_DEAD_JACKS_ESTIMATED, na.rm=T)) %>%
  mutate(across(c(ad_live:jk_dead), ~round(., 0))) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1), valign="middle", target=1) 
```

<br>

```{r}
ggplot() +
  geom_bar(data=nitinat.SIL %>% 
             filter(SBJ_ID=="Chinook", grepl("NITINAT|PARKER|WORTHLESS|JASPER|NONAME", NAME, ignore.case=T)) %>% 
             # mutate(trib_status = case_when(grepl("LITTLE NITINAT|PARKER|WORTHLESS|JASPER|NONAME", NAME, 
             #                                      ignore.case=T) ~ "Tributary",
             #                                TRUE ~ "Mainstem")) %>%
             group_by(NAME, START_DTT) %>% 
             summarize(Spawning=sum(SGA_LIVE_ADULTS_SPAWNING, na.rm=T),
                       Holding = sum(SGA_LIVE_ADULTS_HOLDING, na.rm=T)) %>% 
             pivot_longer(cols=c(Spawning, Holding), names_to="behaviour", values_to="count"), 
           aes(x=as.Date(START_DTT), y=count, fill=behaviour, colour=NAME), 
           stat="identity", position=position_dodge(width=4), alpha=0.7, size=1, width=4, linewidth = 1) +
  # geom_bar(data = tribs.sil %>% 
  #            filter(species=="Chinook") %>% 
  #            group_by(system, date) %>% 
  #            summarize(Spawning=sum(`adults # spawning`),
  #                      Holding = sum(`adults # holding`)) %>% 
  #            pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"),
  #          aes(x=as.Date(date), y=count*1, colour=system, fill=behaviour), stat="identity",  alpha=0.8, size=1, width=1) +
  scale_y_continuous(sec.axis = sec_axis(~./1, name="Trib count")) +
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="mainstem count") +
  theme_bw()
```

Figure: Mainstem Nitinat (pink) and trib (blue/green) counts for Chinook adults (raw).  

<br>

<br>

## AUC assessments

<br>

The information below is meant to assist with determining if AUC is an appropriate method, and whether to include/exclude certain surveys. 

<br>

Table: AUC math for systems receiving AUC estimate in `r analysis_year`

```{r}
escEstAUC %>%
  filter(AREA!="20", ShortSpecies=="CN", grepl("Nitinat", SystemName)) 
```

<br>

```{r}
ggpubr::ggarrange(
  # THIS PLOT FOR ALL SURVEYS: 
  ggplot() +
    geom_line(data=escEstAUC %>% 
                mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
                filter(ShortSpecies=="CN", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)), 
              aes(x=as.Date(dateplot), y=ExpAdultFishDays)) +
    geom_point(data=escEstAUC %>% 
                 mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
                 filter(ShortSpecies=="CN", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)), 
               aes(x=as.Date(dateplot), y=ExpAdultFishDays, fill=method, colour=method), shape=21, size=4) +
    scale_fill_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
    scale_colour_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
    scale_x_date(date_breaks="5 day", date_labels="%b %d") +
    labs(x="", y="Fish-days", fill="Survey method", colour="Survey method") +
    theme_bw()
  
  #,
  
  
  # # THIS PLOT TO VISUALIZE ANY SURVEYS YOU WANT TO POTENTIALLY OMIT (flight or swim): ---- not relevant for 2024
  # ggplot() +
  #   geom_line(data=escEstAUC %>% 
  #               mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
  #               filter(ShortSpecies=="CN", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)) %>% 
  #               filter(dateplot!="2024/10/23"), 
  #             aes(x=as.Date(dateplot), y=ExpAdultFishDays)) +
  #   geom_point(data=escEstAUC %>% 
  #                mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
  #                filter(ShortSpecies=="CN", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)) %>% 
  #                filter(dateplot!="2024/10/23"), 
  #              aes(x=as.Date(dateplot), y=ExpAdultFishDays, fill=method, colour=method), shape=21, size=4) +
  #   scale_fill_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
  #   scale_colour_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
  #   scale_x_date(date_breaks="5 day", date_labels="%b %d") +
  #   labs(x="", y="Fish-days", fill="Survey method", colour="Survey method") +
  #   theme_bw(),
  
  #nrow=2
  
)
```

Figure: AUC curve for Nitinat mainstem Chinook.  

<br>

<br>

## Area 21-22 preliminary escapement estimates (AUC/PL+D) 

<br>



```{r eval=F}
# DISCTONINUED: Not a very helpful table/section so have removed. Retained code if want to keep in future

# Table: Raw swim data (raw and expanded live and dead) for Chinook.

# AUCdataTable %>% 
#   filter(ShortSpecies=="CN") %>% 
#   select(ShortSpecies,Section_AreaInspected, SDate, WaterTemperature, WaterClarity, 
#          LiveAdults, DeadAdults,LiveJacks,DeadJacks, ExpLiveAdults,
#          ExpDeadAdults, ExpLiveJacks, ExpDeadJacks, OverallReliability, EstPctSeen) %>% 
#   mutate(across(c(LiveAdults:ExpDeadJacks), ~round(., 0))) %>% 
#   kableExtra::kbl(align="c") %>%
#   kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
#   kableExtra::collapse_rows(columns=c(1:4), valign="middle", target=1) 
```

<br>

Table: Escapement estimate options (AUC/PL+D) for each system.   

```{r}
escEstSpp %>% 
  filter(ShortSpecies=="CN", AREA!="20") %>% 
  select(-c(WatershedCode, contains("Recommend"), EstimateConfidence, OptimumEscapement, #n, 
            contains("Raw"), contains("FishDays"))) %>% 
  relocate(c(SystemName, AREA), .before=ShortSpecies) %>% 
  rename(FinalAdultEstimate = AdultNaturalReco,
         FinalJackEstimate = JackNaturalReco) %>% 
  mutate(across(FinalJackEstimate:FinalAdultEstimate, ~case_when(.<0 ~ 0,
                                                                 TRUE ~ .))) %>%
  select(-c(Notes)) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1:4), valign="middle", target=1) 
```

<br>

### Estimate decision:   

Prior to this RMarkdown script I had already decided to omit the heli survey this year as it was not timed well for Chinook, and the counting was difficult in cases where Chinook might be post-spawn (pools, edges). This is reflected in most, if not all of the graphs with the survey omitted. 

In 2025, assumed the following for broodstock operations:
- River beach seine on Sept 23 fish were removed right before a swim and it's possible they entered since the last swim on Sept 12. Therefore, **beach seine removals need to be ADDED to the escapement estimate**. 
- Assume most of the swim-ins were captured in the Sept 25/Oct 8 swims - on Sept 25 the vast majority were in the lower river, none spawning. Roughly the same number were observed 1 week later, but much more spawning this time, though still lots of holding fish in the lower not committed to a location yet. The swim period captured the swim in period well, and I expect that the AUC expansions and accounting for survey life will capture these fish within the estimate. Therefore **swim-ins need to be removed from the final estimate**.

Opted for the middle-range SL for AUC for the preliminary estimate as the run timing was normal, despite the lake turnover events, low early water, and overall odd year for Chum arrival (late). Chinook entered the system early Sept which may have been a bit late, but was not linked to much of a rain event. Chinook already peaked in the system by the major rains, and spawn/die-off timing was relatively normal and predictable. No tributaries to account for this year. 

Therefore, the final estimate for adult Chinook should be `r escEstSpp[escEstSpp$ShortSpecies=="CN",]$AdultExpAUCMidValue_R` minus `r nrh.cn %>% filter(parent_activity_type=="Adult Capture", maturity_class %in% c("Male", "Female"), grepl("Swim Ins", inventory_lot)) %>% summarize(n=sum(total_count,na.rm=T)) %>% pull(n)` swim-ins, 




plus `r nrh.cn %>% filter(parent_activity_type=="Adult Capture", maturity_class %in% c("Male", "Female"), operations_location=="Nitinat R") %>% summarize(n=sum(total_count,na.rm=T)) %>% pull(n)` seined fish, **resulting in** `r escEstSpp[escEstSpp$ShortSpecies=="CN",]$AdultExpAUCMidValue_R - nrh.cn %>% filter(parent_activity_type=="Adult Capture", maturity_class %in% c("Male", "Female"), grepl("Swim Ins", inventory_lot)) %>% summarize(n=sum(total_count,na.rm=T)) %>% pull(n) + nrh.cn %>% filter(parent_activity_type=="Adult Capture", maturity_class %in% c("Male", "Female"), operations_location=="Nitinat R") %>% summarize(n=sum(total_count,na.rm=T)) %>% pull(n)` **adults**
**and** 
`r escEstSpp[escEstSpp$ShortSpecies=="CN",]$JackExpAUCMidValue_R - nrh.cn %>% filter(parent_activity_type=="Adult Capture", maturity_class %in% c("Jack"), grepl("Swim Ins", inventory_lot)) %>% summarize(n=sum(total_count, na.rm=T)) %>% pull(n) + nrh.cn %>% filter(parent_activity_type=="Adult Capture", maturity_class %in% c("Jack"), operations_location=="Nitinat R") %>% summarize(n=sum(total_count,na.rm=T)) %>% pull(n)` **jacks.**

Note this year may be a low estimate due to two lake turnover events: September 17 and October 14. On the Sept 17th event, the hatchery lost ~3000 Chinook broodstock that were being held in the lake pens. There was speculation that fish in the lake may have been able to swim away and avoid the low oxygen conditions, while those stuck in the pens died. However, the extent of the die off from both events is unknown. Hatchery staff reported the lake smelled like rotten eggs on Oct 14 as well (presumably due to anoxic layer coming to surface). The early event would have impacted Chinook more, while the later event would have impacted Chum more (if there were impacts). 

<br>

<br>

## `r analysis_year` compared to historical run timing and abundances

```{r}
ggplot() +
  geom_point(data=nit.rtStWk%>%filter(species=="chinook"),
             aes(x=stat_week, y=count, colour=plot_group, fill=plot_group, size=plot_group),
             shape=21, alpha=0.7) +
  scale_fill_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_colour_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_size_manual(breaks=waiver(), values=c(1.5,3.5)) +
  labs(x="Stat week", y="Live adult Chinook", fill="Year:", colour="Year:", size="Year:") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.box = "horizontal")
```

Figure: Raw swim counts (blue) from this year compared to historical raw swim counts. Stat weeks indicate the month (8=August, 12=December) and week of momth (1=first week, 2=2nd week, etc.), e.g., 81=First week of August, 91=First week of September, etc. 

<br>

```{r}
ggplot()  +
  geom_bar(data=a2122_nuseds_escapement %>% 
             filter(waterbody_name=="NITINAT RIVER", `Species Qualified`=="CK", 
                    est_type%in%c("Unspecified Return", "Natural Adult Spawners")) %>%
             group_by(year, est_type) %>%
             summarize(count = sum(estimate, na.rm=T)), 
           aes(x=year, y=count, colour=est_type, fill=est_type), stat="identity", alpha=0.8) +
  # geom_bar(data=escEstSpp %>% 
  #            filter(ShortSpecies=="CK", AREA!="20", grepl("Nitinat", SystemName)) %>% 
  #            select(Year, SystemName, AdultNaturalReco) %>% 
  #            summarize(n=sum(AdultNaturalReco)), 
  #          aes(x=analysis_year, y=n), stat="identity", colour="red", fill="dodger blue", alpha=0.4) +   
  scale_fill_manual(values=c("Unspecified Return" = "gray80",
                             "Natural Adult Spawners" = "dodger blue")) +
  scale_colour_manual(values=c("Unspecified Return" = "gray80",
                               "Natural Adult Spawners" = "dodger blue")) +
  scale_x_continuous(breaks=seq(min(a2122_nuseds_escapement$year), analysis_year, by=2)) +
  labs(x="Return Year", y="Chinook spawners", fill="Estimate type", colour="Estimate type") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: `r analysis_year` preliminary adult Chinook escapement estimate (red outline) relative to historical adult (blue) and unspecified (gray) escapement estimates.

<br>

<br>

<br>














# **Pink** 

No consistent WCVI pink runs. 

<br>

## Area 21-22 raw vs expanded counts

Counts are expanded for both % population surveyed and/or observer efficiency, depending on survey conditions.  

```{r}
ggplot() +
  geom_bar(data=escEstAUCsource %>% 
             filter(ShortSpecies=="PK") %>% 
             pivot_longer(c(LiveAdults:TotalJacks,ExpLiveAdults:ExpTotalJacks), names_to="est_type", values_to="n") %>% 
             filter(est_type %in% c("LiveAdults", "ExpLiveAdults")), 
           aes(x=as.Date(SDate), y=n, colour=est_type, fill=est_type), stat="identity", position=position_dodge(width=5),
           alpha=0.5, width=5) +
  labs(x="", y="Adult Pink counts") +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1),
        legend.position = "bottom",
        legend.title = element_blank()) +
  facet_wrap(~SystemName, scales="free")
```

Figure: Live Adult Chinook raw counts (blue) and counts expanded for % population and/or OE (pink). 

<br>

<br>

## Area 21-22 preliminary escapement estimates 

<br>

Table: Escapement estimates for each system.   

```{r}
escEstSpp %>% 
  filter(ShortSpecies=="PK", AREA!="20") %>% 
  select(-c(WatershedCode, contains("Recommend"), EstimateConfidence, OptimumEscapement, #n, 
            contains("Raw"), contains("FishDays"))) %>% 
  relocate(c(SystemName, AREA), .before=ShortSpecies) %>% 
  rename(FinalAdultEstimate = AdultNaturalReco,
         FinalJackEstimate = JackNaturalReco) %>% 
  mutate(across(FinalJackEstimate:FinalAdultEstimate, ~case_when(.<0 ~ 0,
                                                                 TRUE ~ .))) %>%
  select(-c(Notes)) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1:4), valign="middle", target=1) 
```

<br>

### Estimate decision:

PL+D wherever seen. 

<br>

<br>

## `r analysis_year` compared to historical escapement

<br>

```{r}
ggplot()  +
  geom_bar(data=a2122_nuseds_escapement %>% 
             filter(waterbody_name=="NITINAT RIVER", `Species Qualified`=="PKE", 
                    est_type%in%c("Unspecified Return", "Natural Adult Spawners")) %>%
             group_by(year, est_type) %>%
             summarize(count = sum(estimate, na.rm=T)), 
           aes(x=year, y=count, colour=est_type, fill=est_type), stat="identity", alpha=0.8) +
  # geom_bar(data=escEstSpp %>% 
  #            filter(ShortSpecies=="PK", AREA!="20", grepl("Nitinat", SystemName)) %>% 
  #            select(Year, SystemName, AdultNaturalReco) %>% 
  #            summarize(n=sum(AdultNaturalReco)), 
  #          aes(x=analysis_year, y=n), stat="identity", colour="red", fill="dodger blue", alpha=0.4) +   
  scale_fill_manual(values=c("Unspecified Return" = "gray80",
                             "Natural Adult Spawners" = "dodger blue")) +
  scale_colour_manual(values=c("Unspecified Return" = "gray80",
                               "Natural Adult Spawners" = "dodger blue")) +
  scale_x_continuous(breaks=seq(min(a2122_nuseds_escapement$year), analysis_year, by=2)) +
  labs(x="Return Year", y="Sockeye spawners", fill="Estimate type", colour="Estimate type") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: 2024 preliminary adult Pink escapement estimate (red outline) relative to historical adult (blue) and unspecified (gray) escapement estimates.  

<br>

<br>





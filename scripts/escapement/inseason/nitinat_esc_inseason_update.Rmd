---
title: "**Nitinat in-season update**"
date: 'Last update: `r Sys.Date()`'
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_collapsed: false 
    toc_depth: 5
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F, warning=F, message=F)


# Load packages ---------------------------------
library(tidyverse)


# Helpers --------------------------------- <<<UPDATE>>>
escapement_year <- 2025
options(scipen=9999)


# ================== COUNT DATA ================== 
# SIL data ---------------------------------

  # --- OLD READ METHOD USING EXCEL - retain code in case need to run old reports: 
   # nitinat.SIL <- readxl::read_excel(path=
   #                         paste0("//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/ESCAPEMENT/Data/", 
   #                                               escapement_year, 
   #                                               "/SILs/Area 22/Nitinat River/A22_Nitinat_River_", 
   #                                               escapement_year, 
   #                                               ".xlsx"),
   #                                   sheet="Nitinat River raw SIL entry", guess_max=1000) %>% 
   #   mutate_if(is.numeric, ~replace_na(., 0)) %>% 
   #   mutate_at(c("adults # holding", "adults live / habitat seen (# Est Live)"), ~round(.,0)) %>% 
   #   mutate(date = lubridate::ymd(date)) %>%
   #   print()

nitinat.SIL <- readxl::read_excel(path=list.files(path=paste0(here::here("data", "escapement", "prelim-inseason", escapement_year)),
                                                  pattern="SILAUC_Export",
                                                  full.names=T),
                                  sheet=1) %>% 
  mutate(SBJ_ID = case_match(SBJ_ID,
                             1 ~ "Sockeye",
                             2 ~ "Coho",
                             3 ~ "Pink",
                             4 ~ "Chum",
                             5 ~ "Chinook",
                             6 ~ "Rainbow Trout",
                             515039223 ~ "Steelhead",
                             8 ~ "Cutthroat Trout",
                             TRUE ~ "FLAG"),
         date = lubridate::ymd(stringr::str_sub(START_DTT, start=1, end=10)),
         segment_category = case_when(SEGMENT_NAME %in% c("18-17", "17-16", "16-15", "15-14", "14-13", "13-12", 
                                                          "12-11", "11-10", "10-9", "9-8", "8-7", "7-6", "6-5", 
                                                          "5-4", "4-3", "3-2", "2-1", "1-0") ~ "Lower",
                                      TRUE ~ "Upper"),
         survey_type = case_when(STREAM_MTP_ID==6 & SEGMENT_NAME %in% c("35-34", "34-29", "29-23", "23-17", 
                                                                        "17-12", "12-7", "7-0", "0-Lake") ~ "Heli",
                                 STREAM_MTP_ID==3 ~ "Snorkel",
                                 TRUE ~ "FLAG"))


# ================== ENVIRO DATA ================== 
# Water data ---------------------------------
nitinat.water <- 
  lapply(list.files(path = here::here("data", "enviro"),
                    pattern = "NitinatWaterLevelHydrometData_20*",
                    full.names = TRUE),
         read.csv, skip=1) %>%
  do.call("rbind",.) %>%
  separate(Received, sep=" ", c("date", "time", "stamp")) %>%
  mutate(date2 = case_when(is.na(TL.Battery.V) ~ lubridate::mdy(date),
                          !is.na(TL.Battery.V) ~ lubridate::dmy(date)),
        year = lubridate::year(date2),
        month = lubridate::month(date2, label=T, abbr=T),
        DOY = lubridate::yday(date2),
        Water.Level.m = case_when(grepl("\\*", Water.Level.m) ~ NA,
                                  TRUE ~ as.numeric(Water.Level.m)),
        label_group = case_when(year<escapement_year ~ "Historical",
                                        year==escapement_year ~ as.character(year)),
        hour = as.numeric(stringr::str_sub(stringr::str_pad(time, width=5, pad = "0"), 1,2)),
        hour = case_when(hour==12 & stamp=="AM" ~ 0,
                         TRUE ~ hour)) %>%
  print()


# Export compiled file for sharing: 
writexl::write_xlsx(nitinat.water, paste0(here::here("data", "enviro", "Nitinat River weather station data "),
                                          min(nitinat.water$year), "-", max(nitinat.water$year),
                                          " (", Sys.Date(), ").xlsx"))



# San Juan water data for comparison---
SJ.water <- full_join(
  read.csv(file=list.files(path = here::here("data", "enviro"),
                           pattern = "SANJUAN_historical*",
                           full.names = TRUE),
           skip=1) %>%
    mutate(PARAM = case_when(PARAM==1 ~ "discharge (cms)",
                             PARAM==2 ~ "level (m)"),
           Date = lubridate::ymd(Date),
           year = lubridate::year(Date),
           month = lubridate::month(Date, label=T, abbr=T),
           DOY = lubridate::yday(Date)),
  
    read.csv(file=list.files(path = here::here("data", "enviro"),
                           pattern = "SANJUAN_realtime*",
                           full.names = TRUE),
           skip=9) %>%
    mutate(Parameter = case_when(Parameter==46 ~ "level (m)"),
           Date = lubridate::ymd(stringr::str_sub(string=Date..PST., start=1, end=10)),
           time = stringr::str_sub(string=Date..PST., start=12, end=19),
           year = lubridate::year(Date..PST.),
           month = lubridate::month(Date..PST., label=T, abbr=T),
           DOY = lubridate::yday(Date..PST.)) %>% 
    rename(PARAM=Parameter,
           Value=Value..m.)
)




# ================== HISTORICAL DATA ================== 

# Run timing ---------------------------------
nit.rtStWk <- readxl::read_excel(path=#paste0(here::here("data", "escapement"), sep="/", 
                                      #       list.files(path=here::here("data", "escapement"),
                                      #                  pattern="run timing tables (updated)*")), 
                                   "//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/ESCAPEMENT/Data/run timing tables (updated).xlsx",
                                 sheet="Nitinat", guess_max=10000, trim_ws=T, 
                                 range=cellranger::cell_limits(c(4, 1), c(NA, NA))) %>% 
  select(-c(`...24`:`...75`)) %>%
  rename(year=`...1`) %>% 
  filter(if_any(everything(), ~ !is.na(.)), !grepl("Table", year), !grepl("Year", year), !is.na(year)) %>% 
  mutate(species = c(rep("chinook", nrow(.)/3), rep("coho", nrow(.)/3), rep("chum", nrow(.)/3)),
         `9-2` = case_when(`9-2`=="1000-2000" ~ as.numeric(1500),
                          TRUE ~ as.numeric(`9-2`)),
         across(c(`8-1`:`12-4`), ~as.numeric(.)),
         plot_group = case_when(year==escapement_year ~ year,
                                year!=escapement_year ~ paste0(min(year), 
                                                               sep="-", (escapement_year-1)))) %>%
  pivot_longer(cols = c(`8-1`:`12-4`), names_to = "stat_week", values_to = "count") %>% 
  print()

nit.rtStWk$stat_week <- factor(nit.rtStWk$stat_week,
                               levels=c("8-1","8-2","8-3","8-4",
                                        "9-1","9-2","9-3","9-4",
                                        "10-1","10-2","10-3","10-4","10-5",
                                        "11-1","11-2","11-3","11-4","11-5",
                                        "12-1","12-2","12-3","12-4", ordered=T)) 


# Escapement brood years ---------------------------------
# Option 1. Run outside of RMarkdown iKnit f need to refresh escapement each year: 
  #source(here::here("scripts", "functions", "pullNusedsData.R")) 
  # saves as a2122_nuseds_escapement

# Option 2. Source() above exports the file, read in the escapement data dump from the repo
a2122_nuseds_escapement <- readxl::read_excel(path=list.files(path=here::here("outputs"),
                                                              pattern="R_OUT - Area21-22_Escapement_allSpp-allYrs",
                                                              full.names=T),
                                              sheet=1)
```

<br>

<br>

# **`r escapement_year` Pre-season forecasts and regs**

- Chinook: 21,000 (16,000 - 28,000)
- Chum: 139,985 (136,024 - 142,583)
- Coho: 
  + Hatchery: Marine survival 5.5% (up from 2024) = Low marine survival 
  + Wild: Marine survival 0.9% (same as 2024) = Critical status

Wild Coho is non-retention in Nitinat for 2025. 2/day for hatchery Coho Aug 25-Dec 1. 

Chinook retention Aug 25-Sept 30, 2/day, only one >77cm. 

Chum retention Aug 25-Sept 30 and Oct 16-Dec 31, 2/day.

Non-retention for SK. 

No fishing u/s of Parker Creek. No fishing at bridge, hatchery, or Red Rock. 

https://www.pac.dfo-mpo.gc.ca/fm-gp/rec/fresh-douce/region1-eng.html

<br>

<br>

## Brood year escapements

The table below outlines the spawning escapement for brood year(s) that contributed to the `r escapement_year` return by species. Also important to consider are the hatchery egg/release targets and whether or not they were met. Note that in most  years "Adult Broodstock Removals" includes culls/morts/surplus/"other uses" fish as well as the actual spawned broodstock. 

```{r}
a2122_nuseds_escapement %>%
  janitor::clean_names() %>%
  filter(area=="22", grepl("nitinat|worthless|jasper|noname|parker", waterbody_name, ignore.case=T)) %>% 
  group_by(waterbody_name, species, year, est_type) %>%
  summarize(count = sum(estimate, na.rm=T)) %>%
  mutate(brood_year_selection = case_when(species=="Chinook" & year %in% c(escapement_year-5, escapement_year-4, escapement_year-3) ~ 
                                            "BY",
                                          species=="Coho" & year %in% c(escapement_year-3) ~ "BY",
                                          species=="Chum" & year %in% c(escapement_year-5, escapement_year-4, escapement_year-3) ~ 
                                            "BY",
                                          species=="Sockeye" & year %in% c(escapement_year-4) ~ "BY",
                                          TRUE ~ NA)) %>%
  filter(brood_year_selection=="BY", est_type%in%c("Natural Adult Spawners", "Adult Broodstock Removals")) %>%
  select(-c(brood_year_selection, waterbody_name)) %>%
  pivot_wider(names_from = est_type, values_from = count) %>%
  arrange(species, desc(year)) %>%
  mutate(!!paste0(escapement_year, " age class") := case_when(year==escapement_year-5 ~ 5,
                                                           year==escapement_year-4 ~ 4,
                                                           year==escapement_year-3 ~ 3,
                                                           TRUE ~ NA)) %>%
  relocate(contains("age class"), .after=year) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position="center") 
```


<br>

<br>

# **In-season counts**

<br> 

The `r escapement_year` Nitinat River and tribs surveys began on Aug 26. See \@ref(tab:survey-table) for segments surveyed each date and \@ref(tab:peak-table) for peak counts. 

<br>

```{r survey-table, tab.cap='Segments surveyed by date.'}
nitinat.SIL %>% 
  filter(!is.na(date)) %>% 
  group_by(NAME, date, segment_category) %>% 
  summarize() %>% 
  rename(`Segment(s) surveyed`=segment_category,
         Date=date) %>% 
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position="center") 
```

<br>

<br>

```{r}
#Total counts to date (excluding trout):
  
# nitinat.SIL %>% 
#   filter(!is.na(date), !is.na(SGA_LIVE_ADULTS_OBSERVED), 
#          SBJ_ID %in% c("Chinook", "Coho", "Chum", "Pink", "Sockeye", "Steelhead")) %>% 
#   group_by(date, SBJ_ID, survey_type) %>% 
#   summarize(total_adults_live = sum(SGA_LIVE_ADULTS_OBSERVED)) %>% 
#   kableExtra::kbl(align="c") %>%
#   kableExtra::kable_paper("hover", full_width=T, position="center")
```

Peak counts (excluding trout):

```{r peak-table}
nitinat.SIL %>% 
  filter(!is.na(date), !is.na(SGA_LIVE_ADULTS_OBSERVED),
         SBJ_ID %in% c("Chinook", "Coho", "Chum", "Pink", "Sockeye", "Steelhead")) %>% 
  group_by(NAME, date, SBJ_ID, survey_type) %>% 
  summarize(`Total adults live` = sum(SGA_LIVE_ADULTS_OBSERVED,na.rm=T)) %>% 
  group_by(SBJ_ID) %>% 
  mutate(`Peak count` = case_when(`Total adults live`==max(`Total adults live`, na.rm=T) ~ "Y",
                                      TRUE ~ "")) %>%
  rename(`Survey method`=survey_type,
         Species=SBJ_ID,
         Date=date,
         System=NAME) %>% 
  kableExtra::kbl(align="c", caption="Total live adults observed by survey location and date. Peak count 'Y' indicates entry is the peak count observed for a given species as of current data available") %>%
  kableExtra::kable_paper("hover", full_width=T, position="center")
```

<br>

<br>

```{r fig.cap='Raw live (bar) and carcass (line) counts for Nitinat River. Not all surveys are full system: early surveys are lower river only. Dead counts will populate once die-off begins.Note differing y-axis for each species.'}
ggplot() +
  # ---- DEAD -----
  geom_point(data=nitinat.SIL %>%
               filter(NAME=="NITINAT RIVER" & SBJ_ID %in% c("Chinook", "Coho", "Chum", "Pink", "Sockeye", "Steelhead")) %>%
               group_by(date, SBJ_ID) %>%
               summarize(total_adults_ded=sum(SGA_DEAD_ADULTS_OBSERVED, na.rm=T)) %>% 
               filter(total_adults_ded>0),
             aes(x=date, y=total_adults_ded, group=SBJ_ID), colour="black") +
  # # ---- DEAD -----  
  geom_line(data=nitinat.SIL %>%
               filter(NAME=="NITINAT RIVER" & SBJ_ID %in% c("Chinook", "Coho", "Chum", "Pink", "Sockeye", "Steelhead")) %>%
               group_by(date, SBJ_ID) %>%
               summarize(total_adults_ded=sum(SGA_DEAD_ADULTS_OBSERVED, na.rm=T)) %>% 
               filter(total_adults_ded>0),
            aes(x=date, y=total_adults_ded, group=SBJ_ID), colour="black") +
  # ---- LIVE ----
  geom_bar(data=nitinat.SIL %>% 
             filter(NAME=="NITINAT RIVER" & SBJ_ID %in% c("Chinook", "Coho", "Chum", "Pink", "Sockeye", "Steelhead")) %>%
             group_by(date, SBJ_ID, survey_type) %>% 
             summarize(total_adults=sum(SGA_LIVE_ADULTS_OBSERVED, na.rm=T)), 
           aes(x=date, y=total_adults, group=SBJ_ID, fill=SBJ_ID), stat="identity", alpha=0.8, width=3) +
  facet_wrap(~SBJ_ID, scales="free_y") +
  scale_x_date(limits=c(as.Date("2025-08-20"), as.Date("2025-11-15"))) +
  #scale_y_continuous(sec.axis = sec_axis(~ . /100, name = "Total dead adults (line)")) +
  labs(x="", y="Total live adults (bar)") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1),
        legend.position = "none", 
        axis.title = element_text(face="bold"))
```

<br>

<br>

```{r fig.cap='Live counts (bars) and water level (blue line) in the Nitinat River.'}
# Live ~ water 
# Plot counts with hydromet data to show pulses of fish into the system relative to rain events. 

ggplot() +
  # ---- WATER DATA ----
  geom_ribbon(data=nitinat.water %>% 
                filter(year==escapement_year & date2>=as.Date("2024-07-15")) %>%
                group_by(date2) %>% 
                summarize(mean_water = mean(Water.Level.m), min=min(Water.Level.m), max=max(Water.Level.m)),
              aes(x=date2, ymin=min*500, ymax=max*500), fill="dodger blue", alpha=0.5) +
  geom_line(data=nitinat.water %>% 
              filter(year==escapement_year & date2>=as.Date("2024-07-15")) %>%
              group_by(date2) %>% 
              summarize(mean_water = mean(Water.Level.m), min=min(Water.Level.m), max=max(Water.Level.m)),
            aes(x=date2, y=mean_water*500), colour="dodger blue", size=1) +
  # ---- COUNTS ----
  geom_bar(data=nitinat.SIL %>% 
             filter(NAME=="NITINAT RIVER" & SBJ_ID %in% c("Chinook", "Coho", "Chum", "Pink", "Sockeye", "Steelhead")) %>%
             group_by(date, SBJ_ID) %>% 
             summarize(total_adults = sum(SGA_LIVE_ADULTS_OBSERVED,na.rm=T)), 
           aes(x=date, y=total_adults, group=SBJ_ID, fill=SBJ_ID, colour=SBJ_ID), 
           stat="identity", alpha=0.8, width=2, size=1) +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d", limits=c(as.Date("2025-08-20"), as.Date("2025-11-15"))) +
  scale_y_continuous(sec.axis = sec_axis(~ . /500, name = "water level (m)")) +
  labs(x="", y="Live count") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1),
        legend.position = "none",
        axis.title = element_text(face="bold")) +
  facet_wrap(~SBJ_ID, ncol=2, scales="free_y")
```

<br>

<br>

```{r fig.cap='Spawning and holding behaviour for each species split by whether they were observed in the upper or lower Nitinat.'}
ggplot() +
  geom_bar(data=nitinat.SIL %>% 
             filter(NAME=="NITINAT RIVER" & SBJ_ID %in% c("Chinook", "Coho", "Chum", "Pink", "Sockeye", "Steelhead")) %>%
             group_by(date, SBJ_ID, survey_type, segment_category) %>% 
             summarize(Spawning=sum(SGA_LIVE_ADULTS_SPAWNING, na.rm=T),
                       Holding = sum(SGA_LIVE_ADULTS_HOLDING, na.rm=T)) %>% 
             pivot_longer(cols=c(Spawning, Holding), names_to="behaviour", values_to="count") %>% 
             filter(count>0), 
           aes(x=as.Date(date), y=count, fill=behaviour, colour=segment_category), 
           stat="identity", position="stack", alpha=0.7, size=1, width=1) +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d")+
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="Spawning adults", fill="Behaviour", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1)) +
  facet_wrap(~SBJ_ID, scales="free_y")
```


<br>

<br>

# **Historical run timing** 

```{r fig.cap='Historical run timing for focal species in Nitinat River (gray). Stat weeks along x axis denote the month and week of historical counts (e.g., stat week 8-1=First week of August, statweek 9-3=Third week of Sept, etc). Current year counts will show as blue points when populated.', fig.width=12, fig.height=12}

ggplot() +
  geom_point(data=nit.rtStWk,
             aes(x=stat_week, y=count, colour=plot_group, fill=plot_group, size=plot_group),
             shape=21, alpha=0.6, stroke=1.5) +
  scale_fill_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_colour_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_size_manual(breaks=waiver(), values=c(2, 4)) +
  scale_y_continuous(labels=scales::comma) +
  labs(x="Stat week", y="Live adults (raw)", fill="Year:", colour="Year:", size="Year:"#, caption="Historical run timing for focal species in Nitinat River (gray). Stat weeks along x axis denote the month and week of historical counts (e.g., stat week 81=First week of August, \nstatweek 93=Third week of Sept, etc). Current year counts will show as blue points when populated. DFO South Coast Salmon Stock Assessment data."
       ) +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.box = "horizontal",
        legend.text = element_text(size=11),
        legend.title = element_text(face="bold", size=13),
        axis.title = element_text(face="bold", size=15),
        axis.text = element_text(size=12),
        legend.key.spacing.x = unit(5,"mm"),
        plot.caption = element_text(hjust=0)) +
  facet_wrap(~stringr::str_to_title(species), nrow=3, scales="free_y") 
```

```{r pdfrt, eval=F}
pdf(file = here::here("outputs", "figures", "Nitinat run timing.pdf"),   
    width = 11, # The width of the plot in inches
    height = 8.5) # The height of the plot in inches

ggplot() +
  #annotate("text", x=Inf, y=-Inf, label="NOT FINAL ESTIMATES. DO NOT SHARE.",
  #         hjust=1.1, vjust=-1.1, col="gray70", size=6, fontface="bold", alpha=0.6) +
  geom_point(data=nit.rtStWk,
             aes(x=stat_week, y=count, colour=plot_group, fill=plot_group, size=plot_group),
             shape=21, alpha=0.6, stroke=1.5) +
  scale_fill_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_colour_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_size_manual(breaks=waiver(), values=c(2, 4)) +
  scale_y_continuous(labels=scales::comma) +
  labs(x="Stat week", y="Live adults (raw)", fill="Year:", colour="Year:", size="Year:", caption="Historical run timing for focal species in Nitinat River (gray). Stat weeks along x axis denote the month and week of historical counts (e.g., stat week 81=First week of August, \nstatweek 93=Third week of Sept, etc). Current year counts will show as blue points when populated. DFO South Coast Salmon Stock Assessment data.") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.box = "horizontal",
        axis.title = element_text(face="bold"),
        legend.key.spacing.x = unit(5,"mm"),
        plot.caption = element_text(hjust=0)) +
  facet_wrap(~stringr::str_to_title(species), nrow=3, scales="free_y") 

dev.off()
```


<br>

<br>

```{r fig.cap='Historical run timing for focal species in Nitinat River (gray). Stat weeks along x axis denote the month and week of historical counts (e.g., stat week 81=First week of August, statweek 93=Third week of Sept, etc). Current year counts will show as blue points when populated.', fig.width=12, fig.height=12, eval=F}
#
cowplot::plot_grid(

ggplot() +
  geom_tile(data=nit.rtStWk %>%
              filter(species=="chinook") %>%
              group_by(year, stat_week) %>%
              summarize(count=case_when(!is.na(count) ~ sum(count,na.rm=T),
                                        is.na(count) ~ NA), plot_group=plot_group) %>%
              filter(!is.na(count)),
            aes(x=stat_week, y=reorder(year, year, descending=F), fill=count)) +
  scale_fill_viridis_c(option = "C") +
  scale_y_discrete(limits=rev) +
  labs(x="Stat week", y="", fill="Chinook\nLive adults: ") +
  theme_bw() +
  theme(legend.position = c(0.93, 0.2),
        legend.text = element_text(size=9),
        legend.title = element_text(size=11),
        legend.background = element_rect(fill=alpha("transparent",0.7), colour="black"),
        axis.title = element_text(face="bold", size=15),
        axis.text = element_text(colour="black", size=12),
        legend.key.spacing.x = unit(5,"mm"),
        plot.caption = element_text(hjust=0)),

ggplot() +
  geom_tile(data=nit.rtStWk %>%
              filter(species=="coho") %>%
              group_by(year, stat_week) %>%
              summarize(count=case_when(!is.na(count) ~ sum(count,na.rm=T),
                                        is.na(count) ~ NA), plot_group=plot_group) %>%
              filter(!is.na(count)),
            aes(x=stat_week, y=reorder(year, year, descending=F), fill=count)) +
  scale_fill_viridis_c(option = "C") +
  scale_y_discrete(limits=rev) +
  labs(x="Stat week", y="", fill="Coho\nLive adults: ") +
  theme_bw() +
  theme(legend.position = c(0.93, 0.22),
        legend.text = element_text(size=9),
        legend.title = element_text(size=11),
        legend.background = element_rect(fill=alpha("transparent",0.7), colour="black"),
        axis.title = element_text(face="bold", size=15),
        axis.text = element_text(colour="black", size=12),
        legend.key.spacing.x = unit(5,"mm"),
        plot.caption = element_text(hjust=0)),

ggplot() +
  geom_tile(data=nit.rtStWk %>%
              filter(species=="chum") %>%
              group_by(year, stat_week) %>%
              summarize(count=case_when(!is.na(count) ~ sum(count,na.rm=T),
                                        is.na(count) ~ NA), plot_group=plot_group) %>%
              filter(!is.na(count)),
            aes(x=stat_week, y=reorder(year, year, descending=F), fill=count)) +
  scale_fill_viridis_c(option = "C", guide = guide_colorbar(barwidth = 0.5, barheight = 5)) +
  scale_y_discrete(limits=rev) +
  labs(x="Stat week", y="", fill="Chum\nLive adults: ") +
  theme_bw() +
  theme(legend.position = c(0.93, 0.45),
        legend.text = element_text(size=9),
        legend.title = element_text(size=11),
        legend.background = element_rect(fill=alpha("transparent",0.7), colour="black"),
        axis.title = element_text(face="bold", size=15),
        axis.text = element_text(colour="black", size=12),
        legend.key.spacing.x = unit(5, "mm"),
        plot.caption = element_text(hjust=0)),

nrow=2)
```

```{r pdfheatmap, eval=F}
# PDF VERSION 

pdf(file = here::here("outputs", "figures", "Nitinat run timing (heatmap).pdf"),   
    width = 11, # The width of the plot in inches
    height = 8.5) # The height of the plot in inches

rtheat <- cowplot::plot_grid(

ggplot() +
  geom_tile(data=nit.rtStWk %>%
              filter(species=="chinook") %>%
              group_by(year, stat_week) %>%
              summarize(count=case_when(!is.na(count) ~ sum(count,na.rm=T),
                                        is.na(count) ~ NA), plot_group=plot_group) %>%
              filter(!is.na(count)),
            aes(x=stat_week, y=reorder(year, year, descending=F), fill=count)) +
  scale_fill_viridis_c(option = "C") +
  scale_y_discrete(limits=rev) +
  labs(x="Stat week", y="", fill="Chinook\nLive adults: ") +
  theme_bw() +
  theme(legend.position = c(0.93, 0.22),
        legend.text = element_text(size=6),
        legend.title = element_text(size=7),
        legend.background = element_rect(fill=alpha("transparent",0.7), colour="black"),
        axis.title = element_text(face="bold"),
        axis.text = element_text(colour="black"),
        legend.key.spacing.x = unit(5,"mm"),
        plot.caption = element_text(hjust=0)),

ggplot() +
  geom_tile(data=nit.rtStWk %>%
              filter(species=="coho") %>%
              group_by(year, stat_week) %>%
              summarize(count=case_when(!is.na(count) ~ sum(count,na.rm=T),
                                        is.na(count) ~ NA), plot_group=plot_group) %>%
              filter(!is.na(count)),
            aes(x=stat_week, y=reorder(year, year, descending=F), fill=count)) +
  scale_fill_viridis_c(option = "C") +
  scale_y_discrete(limits=rev) +
  labs(x="Stat week", y="", fill="Coho\nLive adults: ") +
  theme_bw() +
  theme(legend.position = c(0.93, 0.22),
        legend.text = element_text(size=6),
        legend.title = element_text(size=7),
        legend.background = element_rect(fill=alpha("transparent",0.7), colour="black"),
        axis.title = element_text(face="bold"),
        axis.text = element_text(colour="black"),
        legend.key.spacing.x = unit(5,"mm"),
        plot.caption = element_text(hjust=0)),

ggplot() +
  geom_tile(data=nit.rtStWk %>%
              filter(species=="chum") %>%
              group_by(year, stat_week) %>%
              summarize(count=case_when(!is.na(count) ~ sum(count,na.rm=T),
                                        is.na(count) ~ NA), plot_group=plot_group) %>%
              filter(!is.na(count)),
            aes(x=stat_week, y=reorder(year, year, descending=F), fill=count)) +
  scale_fill_viridis_c(option = "C", guide = guide_colorbar(barwidth = 0.5, barheight = 5)) +
  scale_y_discrete(limits=rev) +
  labs(x="Stat week", y="", fill="Chum\nLive adults: ") +
  theme_bw() +
  theme(legend.position = c(0.93, 0.22),
        legend.text = element_text(size=6),
        legend.title = element_text(size=7),
        legend.background = element_rect(fill=alpha("transparent",0.7), colour="black"),
        axis.title = element_text(face="bold"),
        axis.text = element_text(colour="black"),
        legend.key.spacing.x = unit(5,"mm"),
        plot.caption = element_text(hjust=0)),

nrow=2)

dev.off()
```

<br>

<br>











# **Water level and temperature**

The following water data are compiled from the Nitinat Hydromet operated by South Coast Stock Assessment: http://pacfish.ca/wcviweather/Content%20Pages/Nitinat/WaterLevel.aspx

The hydromet station for Nitinat is not currently reporting to the website. Work is underway to restore reporting before swims begin. For now, the following information is summarized from the backend database. Contact Katie with questions. 

```{r fig.cap='Nitinat hydromet water level (m). Historical shaded area represents daily maximum and minimum recorded values over the time series, while the line represents the mean water level. Current year line represents daily mean water level (blue). Water level is recorded hourly at the Nitinat River Hatchery pumphouse.', fig.width=8, fig.height=6}

ggplot()+
  geom_ribbon(data=nitinat.water %>% 
                filter(year!=escapement_year & Water.Level.m>0.1) %>%
                group_by(DOY) %>% 
                summarize(max_lvl=max(Water.Level.m,na.rm=T), min_lvl=min(Water.Level.m,na.rm=T)),
              aes(x=as.Date(DOY, origin="2021-12-31"), ymin=min_lvl, ymax=max_lvl), fill="gray80", alpha=0.6) +
  geomtextpath:: geom_textline(data=nitinat.water %>%
                                filter(year!=escapement_year & Water.Level.m>0.1) %>%
                                group_by(DOY) %>%
                                summarize(mean_lvl_hist=mean(Water.Level.m,na.rm=T)) %>%
                                mutate(label = paste0(min(nitinat.water$year), sep="-", escapement_year-1)),
                              aes(x=as.Date(DOY, origin="2021-12-31"), y=mean_lvl_hist, label=as.factor(label)),
                              colour="gray40", linewidth=1, show.legend=F, hjust=0.9, text_smoothing=30, alpha=0.6) +
  geomtextpath:: geom_labelline(data=nitinat.water %>% 
                                filter(year==escapement_year & Water.Level.m>0.1) %>%
                                group_by(DOY) %>% 
                                summarize(mean_lvl=mean(Water.Level.m,na.rm=T)) %>% 
                                mutate(label=escapement_year),
                              aes(x=as.Date(DOY, origin="2021-12-31"), y=mean_lvl, label=as.factor(label)), 
                              colour="dodger blue", linewidth=1.2, hjust=0.13, show.legend=F) +
  labs(y="Water level (m)") +
  scale_colour_manual(values=c("dodger blue", "gray70")) +
  scale_x_date(date_labels = "%b %d") +
  scale_y_continuous(breaks=seq(0,10,by=0.5)) +
  coord_cartesian(ylim=c(0.75, 6)) +
  theme_bw() +
  theme(axis.text = element_text(colour="black"),
        axis.title = element_text(face="bold"),
        axis.title.x = element_blank(),
        legend.title = element_blank())
```

<br>

The last downloaded water level was **`r nitinat.water %>% filter(date2==max(date2)) %>% filter(hour==max(hour)) %>% pull(Water.Level.m)` m** on **`r nitinat.water %>% filter(date2==max(date2)) %>% filter(hour==max(hour)) %>% pull(date)`** at **`r nitinat.water %>% filter(date2==max(date2)) %>% filter(hour==max(hour)) %>% unite(col="time_stamp", time, stamp, sep=" ") %>% pull(time_stamp)`**. Current water temp is **`r nitinat.water %>% filter(date2==max(date2)) %>% filter(hour==max(hour)) %>% pull(Water.temp.C)` C**, air temp is **`r nitinat.water %>% filter(date2==max(date2)) %>% filter(hour==max(hour)) %>% pull(Air.Temp.Analog.C)` C**.

<br>

```{r fig.cap='Nitinat hydromet water and air temperature (C). Historical shaded area represents daily maximum and minimum recorded values over the time series, while the line represents the mean (gray). Current year line represents daily mean water and/or air temperature (green). Water and air temperature are recorded hourly at the Nitinat River Hatchery pumphouse.', fig.width=8, fig.height=6}

ggpubr::ggarrange(
  ggplot()+
    geom_ribbon(data=nitinat.water %>% 
                  filter(year!=escapement_year) %>%
                  group_by(DOY) %>% 
                  summarize(max_temp=max(Water.temp.C,na.rm=T), min_temp=min(Water.temp.C,na.rm=T)),
                aes(x=as.Date(DOY, origin="2021-12-31"), ymin=min_temp, ymax=max_temp), fill="gray80", alpha=0.6) +
    geomtextpath:: geom_textline(data=nitinat.water %>% 
                                   filter(year!=escapement_year) %>%
                                   group_by(DOY) %>% 
                                   summarize(mean_temp_hist=mean(Water.temp.C,na.rm=T)) %>%
                                   mutate(label = paste0(min(nitinat.water$year), sep="-", escapement_year-1)),
                                 aes(x=as.Date(DOY, origin="2021-12-31"), y=mean_temp_hist, label=as.factor(label)), 
                                 colour="gray40", linewidth=1, show.legend=F, hjust=0.9, text_smoothing=30, alpha=0.6) +
    geomtextpath:: geom_labelline(data=nitinat.water %>% 
                                    filter(year==escapement_year) %>%
                                    group_by(DOY) %>% 
                                    summarize(mean_temp=mean(Water.temp.C,na.rm=T)) %>% 
                                    mutate(label=escapement_year),
                                  aes(x=as.Date(DOY, origin="2021-12-31"), y=mean_temp, label=as.factor(label)), 
                                  colour="green", linewidth=1, show.legend=F, hjust=0, text_smoothing=30) +
    labs(y="Water temperature (C)") +
    scale_colour_manual(values=c("green", "gray70")) +
    scale_x_date(date_labels = "%b %d") +
    #scale_y_continuous(breaks=seq(0,10,by=0.5)) +
    theme_bw() +
    theme(axis.text = element_text(colour="black"),
          axis.title = element_text(face="bold"),
          axis.title.x = element_blank(),
          legend.title = element_blank()),
  
  
  ggplot()+
    geom_ribbon(data=nitinat.water %>% 
                  filter(year!=escapement_year) %>%
                  group_by(DOY) %>% 
                  summarize(max_temp=max(Air.Temp.Analog.C,na.rm=T), min_temp=min(Air.Temp.Analog.C,na.rm=T)),
                aes(x=as.Date(DOY, origin="2021-12-31"), ymin=min_temp, ymax=max_temp), fill="gray80", alpha=0.6) +
    geomtextpath:: geom_textline(data=nitinat.water %>% 
                                   filter(year!=escapement_year) %>%
                                   group_by(DOY) %>% 
                                   summarize(mean_temp_hist=mean(Air.Temp.Analog.C,na.rm=T)) %>%
                                   mutate(label = paste0(min(nitinat.water$year), sep="-", escapement_year-1)),
                                 aes(x=as.Date(DOY, origin="2021-12-31"), y=mean_temp_hist, label=as.factor(label)), 
                                 colour="gray40", linewidth=1, show.legend=F, hjust=0.91, text_smoothing=30, alpha=0.6) +
    geomtextpath:: geom_labelline(data=nitinat.water %>% 
                                    filter(year==escapement_year) %>%
                                    group_by(DOY) %>% 
                                    summarize(mean_temp=mean(Air.Temp.Analog.C,na.rm=T)) %>% 
                                    mutate(label=escapement_year),
                                  aes(x=as.Date(DOY, origin="2021-12-31"), y=mean_temp, label=as.factor(label)), 
                                  colour="green", linewidth=1, show.legend=F, hjust=0, text_smoothing=30) +
    labs(y="Air temperature (C)") +
    scale_colour_manual(values=c("green", "gray70")) +
    scale_x_date(date_labels = "%b %d") +
    #scale_y_continuous(breaks=seq(0,10,by=0.5)) +
    theme_bw() +
    theme(axis.text = element_text(colour="black"),
          axis.title = element_text(face="bold"),
          axis.title.x = element_blank(),
          legend.title = element_blank()),
  
  nrow=2)
```


<br>

<br>



## Summer water conditions

Graphs focusing on the lead up to and including peak salmon periods 

```{r fig.cap='Nitinat hydromet water level (m) for summer and fall. Historical shaded area represents daily maximum and minimum recorded values over the time series, while the line represents the mean water level. Current year line represents daily mean water level (blue). Water level is recorded hourly at the Nitinat River Hatchery pumphouse.', fig.width=8, fig.height=6}

ggplot()+
  geom_ribbon(data=nitinat.water %>% 
                filter(month %in% c("Jun", "Jul", "Aug","Sep","Oct", "Nov") & year!=escapement_year & Water.Level.m>0.1) %>%
                group_by(DOY) %>% 
                summarize(max_lvl=max(Water.Level.m,na.rm=T), min_lvl=min(Water.Level.m,na.rm=T)),
              aes(x=as.Date(DOY, origin="2021-12-31"), ymin=min_lvl, ymax=max_lvl), fill="gray80", alpha=0.6) +
  geomtextpath:: geom_textline(data=nitinat.water %>%
                                filter(month %in% c("Jun", "Jul", "Aug","Sep","Oct", "Nov") & 
                                         year!=escapement_year & Water.Level.m>0.1) %>%
                                group_by(DOY) %>%
                                summarize(mean_lvl_hist=mean(Water.Level.m,na.rm=T)) %>%
                                mutate(label = paste0(min(nitinat.water$year), sep="-", escapement_year-1)),
                              aes(x=as.Date(DOY, origin="2021-12-31"), y=mean_lvl_hist, label=as.factor(label)),
                              colour="gray40", linewidth=1, show.legend=F, hjust=0.93, text_smoothing=30, alpha=0.6) +
  geomtextpath:: geom_labelline(data=nitinat.water %>% 
                                filter(month %in% c("Jun", "Jul", "Aug","Sep","Oct", "Nov") & 
                                         year==escapement_year & Water.Level.m>0.1) %>%
                                group_by(DOY) %>% 
                                summarize(mean_lvl=mean(Water.Level.m,na.rm=T)) %>% 
                                mutate(label=escapement_year),
                              aes(x=as.Date(DOY, origin="2021-12-31"), y=mean_lvl, label=as.factor(label)), 
                              colour="dodger blue", linewidth=1, 
                              hjust=0.3, 
                              show.legend=F) +
  labs(y="Water level (m)") +
  scale_colour_manual(values=c("dodger blue", "gray70")) +
  scale_x_date(date_labels = "%b %d", date_breaks = "7 day") +
  scale_y_continuous(breaks=seq(0, 5,by=0.5)) +
  coord_cartesian(ylim=c(0.75, 6)) +
  theme_bw() +
  theme(axis.text = element_text(colour="black"),
        axis.text.x = element_text(angle=45, hjust=1),
        axis.title = element_text(face="bold"),
        axis.title.x = element_blank(),
        legend.title = element_blank())
```

```{r fig.cap='Nitinat hydromet water and air temperature (C) for summer and fall. Historical shaded area represents daily maximum and minimum recorded values over the time series, while the line represents the mean (gray). Current year line represents daily mean water and/or air temperature (green). Water and air temperature are recorded hourly at the Nitinat River Hatchery pumphouse.', fig.width=8, fig.height=6}

ggpubr::ggarrange(
  ggplot()+
    geom_ribbon(data=nitinat.water %>% 
                  filter(month %in% c("Jun", "Jul", "Aug","Sep","Oct", "Nov") & year!=escapement_year) %>%
                  group_by(DOY) %>% 
                  summarize(max_temp=max(Water.temp.C,na.rm=T), min_temp=min(Water.temp.C,na.rm=T)),
                aes(x=as.Date(DOY, origin="2021-12-31"), ymin=min_temp, ymax=max_temp), fill="gray80", alpha=0.6) +
    geomtextpath:: geom_textline(data=nitinat.water %>% 
                                   filter(month %in% c("Jun", "Jul", "Aug","Sep","Oct", "Nov") & year!=escapement_year) %>%
                                   group_by(DOY) %>% 
                                   summarize(mean_temp_hist=mean(Water.temp.C,na.rm=T)) %>%
                                   mutate(label = paste0(min(nitinat.water$year), sep="-", escapement_year-1)),
                                 aes(x=as.Date(DOY, origin="2021-12-31"), y=mean_temp_hist, label=as.factor(label)), 
                                 colour="gray40", linewidth=1, show.legend=F, hjust=0.9, text_smoothing=30, alpha=0.6) +
    geomtextpath:: geom_labelline(data=nitinat.water %>% 
                                    filter(month %in% c("Jun", "Jul", "Aug","Sep","Oct", "Nov") & year==escapement_year) %>%
                                    group_by(DOY) %>% 
                                    summarize(mean_temp=mean(Water.temp.C,na.rm=T)) %>% 
                                    mutate(label=escapement_year),
                                  aes(x=as.Date(DOY, origin="2021-12-31"), y=mean_temp, label=as.factor(label)), 
                                  colour="green", linewidth=1, show.legend=F, hjust=2.2, text_smoothing=30) +
    labs(y="Water temperature (C)") +
    scale_colour_manual(values=c("green", "gray70")) +
    scale_x_date(date_labels = "%b %d") +
    #scale_y_continuous(breaks=seq(0,10,by=0.5)) +
    theme_bw() +
    theme(axis.text = element_text(colour="black"),
          axis.title = element_text(face="bold"),
          axis.title.x = element_blank(),
          legend.title = element_blank()),
  
  
  ggplot()+
    geom_ribbon(data=nitinat.water %>% 
                  filter(month %in% c("Jun", "Jul", "Aug","Sep","Oct", "Nov") & year!=escapement_year) %>%
                  group_by(DOY) %>% 
                  summarize(max_temp=max(Air.Temp.Analog.C,na.rm=T), min_temp=min(Air.Temp.Analog.C,na.rm=T)),
                aes(x=as.Date(DOY, origin="2021-12-31"), ymin=min_temp, ymax=max_temp), fill="gray80", alpha=0.6) +
    geomtextpath:: geom_textline(data=nitinat.water %>% 
                                   filter(month %in% c("Jun", "Jul", "Aug","Sep","Oct", "Nov") & year!=escapement_year) %>%
                                   group_by(DOY) %>% 
                                   summarize(mean_temp_hist=mean(Air.Temp.Analog.C,na.rm=T)) %>%
                                   mutate(label = paste0(min(nitinat.water$year), sep="-", escapement_year-1)),
                                 aes(x=as.Date(DOY, origin="2021-12-31"), y=mean_temp_hist, label=as.factor(label)), 
                                 colour="gray40", linewidth=1, show.legend=F, hjust=0.91, text_smoothing=30, alpha=0.6) +
    geomtextpath:: geom_labelline(data=nitinat.water %>% 
                                    filter(month %in% c("Jun", "Jul", "Aug","Sep","Oct", "Nov") & year==escapement_year) %>%
                                    group_by(DOY) %>% 
                                    summarize(mean_temp=mean(Air.Temp.Analog.C, na.rm=T)) %>% 
                                    mutate(label=escapement_year),
                                  aes(x=as.Date(DOY, origin="2021-12-31"), y=mean_temp, label=as.factor(label)), 
                                  colour="green", linewidth=1, show.legend=F, hjust=1000, text_smoothing=30) +
    labs(y="Air temperature (C)") +
    scale_colour_manual(values=c("green", "gray70")) +
    scale_x_date(date_labels = "%b %d") +
    #scale_y_continuous(breaks=seq(0,10,by=0.5)) +
    theme_bw() +
    theme(axis.text = element_text(colour="black"),
          axis.title = element_text(face="bold"),
          axis.title.x = element_blank(),
          legend.title = element_blank()),
  
  nrow=2)
```

<br>

<br>



<br>

<br>

## Environment Canada river forecast 

While there is no official flow forecast for the Nitinat River, the San Juan River Environment Canada COFFEE forecast can be used as a proxy for Nitinat River as both systems exhibit similar seasonal flow patterns.  

```{r}
knitr::include_url("http://bcrfc.env.gov.bc.ca/fallfloods/coffee/08HA010.PDF")
```

<br>

```{r fig.cap='Summer/fall water level at Nitinat (blue) and San Juan (gray) from 2021-present. Shaded region represents daily maximum and minimum levels while solid line indicates daily average among all years. San Juan water level from Environment Canada, Nitinat from South Coast Stock assessment hydromet.'}
ggplot()+
  geom_ribbon(data=SJ.water %>% 
                filter(month %in% c("Aug","Sep","Oct", "Nov") & year%in%c(2021:escapement_year) & PARAM=="level (m)")  %>%
                group_by(DOY) %>% 
                summarize(max_lvl=max(Value,na.rm=T), min_lvl=min(Value,na.rm=T)),
              aes(x=as.Date(DOY, origin="2021-12-31"), ymin=min_lvl, ymax=max_lvl), fill="gray80", alpha = 0.6) +
  geomtextpath::geom_textline(data=SJ.water %>% 
                                 filter(month %in% c("Aug","Sep","Oct", "Nov") & year%in%c(2021:escapement_year) & 
                                          PARAM=="level (m)")  %>%
                                 group_by(DOY) %>% 
                                 summarize(mean_lvl_hist=mean(Value,na.rm=T)) %>%
                                 mutate(label = paste0("San Juan ", min(nitinat.water$year), sep="-", escapement_year)),
                               aes(x=as.Date(DOY, origin="2021-12-31"), y=mean_lvl_hist, label=as.factor(label)), 
                               colour="gray60", linewidth=1, show.legend=F, hjust=0, text_smoothing=30, alpha=0.7) +
  geom_ribbon(data=nitinat.water %>% 
                filter(month %in% c("Aug","Sep","Oct", "Nov") & Water.Level.m>0.1) %>%
                group_by(DOY) %>% 
                summarize(max_lvl=max(Water.Level.m,na.rm=T), min_lvl=min(Water.Level.m,na.rm=T)),
              aes(x=as.Date(DOY, origin="2021-12-31"), ymin=min_lvl, ymax=max_lvl), fill="dodger blue", alpha=0.4) +
  geomtextpath:: geom_textline(data=nitinat.water %>% 
                                 filter(month %in% c("Aug","Sep","Oct", "Nov") & Water.Level.m>0.1) %>%
                                 group_by(DOY) %>% 
                                 summarize(mean_lvl=mean(Water.Level.m,na.rm=T)) %>% 
                                 mutate(label = paste0("Nitinat ", min(nitinat.water$year), sep="-", escapement_year)),
                               aes(x=as.Date(DOY, origin="2021-12-31"), y=mean_lvl, label=as.factor(label)), 
                               colour="dodger blue", linewidth=1, show.legend=F, hjust=0.01, alpha=0.8) +
  labs(y="Water level (m)") +
  scale_colour_manual(values=c("dodger blue", "gray70")) +
  scale_x_date(date_labels = "%b %d") +
  scale_y_continuous(breaks=seq(0,10,by=0.5)) +
  coord_cartesian(ylim=c(0.75, 6)) +
  theme_bw() +
  theme(axis.text = element_text(colour="black"),
        axis.title = element_text(face="bold"),
        axis.title.x = element_blank(),
        legend.title = element_blank())
```


<br>

## Weather forecast

```{r}
knitr::include_url("https://www.yr.no/en/print/forecast/2-6088637/Canada/British%20Columbia/Cowichan%20Valley%20Regional%20District/Nitinat%20Lake")
```


<br>

<br>

```{r}
# Copy report to network drive
file.copy(from = here::here("scripts", "escapement", "inseason", "nitinat_esc_inseason_update.html"), 
          to = paste0("//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/ESCAPEMENT/Data/", 
                      escapement_year, 
                      "/SILs/Area 22/"),
          overwrite = T, copy.date = T)
```


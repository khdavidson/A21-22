---
title: "Nitinat escapement 2024 (PRELIM)"
author: "South Coast StA"
date: "Last update: `r Sys.Date()`"
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_collapsed: false 
    toc_depth: 5
    number_sections: true
knit: (function(inputFile, encoding) { 
  rmarkdown::render(inputFile, encoding=encoding, output_file=paste0(substr(inputFile,1,nchar(inputFile)-4), "_PRELIMINARY_", format(Sys.Date(), 
  sep="_", "%Y-%m-%d"), '.html'))
  }
  )
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F, warning=F, message=F)


# Load libraries ----------------------------
library(tidyverse)
#library(readxl)
#library(here)
#library(ggpubr)
#library(kableExtra)


# Helpers ----------------------------
options(scipen = 9999999)
"%notin%" <- Negate("%in%")
analysis_year <- 2024



# ============================= Load RAW SIL data ============================

# Raw SIL entry for Nitinat mainstem ---------------------
nit.sil <- list.files(paste0("//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/ESCAPEMENT/Data/",
                             analysis_year,
                             "/SILs/Area 21-22/Nitinat River/"),
                      pattern = "^A22_Nitinat_River*.*xlsx", full.names = T) %>% 
  map(~readxl::read_excel(path=.x, trim_ws=T, guess_max=20000, sheet="Nitinat River raw SIL entry"), id="path") %>% 
  list_rbind() %>% 
  mutate(date = case_when(type=="Heli Flight" ~ as.Date("2024-10-23"),
                          TRUE ~ as.Date(date))) %>%
  print()


# Raw SIL entry for Tribs (incl Lake tribs) ---------------------
tribs.sil <- list.files(paste0("//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/ESCAPEMENT/Data/",
                               analysis_year,
                               "/SILs/Area 21-22/Area 22 tributaries/"),
                        pattern = "^A22_Tributaries*.*xlsx", full.names = T) %>% 
  map(~readxl::read_excel(path=.x, trim_ws=T, guess_max=20000, sheet="Tributaries Raw SIL entry"), id="path") %>% 
  list_rbind() %>% 
  print()



# ============================= Load SIL+AUC DATABASE data ============================

# Waterbody values (to join to EscEStSppHeader table) ---------------------
wbdyVals <- readxl::read_excel(path=here::here("data", "escapement", "prelim-inseason", "WaterbodiesValues.xlsx")) %>% 
  mutate(AREA = case_when(NAME=="TUCK LAKE" ~ "22",
                          TRUE ~ AREA)) %>%
  select(AREA, NAME, WATERSHED_CDE) %>% 
  rename(WatershedCode = WATERSHED_CDE) %>% 
  filter(!is.na(WatershedCode)) %>% 
  group_by(AREA, NAME, WatershedCode) %>% 
  filter(AREA %in% c(20,21,22)) %>% 
  group_by(WatershedCode) %>% 
  mutate(n=n(),
         system = case_when(n>1 ~ paste0("system", seq(1,length(n),by=1)),
                            n==1 ~ "system1")) %>% 
  group_by(WatershedCode) %>% 
  pivot_wider(names_from=system, values_from=NAME) %>% 
  #select(-n) %>% 
  unite("SystemName", system1:system3, sep=", ", remove=T, na.rm=T) %>% 
  mutate(SystemName = str_to_title(SystemName)) %>%
  print()


# AUC Data Table for analysis ---------------------
AUCdataTable <- readxl::read_excel(path=paste0(here::here("data", "escapement", "prelim-inseason", 
                                                          "AUC_DataAnalysisTable_area21-22_"),
                                               analysis_year,
                                               ".xlsx"))


# EscEstSppHeader table ---------------------
escEstSpp <- readxl::read_excel(path=paste0(here::here("data", "escapement", "prelim-inseason", 
                                                       "EscEstSppHeader_area20-22_"),
                                            analysis_year,
                                            ".xlsx")) %>% 
  left_join(.,
            wbdyVals,
            na_matches="never", relationship="many-to-one") %>%
  mutate(AdultMidResidenceTime_R = round((AdultShortResidenceTime + AdultLongResidenceTime)/2,1),
         JackMidResidenceTime_R = round((JackShortResidenceTime + JackLongResidenceTime)/2,1),
         AdultExpAUCMidValue_R = round(AdultExpAUCSumOfFishDays/AdultMidResidenceTime_R,0),
         JackExpAUCMidValue_R = round(JackExpAUCSumOfFishDays/JackMidResidenceTime_R,0)) %>% 
  relocate(AdultMidResidenceTime_R, .before = AdultLongResidenceTime) %>%
  relocate(JackMidResidenceTime_R, .before = JackLongResidenceTime) %>% 
  relocate(AdultExpAUCMidValue_R, .before=AdultExpAUCHighValue) %>% 
  relocate(JackExpAUCMidValue_R, .before=JackExpAUCHighValue) 


# EscEstAUCResults table --------------------- 
escEstAUC <- readxl::read_excel(path=paste0(here::here("data", "escapement", "prelim-inseason", 
                                                       "EscEstAUCResults_area20-22_"),
                                            analysis_year,
                                            ".xlsx")) %>% 
  left_join(.,
            wbdyVals,
            na_matches="never", relationship="many-to-one") %>% 
  #<<<< UPDATE HELI DATE EACH YEAR! >>>>>
  mutate(method = case_when(DateRange== "2024/10/11 - 2024/10/23" ~ "heli",
                            TRUE ~ "snorkel"))



# ============================= Load EPRPO HATCHERY data ============================

# Hatchery swim-ins from EPRO ----------------------------
# CHINOOK:
nrh.cn <- list.files(paste0(path="//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/ESCAPEMENT/Data/",
                            analysis_year,
                            "/SILs/Area 21-22/"),
                     pattern = "^Adult_Management - Nitinat CN", full.names = T) %>% 
  map(~readxl::read_excel(path=.x, trim_ws=T, guess_max=20000, sheet="Adult Management", skip=1), id="path") %>% 
  list_rbind() %>% 
  rename(InventoryLot=`Inventory Lot`, 
         ParentActivityType=`Parent Activity Type`, 
         SourceLocationType=`Source Location Type`,
         TotalCount=`Total Count`,
         MaturityClass=`Maturity Class`) %>% 
  mutate(MaturityClassGroup = case_when(MaturityClass=="Jack" ~ "Jack",
                                        TRUE ~ "Adult"))

# CHUM:
nrh.cm <- list.files(paste0(path="//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/ESCAPEMENT/Data/",
                            analysis_year,
                            "/SILs/Area 21-22/"),
                     pattern = "^Adult_Management - Nitinat CM", full.names = T) %>%
  map(~readxl::read_excel(path=.x, trim_ws=T, guess_max=20000, sheet="Adult Management", skip=1), id="path") %>%
  list_rbind() %>%
  rename(InventoryLot=`Inventory Lot`,
         ParentActivityType=`Parent Activity Type`,
         SourceLocationType=`Source Location Type`,
         TotalCount=`Total Count`,
         MaturityClass=`Maturity Class`) %>% 
  mutate(MaturityClassGroup = case_when(MaturityClass=="Jack" ~ "Jack",
                                        TRUE ~ "Adult"))


# COHO:
nrh.co <- list.files(paste0(path="//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/ESCAPEMENT/Data/",
                             analysis_year,
                             "/SILs/Area 21-22/"),
                      pattern = "^Adult_Management - Nitinat CO", full.names = T) %>%
  map(~readxl::read_excel(path=.x, trim_ws=T, guess_max=20000, sheet="Adult Management", skip=1), id="path") %>%
  list_rbind() %>%
  rename(InventoryLot=`Inventory Lot`,
         ParentActivityType=`Parent Activity Type`,
         SourceLocationType=`Source Location Type`,
         TotalCount=`Total Count`,
         MaturityClass=`Maturity Class`)


# ============================= Load AUXILIARY data ============================

# Enviro ----------------------------
nit.water <- 
  lapply(list.files(path = here::here("data", "enviro"),
                    pattern = "NitinatWaterLevelHydrometData_20*",
                    full.names = TRUE),
         read.csv, skip=1) %>%
  do.call("rbind",.) %>%
  separate(Received, sep=" ", c("date", "time", "stamp")) %>%
  mutate(date2 = case_when(is.na(TL.Battery.V) ~ lubridate::mdy(date),
                           !is.na(TL.Battery.V) ~ lubridate::dmy(date)),
         year = lubridate::year(date2),
         month = lubridate::month(date2, label=T, abbr=T),
         DOY = lubridate::yday(date2),
         Water.Level.m = case_when(grepl("\\*", Water.Level.m) ~ NA,
                                   TRUE ~ as.numeric(Water.Level.m)),
         label_group = case_when(year<analysis_year ~ "Historical",
                                 year==analysis_year ~ as.character(year)),
         hour = as.numeric(stringr::str_sub(stringr::str_pad(time, width=5, pad = "0"), 1,2)),
         hour = case_when(hour==12 & stamp=="AM" ~ 0,
                          TRUE ~ hour)) %>%
  print()




# Run timing ----------------------------
nit.rtStWk <- readxl::read_excel("//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/ESCAPEMENT/Data/run timing tables (updated).xlsx", 
                                 sheet="Nitinat", guess_max=10000, trim_ws=T, range=cellranger::cell_limits(c(4, 1), c(NA, NA))) %>% 
  select(-c(`...24`:`...75`)) %>%
  rename(year=`...1`) %>% 
  filter(if_any(everything(), ~ !is.na(.)), !grepl("Table", year), !grepl("Year", year), !is.na(year)) %>% 
  mutate(species = c(rep("chinook", nrow(.)/3), rep("coho", nrow(.)/3), rep("chum", nrow(.)/3)),
         `92` = case_when(`92`=="1000-2000" ~ as.numeric(1500),
                          TRUE ~ as.numeric(`92`)),
         across(c(`81`:`124`), ~as.numeric(.)),
         plot_group = case_when(year==analysis_year ~ year,
                                year!=analysis_year ~ paste0(min(year), sep="-", (analysis_year-1)))) %>%
  pivot_longer(cols = c(`81`:`124`), names_to = "stat_week", values_to = "count") %>% 
  print()

nit.rtStWk$stat_week <- factor(nit.rtStWk$stat_week,
                               levels=c("81","82","83","84",
                                        "91","92","93","94",
                                        "101","102","103","104","105",
                                        "111","112","113","114","115",
                                        "121","122","123","124", ordered=T))


# Escapement ----------------------------
nit.escHistorical <- list.files(path=here::here("data", "escapement"),
                                pattern = "NuSEDS_Area21-22_escapement_", full.names = T) %>% 
  map(~readxl::read_excel(path=.x, trim_ws=T, guess_max=20000, sheet="Data"), id="path") %>% 
  list_rbind() 



nit.esc.goal <- read.csv(here::here("data", "escapement", "wcviCK-BootstrappedRPs.csv")) %>% 
  filter(Stock=="Nitinat")
```

<br>

<br>


# **Infilling/specialty expansion of specific surveys**

*This section is reserved for deeper dives into specific surveys or days where specialty expansions might be required (e.g., important sections missed, partial surveys around peak of spawn, etc.). This section could be blank in years where no detailed exploration/analysis is needed to determine a survey's expansion!*

On Oct 24 we only swam the lower section to calibrate with the heli, focus on Chum, and due to crew shortages. Need to expand potentially for missed upper section. 

First, will do this by looking at the ratio of counts between lower and upper.

```{r eval=F}
nit.sil %>% 
  filter(species%in%c("Chinook", "Chum", "Coho", "Sockeye")) %>%
  group_by(date, type, `upper/lower (for Nitinat River only)`, species) %>%
  summarize(totalLiveSeg = sum(`adults live`)) %>% 
  group_by(date, type, species) %>%
  mutate(surveyTotal = sum(totalLiveSeg),
         segRatio = totalLiveSeg/surveyTotal)
```

```{r}
ggplot() +
  geom_bar(data=nit.sil %>% 
             filter(species%in%c("Chinook", "Chum", "Coho", "Sockeye")) %>%
             group_by(date, type, `upper/lower (for Nitinat River only)`, species) %>%
             summarize(totalLiveSeg = sum(`adults live`)) %>% 
             group_by(date, type, species) %>%
             mutate(surveyTotal = sum(totalLiveSeg),
                    segRatio = totalLiveSeg/surveyTotal),
           aes(x=as.Date(date), y=segRatio, 
               fill=`upper/lower (for Nitinat River only)`, colour=`upper/lower (for Nitinat River only)`, group=type), 
           stat="identity", position="stack") +
  scale_x_date(date_breaks="7 day", date_labels="%b %d") +
  scale_y_continuous(breaks=seq(0,2,by=0.1)) +
  theme_bw() +
  facet_wrap(~species, scales="free")
```

Observations for each species based on graph above:

- Chum: Chum appear to be pretty consistently ~85% in the lower river, whether it was on snorkel surveys or from the heli. Therefore, on Oct 24 lower swim we should probably say *85% population*

- Chinook: Chinook are a bit variable, but tend to have fewer in the upper too. There were essentially no fish left Nov 7 (n=5), so apply last few surveys that where ~80% in lower reaches, therefore *80% population* for Oct 24.

- Coho: Coho tend to push up, and surveys this year may note 2 waves of Coho that went up to upper and on to tribs even. For Oct 24, will apply *50% population*. 

- Sockeye: minimal amount, but most should be heading up (or already in) Parker, so will set to *50% population*. 























# **Sockeye**            

<br>

Snorkel and heli surveys were primarily timed for Chinook and Chum. Sockeye counts are incidental and should be considered low-quality/incomplete. Very low water this summer likely resulted in a barrier to migration, preventing sockeye from reaching Parker Creek until rains came much later. For this reason, SK counts in 2023 may be much higher than previous years as they were trapped in the lower mainstem and more visible to surveyors in late August.

<br>

## Area 21-22 raw vs expanded counts

Counts are expanded for both % population surveyed and/or observer efficiency, depending on survey conditions.  

```{r}
# ggplot() +
#   geom_bar(data=ver23 %>% filter(ShortSpecies=="SK") %>% pivot_longer(LiveAdults:ExpDeadJacks, names_to="est_type", values_to="n") %>% filter(est_type %in% c("LiveAdults", "ExpLiveAdults")), 
#            aes(x=as.Date(Date), y=n, colour=est_type, fill=est_type), stat="identity", position="dodge", alpha=0.5) +
#   labs(x="", y="Adult Sockeye counts", fill="Expansion", colour="Expansion") +
#   scale_x_date(date_breaks="7 day", date_labels = "%b %d") +
#   theme_bw() +
#   theme(axis.text.x = element_text(angle=45, hjust=1))

ggplot() +
  geom_bar(data=AUCdataTable %>% 
             filter(ShortSpecies=="SK") %>% 
             pivot_longer(c(LiveAdults:TotalJacks,ExpLiveAdults:ExpDeadJacks), names_to="est_type", values_to="n") %>% 
             filter(est_type %in% c("LiveAdults", "ExpLiveAdults")), 
           aes(x=as.Date(SDate), y=n, colour=est_type, fill=est_type), stat="identity", position="dodge", alpha=0.5) +
  labs(x="", y="Adult Sockeye counts", fill="Expansion", colour="Expansion") +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d") +
  #scale_y_continuous(limits=c(0, max(AUCdataTable[AUCdataTable$ShortSpecies=="SK",]$ExpLiveAdults,na.rm=T))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1),
        legend.position = "bottom") +
  facet_wrap(~Section_AreaInspected, scales="free_y")
```

Figure: Live Adult sockeye raw counts (blue) and counts expanded for % population and/or OE (pink). 

<br>

<br>

## Counts & environmentals


```{r}
ggplot() +
  # Plot water data -------------
geom_ribbon(data=nit.water %>% 
              filter(year==analysis_year, month%in%c("Aug", "Sep", "Oct", "Nov")) %>%
              group_by(date2) %>% 
              summarize(min=min(Water.Level.m), max=max(Water.Level.m)), 
            aes(x=as.Date(date2), ymin=min*50, ymax=max*50), fill="dodger blue", alpha=0.5) +
  geom_line(data=nit.water %>% 
              filter(year==analysis_year, month%in%c("Aug", "Sep", "Oct", "Nov")) %>%
              group_by(date2) %>% 
              summarize(mean = mean(Water.Level.m)), 
            aes(x=as.Date(date2), y=mean*50), colour="dodger blue") +
  # Plot survey count data ------------
geom_bar(data=nit.sil %>% 
           filter(species=="Sockeye") %>% 
           group_by(date, type, `upper/lower (for Nitinat River only)`) %>% 
           summarize(n=sum(`adults live / habitat seen (# Est Live)`)), 
         aes(x=as.Date(date), y=n, group=type, fill=`upper/lower (for Nitinat River only)`, 
             colour=`upper/lower (for Nitinat River only)`), 
         stat="identity", position="stack", alpha=0.7) +
  scale_y_continuous(sec.axis = sec_axis(~./100, name="Staff gauge (m)")) +
  scale_x_date(date_breaks="7 day", date_labels="%b %d") +
  labs(x="", y="Expanded adult Sockeye", fill="Segment", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

*Figure: Sockeye counts (expanded adults), water levels (blue line), and period of time water level was <1.1m (believed to be about where the log jam becomes impassable in 2023).*

Only about 2-3% of the total SK counts were above the log jam.

<br>

<br>

## Behaviour & carcasses

```{r}
ggplot() +
  geom_bar(data=nit.sil %>% 
             filter(species=="Sockeye") %>% 
             group_by(date, type, `upper/lower (for Nitinat River only)`) %>% 
             summarize(Spawning=sum(`adults # spawning`),
                       Holding = sum(`adults # holding`)) %>% 
             pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"), 
           aes(x=as.Date(date), y=count, fill=behaviour, colour=`upper/lower (for Nitinat River only)`), 
           stat="identity", position="stack", alpha=0.7, size=1) +
  geom_point(data=nit.sil %>% filter(species=="Sockeye") %>% group_by(date) %>% 
               summarize(n=sum(`adults dead`)), 
             aes(x=as.Date(date), y=n), size=2, alpha=0.5) +
  geom_line(data=nit.sil %>% filter(species=="Sockeye") %>% group_by(date) %>% 
              summarize(n=sum(`adults dead`)), 
            aes(x=as.Date(date), y=n), 
            stat="identity", position="stack") +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d")+
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="Spawning adult Sockeye", fill="Behaviour", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```
<br>

Figure: Top: Expanded live Sockeye (bars) and carcasses (black line) in the Nitinat mainstem. Bottom: Spawning (gray bars) and holding (white bars) adult Sockeye and carcasses (black line). 

<br>

<br>

## Snorkel & swim-in counts

There are no swim-ins for Nitinat sockeye as they are not enhanced. 

<br>

<br>

## Tributaries (River and Lake)

Sockeye were present in Hobiton and Campus Creeks in 2023, but the primary enumeration method is by NTC and DFN echosounder. 
Hobiton was swum once late May due to delays in the echosounder installation, and again in late August during drought conditions to assess whether pre-spawn mortalities were occurring in the creek. Only one pre-spawn jack was noted, the remaining dead were too deep or too decomposed to assess mortality. 

```{r}
tribs.sil %>% 
  filter(species=="Sockeye") %>% 
  group_by(date, system) %>% 
  summarize(exp_ad_live = sum(`adults live / habitat seen (# Est Live)`),
            dead_adults = sum(`adults dead`),
            jk_live = sum(`jacks live`),
            jk_dead = sum(`jacks dead`)) %>%
  mutate(across(c(exp_ad_live:dead_adults), ~round(., 0))) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1), valign="middle", target=1) 
```

<br>

```{r}
ggplot() +
  geom_bar(data=nit.sil %>% 
             filter(species=="Sockeye") %>% 
             group_by(surveyNum, date, system) %>% 
             summarize(Spawning=sum(`adults # spawning`),
                       Holding = sum(`adults # holding`)) %>% 
             pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"), 
           aes(x=as.Date(date), y=count, fill=behaviour, colour=system), 
           stat="identity", position="stack", alpha=0.7, size=1, width=1) +
  geom_bar(data = tribs.sil %>% 
             filter(species=="Sockeye", trib_status=="Nitinat trib") %>% 
             group_by(system, date) %>% 
             summarize(Spawning=sum(`adults # spawning`),
                       Holding = sum(`adults # holding`)) %>% 
             pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"),
           aes(x=as.Date(date), y=count*1, colour=system, fill=behaviour), stat="identity",  alpha=0.8, size=1, width=1) +
  scale_y_continuous(sec.axis = sec_axis(~./1, name="Trib count")) +
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="mainstem count") +
  theme_bw()
```

Figure: Mainstem Nitinat (pink) and trib (blue) counts for Sockeye adults (raw).  

<br>

<br>

## AUC assessments

<br>

The information below is meant to assist with determining if AUC is an appropriate method, and whether to include/exclude certain surveys. 
**Note that removals of surveys that are deemed irrelevant for a species/year has already been in the database prior to exporting the AUCresults file. This script does not really help with that unless you "restore to default" AUC data in the database and do some extra plotting yourself** 

<br>

Table: AUC math for systems receiving AUC estimate in `r analysis_year`

```{r}
escEstAUC %>%
  filter(AREA!="20", ShortSpecies=="SK", grepl("Nitinat", SystemName)) 
```

<br>

```{r}
ggplot() +
  geom_line(data=escEstAUC %>% 
              mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
              filter(ShortSpecies=="SK", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)), 
            aes(x=as.Date(DateRange), y=ExpAdultFishDays)) +
  geom_point(data=escEstAUC %>% 
               mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
               filter(ShortSpecies=="SK", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)), 
             aes(x=as.Date(DateRange), y=ExpAdultFishDays, fill=method, colour=method), shape=21, size=4) +
  scale_fill_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
  scale_colour_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
  scale_x_date(date_breaks="5 day", date_labels="%b %d") +
  labs(x="", y="Fish-days", fill="Survey method", colour="Survey method") +
  theme_bw()
```

Figure: AUC curve for Nitinat mainstem Sockeye. Note in 2023 this had already excluded the heli survey, but in future would likely also include the flight for reference. 

<br>

<br>

## Area 21-22 preliminary escapement estimates  

<br>

Table: Raw swim data (raw and expanded live and dead) for Sockeye.  

```{r}
AUCdataTable %>% 
  filter(ShortSpecies=="SK") %>% 
  select(ShortSpecies,Section_AreaInspected, SDate, WaterTemperature, WaterClarity, LiveAdults, DeadAdults,LiveJacks,DeadJacks, ExpLiveAdults,
         ExpDeadAdults, ExpLiveJacks, ExpDeadJacks, OverallReliability, EstPctSeen) %>% 
  mutate(across(c(LiveAdults:ExpDeadJacks), ~round(., 0))) %>% 
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1:4), valign="middle", target=1) 
```

<br>

Table: Escapement estimates for each system. 

```{r}
escEstSpp %>% 
  filter(ShortSpecies=="SK", AREA!="20") %>% 
  select(-c(WatershedCode, contains("Recommend"), EstimateConfidence, OptimumEscapement, n, contains("Raw"), contains("FishDays"))) %>% 
  relocate(c(SystemName, AREA), .before=ShortSpecies) %>% 
  rename(FinalAdultEstimate = AdultNaturalReco,
         FinalJackEstimate = JackNaturalReco) %>% 
  mutate(across(FinalJackEstimate:FinalAdultEstimate, ~case_when(.<0 ~ 0,
                                                                 TRUE ~ .))) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1:4), valign="middle", target=1) 
```

<br>

<br>

### Estimate decision:

**FILL IN HERE**

<br>

<br>

## `r analysis_year` compared to historical run timing and abundance

Run timing information is not available for Nitinat Sockeye.

<br>

```{r}
ggplot()  +
  geom_bar(data=nit.escHistorical %>% 
             filter(`Waterbody Name`=="NITINAT RIVER", `Species Qualified`=="SEL"), 
           aes(x=`Analysis Year`, y=`Natural Adult Spawners`), stat="identity", colour="dodger blue", fill="dodger blue", alpha=0.8) +
  geom_bar(data=nit.escHistorical %>% 
             filter(`Waterbody Name`=="NITINAT RIVER", `Species Qualified`=="SEL"), 
           aes(x=`Analysis Year`, y=`Unspecified Return`), stat="identity", colour="gray80", fill="gray80", alpha=0.8) +  
  geom_bar(data=escEstSpp %>% 
             filter(ShortSpecies=="SK", AREA!="20", grepl("Nitinat", SystemName)) %>% 
             select(Year, SystemName, AdultNaturalReco) %>% 
             summarize(n=sum(AdultNaturalReco)), 
           aes(x=analysis_year, y=n), stat="identity", colour="red", fill="dodger blue", alpha=0.4) +   
  scale_x_continuous(breaks=seq(min(nit.escHistorical$`Analysis Year`), analysis_year, by=2)) +
  labs(x="Return Year", y="Sockeye spawners") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: `r analysis_year` preliminary adult Sockeye escapement estimate (red outline) relative to historical adult (blue) and unspecified (gray) escapement estimates. Gaps indicate years without estimates. 

<br>

<br>


























# **Coho**            

<br>

Six snorkel surveys were conducted in 2023, but only the latter ones can be considered representative for Coho (they were only seen on 4 of the 6 surveys).  

<br>

## Area 21-22 raw vs expanded counts

Counts are expanded for both % population surveyed and/or observer efficiency, depending on survey conditions.  

```{r}
ggplot() +
  geom_bar(data=AUCdataTable %>% 
             filter(ShortSpecies=="CO") %>% 
             pivot_longer(c(LiveAdults:TotalJacks,ExpLiveAdults:ExpDeadJacks), names_to="est_type", values_to="n") %>% 
             filter(est_type %in% c("LiveAdults", "ExpLiveAdults"), n>=0) %>%
             mutate(n = case_when(is.na(n) ~ 0,
                                  TRUE ~ n)), 
           aes(x=as.Date(SDate), y=n, colour=est_type, fill=est_type), stat="identity", position="dodge", alpha=0.5, width=2) +
  labs(x="", y="Adult Coho counts", fill="Expansion", colour="Expansion") +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d", limits = c(as.Date(paste0(analysis_year, "-08-15")), 
                                                                      as.Date(paste0(analysis_year, "-12-15")))) +
  expand_limits(y=0) +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1),
        legend.position = "bottom") +
  facet_wrap(~Section_AreaInspected, scales="free_y", nrow=2)
```
s
Figure: Live Adult Coho raw counts (blue) and counts expanded for % population and/or OE (pink). 

<br>

## Counts & environmentals

```{r}
ggplot() +
  # Plot water data -------------
geom_ribbon(data=nit.water %>% 
              filter(year==analysis_year, month%in%c("Aug", "Sep", "Oct", "Nov")) %>%
              group_by(date2) %>% 
              summarize(min=min(Water.Level.m), max=max(Water.Level.m)), 
            aes(x=as.Date(date2), ymin=min*500, ymax=max*500), fill="dodger blue", alpha=0.5) +
  geom_line(data=nit.water %>% 
              filter(year==analysis_year, month%in%c("Aug", "Sep", "Oct", "Nov")) %>%
              group_by(date2) %>% 
              summarize(mean = mean(Water.Level.m)), 
            aes(x=as.Date(date2), y=mean*500), colour="dodger blue") +
  geom_bar(data=nit.sil %>% filter(species=="Coho") %>% group_by(date, type, `upper/lower (for Nitinat River only)`) %>% 
             summarize(n=sum(`adults live / habitat seen (# Est Live)`)), 
           aes(x=as.Date(date), y=n, group=type, 
               fill=`upper/lower (for Nitinat River only)`, colour=`upper/lower (for Nitinat River only)`), 
           stat="identity", position="stack", alpha=0.7) +
  scale_y_continuous(sec.axis = sec_axis(~./500, name="Water level (m)")) +
  scale_x_date(date_breaks="7 day", date_labels="%b %d") +
  labs(x="", y="Live adult Coho", fill="Segment", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: Coho counts (expanded adults) and water levels (blue line) 

<br>

<br>

## Behaviour & carcasses

```{r}
ggplot() +
  geom_bar(data=nit.sil %>% 
             filter(species=="Coho") %>% 
             group_by(date, type, `upper/lower (for Nitinat River only)`) %>% 
             summarize(Spawning=sum(`adults # spawning`),
                       Holding = sum(`adults # holding`)) %>% 
             pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"), 
           aes(x=as.Date(date), y=count, fill=behaviour, colour=`upper/lower (for Nitinat River only)`), 
           stat="identity", position="stack", alpha=0.7, size=1) +
  geom_point(data=nit.sil %>% filter(species=="Coho") %>% group_by(date) %>% 
               summarize(n=sum(`adults dead`)), 
             aes(x=as.Date(date), y=n*1), size=2, alpha=0.5) +
  geom_line(data=nit.sil %>% filter(species=="Coho") %>% group_by(date) %>% 
              summarize(n=sum(`adults dead`)), 
            aes(x=as.Date(date), y=n*1), 
            stat="identity", position="stack") +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d")+
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="Spawning adult Coho", fill="Behaviour", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```
<br>

Figure: Expanded live adult Coho (bars) and carcasses (black line). Bar fill indicates behaviour (spawning=gray, holding=white), bar outline indicates river segment (upper=blue, lower=pink).

<br>

<br>

## Snorkel, angling & swim-in counts

```{r eval=F}
ggplot() +
  geom_bar(data=nit.sil %>% 
             filter(species=="Coho") %>% 
             group_by(date, type, `upper/lower (for Nitinat River only)`) %>% 
             summarize(Spawning=sum(`adults # spawning`),
                       Holding = sum(`adults # holding`)) %>% 
             pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"), 
           aes(x=as.Date(date), y=count, fill=behaviour, colour=`upper/lower (for Nitinat River only)`), 
           stat="identity", position="stack", alpha=0.7, size=1) +
  geom_bar(data=nrh.co %>% 
             filter(ParentActivityType=="Adult Capture", grepl("Swim In", InventoryLot, ignore.case=T)) %>% 
             group_by(`Activity Start Date`) %>% 
             summarize(n=sum(TotalCount)),
           aes(x=as.Date(`Activity Start Date`), y=n), fill="black", stat="identity", alpha=0.7, width=5) +
  
  geom_bar(data=nrh.co %>%
             filter(`Operations Location`!="Nitinat Lake", !is.na(`Operations Location`), `Activity Type`=="Deposit to Holding")%>%
             group_by(`Activity Start Date`) %>% 
             summarize(n=sum(TotalCount)),
           aes(x=as.Date(`Activity Start Date`), y=n*10), stat="identity", fill="green", alpha=0.7) +
  scale_y_continuous(sec.axis = sec_axis(~./10, name="Swim-Ins/Angling")) +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d") +
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="Adult Coho", fill="Behaviour", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: Expanded adult Coho counts (large bars) and swim-ins (narrow black bars). Adult bar fill colours indicate behaviour (spawning=gray, holding=white), bar line colour indicates river segment (lower=pink, upper=blue). 

<br>

<br>

## Tributaries (River and Lake)

Live Coho were present in Campus, NoName and Worthless Creeks in 2023.

```{r}
tribs.sil %>% 
  filter(species=="Coho") %>% 
  group_by(trib_status, system) %>% 
  summarize(exp_ad_live = sum(`adults live / habitat seen (# Est Live)`),
            dead_adults = sum(`adults dead`)) %>%
  mutate(across(c(exp_ad_live:dead_adults), ~round(., 0))) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1), valign="middle", target=1) 
```

<br>

```{r}
ggplot() +
  geom_bar(data=nit.sil %>% 
             filter(species=="Coho") %>% 
             group_by(surveyNum, date, system) %>% 
             summarize(Spawning=sum(`adults # spawning`),
                       Holding = sum(`adults # holding`)) %>% 
             pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"), 
           aes(x=as.Date(date), y=count, fill=behaviour, colour=system), 
           stat="identity", position="stack", alpha=0.7, size=1, width=1) +
  geom_bar(data = tribs.sil %>% 
             filter(species=="Coho") %>% 
             group_by(system, date) %>% 
             summarize(Spawning=sum(`adults # spawning`),
                       Holding = sum(`adults # holding`)) %>% 
             pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"),
           aes(x=as.Date(date), y=count*1, colour=system, fill=behaviour), stat="identity",  alpha=0.8, size=1, width=1) +
  scale_y_continuous(sec.axis = sec_axis(~./1, name="Trib count")) +
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="mainstem count") +
  theme_bw()
```

Figure: Mainstem Nitinat (pink) and trib (blue/green) counts for Coho adults (raw).  

<br>

<br>

## AUC assessments

<br>

The information below is meant to assist with determining if AUC is an appropriate method, and whether to include/exclude certain surveys. 

<br>

Table: AUC math for systems receiving AUC estimate in `r analysis_year`

```{r}
escEstAUC %>%
  filter(AREA!="20", ShortSpecies=="CO", grepl("Nitinat", SystemName)) 
```

<br>

```{r}
ggplot() +
  geom_line(data=escEstAUC %>% 
              mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
              filter(ShortSpecies=="CO", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)), 
            aes(x=as.Date(dateplot), y=ExpAdultFishDays)) +
  geom_point(data=escEstAUC %>% 
               mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
               filter(ShortSpecies=="CO", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)), 
             aes(x=as.Date(dateplot), y=ExpAdultFishDays, fill=method, colour=method), shape=21, size=4) +
  scale_fill_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
  scale_colour_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
  labs(x="", y="Fish-days", fill="Survey method", colour="Survey method") +
  theme_bw()
```

Figure: AUC curve for Nitinat mainstem Coho. Note in 2023 this had already excluded the heli survey, but in future would likely also include the flight for reference. 

<br>

<br>


## Area 21-22 preliminary escapement estimates (AUC/PL+D) 

<br>

Table: Raw swim data (raw and expanded live and dead) for Coho.

```{r}
AUCdataTable %>% 
  filter(ShortSpecies=="CO") %>% 
  select(ShortSpecies,Section_AreaInspected, SDate, WaterTemperature, WaterClarity, LiveAdults, DeadAdults,LiveJacks,DeadJacks, ExpLiveAdults,
         ExpDeadAdults, ExpLiveJacks, ExpDeadJacks, OverallReliability, EstPctSeen) %>% 
  mutate(across(c(LiveAdults:ExpDeadJacks), ~round(., 0))) %>% 
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1:4), valign="middle", target=1) 
```

<br>

Table: Escapement estimates for each system.   

```{r}
escEstSpp %>% 
  filter(ShortSpecies=="CO", AREA!="20") %>% 
  select(-c(WatershedCode, contains("Recommend"), EstimateConfidence, OptimumEscapement, n, contains("Raw"), contains("FishDays"))) %>% 
  relocate(c(SystemName, AREA), .before=ShortSpecies) %>% 
  rename(FinalAdultEstimate = AdultNaturalReco,
         FinalJackEstimate = JackNaturalReco) %>% 
  mutate(across(FinalJackEstimate:FinalAdultEstimate, ~case_when(.<0 ~ 0,
                                                                 TRUE ~ .))) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1:4), valign="middle", target=1) 
```

<br>

### Estimate decision:

For 2023 estimate we went with PL+D as even the highest AUC estimate didn't cover the peak raw live count and timing/coverage wasn't great for AUC (no spawning observed). Expanded PL+D = 1364 adults + 154 jacks (1518 total). ADDED swim-ins and angled catch due to survey timing relative to swim ins this year (see graph above - swim ins were already in the hatchery by the time the PL+D count happened): 1092 adult swim-ins and 58 jacks, 16 angled adults and 3 angled jacks. Need to REMOVE trib fish (3 NoName, 4 Worthless=7 adults) because they were surveyed after the PL+D, and most fish on the PL+D count were not spawning - and on the Nov 12 mainstem swim there were few fish left in the lower mainstem so all had moved up higher/to tribs. With swim-ins and angling added and tribs removed, final escapement estimate is  1364+1092+16-7 = 2465 adults + 215 jacks (2680 total). See beginning section for commentary about expansions for omission of Reach 5-4 on Oct 5 survey due to bear activity.   *This is subject to change; see EscBatchHardCopy report for specific estimate abundance.*

<br>

<br>

## `r analysis_year` compared to historical run timing and abundance

```{r}
ggplot() +
  geom_point(data=nit.rtStWk%>%filter(species=="coho"),
             aes(x=stat_week, y=count, colour=plot_group, fill=plot_group, size=plot_group),
             shape=21, alpha=0.7) +
  scale_fill_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_colour_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_size_manual(breaks=waiver(), values=c(1.5,3.5)) +
  labs(x="Stat week", y="Live adult Coho", fill="Year:", colour="Year:", size="Year:") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.box = "horizontal")
```

Figure: Raw swim counts (blue) from this year compared to historical raw swim counts. Stat weeks indicate the month (8=August, 12=December) and week of momth (1=first week, 2=2nd week, etc.), e.g., 81=First week of August, 91=First week of September, etc. 

<br>

```{r}
ggplot()  +
  geom_bar(data=nit.escHistorical %>% filter(`Waterbody Name`=="NITINAT RIVER", `Species Qualified`=="CO"), 
           aes(x=`Analysis Year`, y=`Natural Adult Spawners`), stat="identity", colour="dodger blue", fill="dodger blue", alpha=0.8) +
  geom_bar(data=nit.escHistorical %>% filter(`Waterbody Name`=="NITINAT RIVER", `Species Qualified`=="CO"), 
           aes(x=`Analysis Year`, y=`Unspecified Return`), stat="identity", colour="gray80", fill="gray80", alpha=0.8) +  
  geom_bar(data=escEstSpp %>% 
             filter(ShortSpecies=="CO", AREA!="20", grepl("Nitinat", SystemName)) %>% 
             select(Year, SystemName, AdultNaturalReco) %>% 
             summarize(n=sum(AdultNaturalReco)), 
           aes(x=analysis_year, y=n), stat="identity", colour="red", fill="dodger blue", alpha=0.4) +    scale_x_continuous(breaks=seq(min(nit.escHistorical$`Analysis Year`), analysis_year, by=2)) +
  labs(x="Return Year", y="Coho spawners") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: `r analysis_year` preliminary adult Coho escapement estimate (red outline) relative to historical adult (blue) and unspecified (gray) escapement estimates. Gaps indicate years without estimates. 

<br>

<br>























# **Chum** 

<br>

Six snorkel surveys and one helicopter survey were conducted for Chum in 2023. The heli survey may have been slightly early for Chum. 

<br>

## Area 21-22 raw vs expanded counts

Counts are expanded for both % population surveyed and/or observer efficiency, depending on survey conditions.  

```{r}
ggplot() +
  geom_bar(data=AUCdataTable %>% 
             filter(ShortSpecies=="CM") %>% 
             pivot_longer(c(LiveAdults:TotalJacks,ExpLiveAdults:ExpDeadJacks), names_to="est_type", values_to="n") %>% 
             filter(est_type %in% c("LiveAdults", "ExpLiveAdults")), 
           aes(x=as.Date(SDate), y=n, colour=est_type, fill=est_type), stat="identity", position="dodge", alpha=0.5) +
  labs(x="", y="Adult Coho counts", fill="Expansion", colour="Expansion") +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d") +
  #scale_y_continuous(limits=c(0, max(AUCdataTable[AUCdataTable$ShortSpecies=="CO",]$ExpLiveAdults,na.rm=T))) +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1),
        legend.position = "bottom") +
  facet_wrap(~Section_AreaInspected, scales="free_y")
```

Figure: Live Adult Chum raw counts (blue) and counts expanded for % population and/or OE (pink).

<br>

## Counts & environmentals

```{r}
ggplot() +
  # Plot water data -------------
geom_ribbon(data=nit.water %>% 
              filter(year==analysis_year, month%in%c("Aug", "Sep", "Oct", "Nov")) %>%
              group_by(date2) %>% 
              summarize(min=min(Water.Level.m), max=max(Water.Level.m)), 
            aes(x=as.Date(date2), ymin=min*50, ymax=max*50), fill="dodger blue", alpha=0.5) +
  geom_line(data=nit.water %>% 
              filter(year==analysis_year, month%in%c("Aug", "Sep", "Oct", "Nov")) %>%
              group_by(date2) %>% 
              summarize(mean = mean(Water.Level.m)), 
            aes(x=as.Date(date2), y=mean*50), colour="dodger blue") +
  geom_bar(data=nit.sil %>% filter(species=="Chum") %>% group_by(date, type, `upper/lower (for Nitinat River only)`) %>% 
             summarize(n=sum(`adults live / habitat seen (# Est Live)`)), 
           aes(x=as.Date(date), y=n, group=type, 
               fill=`upper/lower (for Nitinat River only)`, 
               colour=`upper/lower (for Nitinat River only)`), 
           stat="identity", position="stack", alpha=0.7) +
  scale_y_continuous(sec.axis = sec_axis(~./5000, name="Staff gauge (m)")) +
  scale_x_date(date_breaks="7 day", date_labels="%b %d") +
  labs(x="", y="Expanded adult Chum", fill="Segment", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: Chinook counts (expanded adults) and water levels (blue line) 

<br>

<br>

## Behaviour & carcasses

```{r}
ggplot() +
  geom_bar(data=nit.sil %>% filter(species=="Chum") %>% group_by(date, type, `upper/lower (for Nitinat River only)`) %>% 
             summarize(Spawning=sum(`adults # spawning`),
                       Holding = sum(`adults # holding`)) %>% 
             pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"), 
           aes(x=as.Date(date), y=count, fill=behaviour, colour=`upper/lower (for Nitinat River only)`), 
           stat="identity", position="stack", alpha=0.7, size=1) +
  geom_point(data=nit.sil %>% filter(species=="Chum") %>% group_by(date) %>% 
               summarize(n=sum(`adults dead`)), 
             aes(x=as.Date(date), y=n*10), size=2, alpha=0.5) +
  geom_line(data=nit.sil %>% filter(species=="Chum") %>% group_by(date) %>% 
              summarize(n=sum(`adults dead`)), 
            aes(x=as.Date(date), y=n*10), 
            stat="identity", position="stack") +
  #scale_y_continuous(breaks=seq(0, 100000, by=2500), sec.axis = sec_axis(~./10, name="Carcasses")) +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d", limits=c(as.Date("2024-09-15"), as.Date("2024-11-15")))+
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="Spawning adult Chum", fill="Behaviour", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```
<br>

Figure: Expanded live adult Chum (bars) and carcasses (black line). Bar fill indicates behaviour (spawning=gray, holding=white), bar outline indicates river segment (upper=blue, lower=pink)

<br>

<br>

## Snorkel & swim-in counts

```{r}
ggplot() +
  geom_bar(data=nit.sil %>% 
             filter(species=="Chum") %>% 
             group_by(date, type, `upper/lower (for Nitinat River only)`) %>% 
             summarize(Spawning=sum(`adults # spawning`),
                       Holding = sum(`adults # holding`)) %>% 
             pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count") %>% 
             mutate(date = case_when(type=="Heli Flight" ~ as.Date("2024-10-23"),
                                     TRUE ~ date)), 
           aes(x=as.Date(date), y=count, fill=behaviour, colour=`upper/lower (for Nitinat River only)`), 
           stat="identity", position="stack", alpha=0.7, size=1, width=1) +
  geom_bar(data=nrh.cm %>% 
             filter(ParentActivityType=="Adult Capture", grepl("Swim Ins", InventoryLot), MaturityClassGroup=="Adult") %>% 
             group_by(`Activity Start Date`) %>% 
             summarize(n=sum(TotalCount)),
           aes(x=as.Date(`Activity Start Date`), y=n*10), fill="black", stat="identity", alpha=0.5, width=1) +
  scale_y_continuous(sec.axis = sec_axis(~./10, name="Swim ins")) +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d", limits=c(as.Date("2024-09-15"), as.Date("2024-11-15"))) +
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="Adult Chum", fill="Behaviour", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: Expanded adult Chum counts (large bars) and swim-ins (narrow black bars). Adult bar fill colours indicate behaviour (spawning=gray, holding=white), bar line colour indicates river segment (lower=pink, upper=blue).

<br>

<br>

## Tributaries (River and Lake)

Live chum were present in Campus and Hobiton Creek in 2023, and dead chum were noted in NoName Creek. Opportunistic surveys of Caycuse and Doobah found no chum. 

```{r}
tribs.sil %>% 
  filter(species=="Chum") %>% 
  group_by(system) %>% 
  summarize(exp_ad_live = sum(`adults live / habitat seen (# Est Live)`),
            dead_adults = sum(`adults dead`)) %>%
  mutate(across(c(exp_ad_live:dead_adults), ~round(., 0))) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1), valign="middle", target=1) 
```

<br>

```{r}
ggplot() +
  geom_bar(data=nit.sil %>% 
             filter(species=="Chum") %>% 
             group_by(surveyNum, date, system) %>% 
             summarize(Spawning=sum(`adults # spawning`),
                       Holding = sum(`adults # holding`)) %>% 
             pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"), 
           aes(x=as.Date(date), y=count, fill=behaviour, colour=system), 
           stat="identity", position="stack", alpha=0.7, size=1, width=1) +
  geom_bar(data = tribs.sil %>% 
             filter(species=="Chum") %>% 
             group_by(system, date) %>% 
             summarize(Spawning=sum(`adults # spawning`),
                       Holding = sum(`adults # holding`)) %>% 
             pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"),
           aes(x=as.Date(date), y=count*10, colour=system, fill=behaviour), stat="identity",  alpha=0.8, size=1, width=1) +
  scale_x_date(limits=c(as.Date("2024-09-15"), as.Date("2024-11-15"))) +
  scale_y_continuous(sec.axis = sec_axis(~./10, name="Trib count")) +
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="mainstem count") +
  theme_bw()
```

Figure: Mainstem Nitinat (pink) and trib (blue/green) counts for Chum adults (raw).  

<br>

<br>

## AUC assessments

<br>

The information below is meant to assist with determining if AUC is an appropriate method, and whether to include/exclude certain surveys. 

<br>

Table: AUC math for systems receiving AUC estimate in `r analysis_year`

```{r}
escEstAUC %>%
  filter(AREA!="20", ShortSpecies=="CM", grepl("Nitinat", SystemName)) 
```

<br>

```{r}
ggpubr::ggarrange(
  # THIS PLOT FOR ALL SURVEYS: 
  ggplot() +
    geom_line(data=escEstAUC %>% 
                mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
                filter(ShortSpecies=="CM", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)), 
              aes(x=as.Date(dateplot), y=ExpAdultFishDays)) +
    geom_point(data=escEstAUC %>% 
                 mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
                 filter(ShortSpecies=="CM", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)), 
               aes(x=as.Date(dateplot), y=ExpAdultFishDays, fill=method, colour=method), shape=21, size=4) +
    scale_fill_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
    scale_colour_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
    scale_x_date(date_breaks="5 day", date_labels="%b %d") +
    labs(x="", y="Fish-days", fill="Survey method", colour="Survey method") +
    theme_bw(),
  
  
  # THIS PLOT TO VISUALIZE ANY SURVEYS YOU WANT TO POTENTIALLY OMIT: 
  ggplot() +
    geom_line(data=escEstAUC %>% 
                mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
                filter(ShortSpecies=="CM", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)) %>% 
                filter(dateplot!="2024/10/24"), 
              aes(x=as.Date(dateplot), y=ExpAdultFishDays)) +
    geom_point(data=escEstAUC %>% 
                 mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
                 filter(ShortSpecies=="CM", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)) %>% 
                 filter(dateplot!="2024/10/24"), 
               aes(x=as.Date(dateplot), y=ExpAdultFishDays, fill=method, colour=method), shape=21, size=4) +
    scale_fill_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
    scale_colour_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
    scale_x_date(date_breaks="5 day", date_labels="%b %d") +
    labs(x="", y="Fish-days", fill="Survey method", colour="Survey method") +
    theme_bw(),
  
  nrow=2)
```

Figure: AUC curve for Nitinat mainstem Chum.  

<br>

<br>

## Area 21-22 preliminary escapement estimates (AUC) 

<br>

Table: Raw swim data (raw and expanded live and dead) for Chum.

```{r}
AUCdataTable %>% 
  filter(ShortSpecies=="CM") %>% 
  select(ShortSpecies,Section_AreaInspected, SDate, WaterTemperature, WaterClarity, LiveAdults, DeadAdults,LiveJacks,DeadJacks, ExpLiveAdults,
         ExpDeadAdults, ExpLiveJacks, ExpDeadJacks, OverallReliability, EstPctSeen) %>% 
  mutate(across(c(LiveAdults:ExpDeadJacks), ~round(., 0))) %>% 
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1:4), valign="middle", target=1) 
```

<br>

Table: Escapement estimates for each system.   

```{r}
escEstSpp %>% 
  filter(ShortSpecies=="CM", AREA!="20") %>% 
  select(-c(WatershedCode, contains("Recommend"), EstimateConfidence, OptimumEscapement, n, contains("Raw"), contains("FishDays"))) %>% 
  relocate(c(SystemName, AREA), .before=ShortSpecies) %>% 
  rename(FinalAdultEstimate = AdultNaturalReco,
         FinalJackEstimate = JackNaturalReco) %>% 
  mutate(across(FinalJackEstimate:FinalAdultEstimate, ~case_when(.<0 ~ 0,
                                                                 TRUE ~ .))) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1:4), valign="middle", target=1) 
```

<br>

### Estimate decision:

For 2023 used AUC with SL=11.5 days (mid value) to give expanded estimate of 27,530. Swim-ins need to be SUBTRACTED from this to account for fish that were likely double-counted: the peak live count occurred on the full system heli survey and therefore likely counted chum that later swam into the hatchery (see swim-in graph above). Need to remove trib fish in Worthless (17) as they were already dead on Nov 3 survey so were probably in Nitinat mainstem during the bulk of counts. Subtracting the swim-ins for accounting (6186) and tribs (17 in NoName) leaves 21,327 chum. Note: to make numbers line up between the SIL+AUC database and NuSEDS, SIL+AUC removals are 17+6186= See beginning section for commentary about expansions for omission of Reach 5-4 on Oct 5 survey due to bear activity. *This is subject to change; see EscBatchHardCopy report for specific estimate abundance.*

<br>

<br>

## `r analysis_year` compared to historical run timing

```{r}
ggplot() +
  geom_point(data=nit.rtStWk%>%filter(species=="chum"),
             aes(x=stat_week, y=count, colour=plot_group, fill=plot_group, size=plot_group),
             shape=21, alpha=0.7) +
  scale_fill_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_colour_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_size_manual(breaks=waiver(), values=c(1.5,3.5)) +
  labs(x="Stat week", y="Live adult Coho", fill="Year:", colour="Year:", size="Year:") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.box = "horizontal")
```

Figure: Raw swim counts (blue) from this year compared to historical raw swim counts. Stat weeks indicate the month (8=August, 12=December) and week of momth (1=first week, 2=2nd week, etc.), e.g., 81=First week of August, 91=First week of September, etc. 

<br>

```{r}
ggplot()  +
  geom_bar(data=nit.escHistorical %>% filter(`Waterbody Name`=="NITINAT RIVER", `Species Qualified`=="CM"), 
           aes(x=`Analysis Year`, y=`Natural Adult Spawners`), stat="identity", colour="dodger blue", fill="dodger blue", alpha=0.8) +
  geom_bar(data=nit.escHistorical %>% filter(`Waterbody Name`=="NITINAT RIVER", `Species Qualified`=="CM"), 
           aes(x=`Analysis Year`, y=`Unspecified Return`), stat="identity", colour="gray80", fill="gray80", alpha=0.8) +  
  geom_bar(data=escEstSpp %>% 
             filter(ShortSpecies=="CM", AREA!="20", grepl("Nitinat", SystemName)) %>% 
             select(Year, SystemName, AdultNaturalReco) %>% 
             summarize(n=sum(AdultNaturalReco)), 
           aes(x=analysis_year, y=n), stat="identity", colour="red", fill="dodger blue", alpha=0.4) +   scale_x_continuous(breaks=seq(min(nit.escHistorical$`Analysis Year`), analysis_year, by=2)) +
  labs(x="Return Year", y="Chum spawners") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: 2023 preliminary adult Chum escapement estimate (red outline) relative to historical adult (blue) and unspecified (gray) escapement estimates. There was no Chum estimate available in 1990. 

<br>

<br>




























# **Chinook**

Six snorkel surveys and one helicopter survey were conducted for Chinook in 2023. 

<br>

## Area 21-22 raw vs expanded counts

Counts are expanded for both % population surveyed and/or observer efficiency, depending on survey conditions.  

```{r}
ggplot() +
  geom_bar(data=AUCdataTable %>% 
             filter(ShortSpecies=="CN") %>% 
             pivot_longer(c(LiveAdults:TotalJacks,ExpLiveAdults:ExpDeadJacks), names_to="est_type", values_to="n") %>% 
             filter(est_type %in% c("LiveAdults", "ExpLiveAdults")), 
           aes(x=as.Date(SDate), y=n, colour=est_type, fill=est_type), stat="identity", position="dodge", alpha=0.5) +
  labs(x="", y="Adult Coho counts", fill="Expansion", colour="Expansion") +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1),
        legend.position = "bottom") +
  facet_wrap(~Section_AreaInspected, scales="free_y")
```

Figure: Live Adult Chinook raw counts (blue) and counts expanded for % population and/or OE (pink). 

<br>

## Counts & environmentals

```{r }
ggplot() +
  # Plot water data -------------
geom_ribbon(data=nit.water %>% 
              filter(year==analysis_year, month%in%c("Aug", "Sep", "Oct", "Nov")) %>%
              group_by(date2) %>% 
              summarize(min=min(Water.Level.m), max=max(Water.Level.m)), 
            aes(x=as.Date(date2), ymin=min*2000, ymax=max*2000), fill="dodger blue", alpha=0.5) +
  geom_line(data=nit.water %>% 
              filter(year==analysis_year, month%in%c("Aug", "Sep", "Oct", "Nov")) %>%
              group_by(date2) %>% 
              summarize(mean = mean(Water.Level.m)), 
            aes(x=as.Date(date2), y=mean*2000), colour="dodger blue") +
  geom_bar(data=nit.sil %>% filter(species=="Chinook") %>% group_by(date, type, `upper/lower (for Nitinat River only)`) %>% 
             summarize(n=sum(`adults live / habitat seen (# Est Live)`)), 
           aes(x=as.Date(date), y=n, group=type, 
               fill=`upper/lower (for Nitinat River only)`, colour=`upper/lower (for Nitinat River only)`), 
           stat="identity", position="stack", alpha=0.7) +
  labs(x="", y="Expanded adult Chinook") +
  scale_y_continuous(sec.axis = sec_axis(~./2000, name="Staff gauge (m)")) +
  scale_x_date(date_breaks="7 day", date_labels="%b %d") +
  labs(x="", Y="Live chinook", fill="Segment", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: Chinook counts (expanded adults) and water levels (blue line) 

<br>

<br>

## Behaviour & carcasses

```{r}
ggplot() +
  geom_bar(data=nit.sil %>% filter(species=="Chinook") %>% group_by(date, type, `upper/lower (for Nitinat River only)`) %>% 
             summarize(Spawning=sum(`adults # spawning`),
                       Holding = sum(`adults # holding`)) %>% 
             pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"), 
           aes(x=as.Date(date), y=count, fill=behaviour, colour=`upper/lower (for Nitinat River only)`), 
           stat="identity", position="stack", alpha=0.7, size=1) +
  geom_point(data=nit.sil %>% filter(species=="Chinook") %>% group_by(date) %>% 
               summarize(n=sum(`adults dead`)), 
             aes(x=as.Date(date), y=n), size=2, alpha=0.5) +
  geom_line(data=nit.sil %>% filter(species=="Chinook") %>% group_by(date) %>% 
              summarize(n=sum(`adults dead`)), 
            aes(x=as.Date(date), y=n)) +
  scale_y_continuous(breaks=seq(0,20000,by=2500)#, sec.axis = sec_axis(~./, name="Carcasses")
  ) +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d")+
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="Spawning adult Chinook", fill="Behaviour", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```
<br>

Figure: Expanded live adult Chinook (bars) and carcasses (black line). Bar fill indicates behaviour (spawning=gray, holding=white), bar outline indicates river segment (upper=blue, lower=pink).

<br>

<br>

## Snorkel & swim-in counts

```{r}
ggplot() +
  geom_bar(data=nit.sil %>% 
             filter(species=="Chinook") %>% 
             group_by(date, type, `upper/lower (for Nitinat River only)`) %>% 
             summarize(Spawning=sum(`adults # spawning`),
                       Holding = sum(`adults # holding`)) %>% 
             pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"), 
           aes(x=as.Date(date), y=count, fill=behaviour, colour=`upper/lower (for Nitinat River only)`), 
           stat="identity", position="stack", alpha=0.7, width=2, size=1) +
  geom_bar(data=nrh.cn %>% 
             filter(ParentActivityType=="Adult Capture", grepl("Swim Ins", InventoryLot), MaturityClassGroup=="Adult") %>% 
             group_by(`Activity Start Date`) %>% 
             summarize(n=sum(TotalCount)),
           aes(x=as.Date(`Activity Start Date`), y=n*1), fill="black", stat="identity", alpha=0.5) +
  scale_y_continuous(sec.axis = sec_axis(~./1, name="Swim ins")) +
  scale_x_date(date_breaks="7 day", date_labels = "%b %d") +
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="Adult Chinook", fill="Behaviour", colour="Segment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: Expanded adult Chinook counts (large bars) and swim-ins (narrow black bars). Adult bar fill colours indicate behaviour (spawning=gray, holding=white), bar line colour indicates river segment (lower=pink, upper=blue).

<br>

Total number of swim-ins this year is: `r nrh.cn %>% filter(ParentActivityType=="Adult Capture", grepl("Swim Ins", InventoryLot)) %>% summarize(sum(TotalCount))`, of which `r nrh.cn %>% filter(ParentActivityType=="Adult Capture", grepl("Swim Ins", InventoryLot), MaturityClass!="Jack") %>% summarize(sum(TotalCount))` were adults. 

<br>

<br>

## Tributaries (River and Lake)

```{r}
tribs.sil %>% 
  filter(species=="Chinook") %>% 
  group_by(system) %>% 
  summarize(exp_ad_live = sum(`adults live / habitat seen (# Est Live)`),
            dead_adults = sum(`adults dead`)) %>%
  mutate(across(c(exp_ad_live:dead_adults), ~round(., 0))) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1), valign="middle", target=1) 
```

<br>

```{r}
ggplot() +
  geom_bar(data=nit.sil %>% 
             filter(species=="Chinook") %>% 
             group_by(surveyNum, date, system) %>% 
             summarize(Spawning=sum(`adults # spawning`),
                       Holding = sum(`adults # holding`)) %>% 
             pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"), 
           aes(x=as.Date(date), y=count, fill=behaviour, colour=system), 
           stat="identity", position="stack", alpha=0.7, size=1, width=2) +
  geom_bar(data = tribs.sil %>% 
             filter(species=="Chinook") %>% 
             group_by(system, date) %>% 
             summarize(Spawning=sum(`adults # spawning`),
                       Holding = sum(`adults # holding`)) %>% 
             pivot_longer(cols=c(Spawning,Holding), names_to="behaviour", values_to="count"),
           aes(x=as.Date(date), y=count*1, colour=system, fill=behaviour), stat="identity",  alpha=0.8, size=1, width=1) +
  scale_y_continuous(sec.axis = sec_axis(~./1, name="Trib count")) +
  scale_fill_manual(breaks=waiver(), values=c("transparent", "gray")) +
  labs(x="", y="mainstem count") +
  theme_bw()
```

Figure: Mainstem Nitinat (pink) and trib (blue/green) counts for Chinook adults (raw).  

<br>

<br>

## AUC assessments

<br>

The information below is meant to assist with determining if AUC is an appropriate method, and whether to include/exclude certain surveys. 

<br>

Table: AUC math for systems receiving AUC estimate in `r analysis_year`

```{r}
escEstAUC %>%
  filter(AREA!="20", ShortSpecies=="CN", grepl("Nitinat", SystemName)) 
```

<br>

```{r}
ggpubr::ggarrange(
  # THIS PLOT FOR ALL SURVEYS: 
  ggplot() +
    geom_line(data=escEstAUC %>% 
                mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
                filter(ShortSpecies=="CN", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)), 
              aes(x=as.Date(dateplot), y=ExpAdultFishDays)) +
    geom_point(data=escEstAUC %>% 
                 mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
                 filter(ShortSpecies=="CN", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)), 
               aes(x=as.Date(dateplot), y=ExpAdultFishDays, fill=method, colour=method), shape=21, size=4) +
    scale_fill_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
    scale_colour_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
    scale_x_date(date_breaks="5 day", date_labels="%b %d") +
    labs(x="", y="Fish-days", fill="Survey method", colour="Survey method") +
    theme_bw()
  
  #,
  
  
  # # THIS PLOT TO VISUALIZE ANY SURVEYS YOU WANT TO POTENTIALLY OMIT (flight or swim): ---- not relevant for 2024
  # ggplot() +
  #   geom_line(data=escEstAUC %>% 
  #               mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
  #               filter(ShortSpecies=="CN", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)) %>% 
  #               filter(dateplot!="2024/10/23"), 
  #             aes(x=as.Date(dateplot), y=ExpAdultFishDays)) +
  #   geom_point(data=escEstAUC %>% 
  #                mutate(dateplot = lubridate::ymd(stringr::str_sub(DateRange, start=14, end=23))) %>%
  #                filter(ShortSpecies=="CN", AREA!="20", grepl("Nitinat River, Nitinat Lake", SystemName)) %>% 
  #                filter(dateplot!="2024/10/23"), 
  #              aes(x=as.Date(dateplot), y=ExpAdultFishDays, fill=method, colour=method), shape=21, size=4) +
  #   scale_fill_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
  #   scale_colour_manual(breaks=c("heli", "snorkel"), values=c("orange", "blue")) +
  #   scale_x_date(date_breaks="5 day", date_labels="%b %d") +
  #   labs(x="", y="Fish-days", fill="Survey method", colour="Survey method") +
  #   theme_bw(),
  
  #nrow=2
  
)
```

Figure: AUC curve for Nitinat mainstem Chinook.  

<br>

<br>

## Area 21-22 preliminary escapement estimates (AUC/PL+D) 

<br>

Table: Raw swim data (raw and expanded live and dead) for Chinook.

```{r}
AUCdataTable %>% 
  filter(ShortSpecies=="CN") %>% 
  select(ShortSpecies,Section_AreaInspected, SDate, WaterTemperature, WaterClarity, 
         LiveAdults, DeadAdults,LiveJacks,DeadJacks, ExpLiveAdults,
         ExpDeadAdults, ExpLiveJacks, ExpDeadJacks, OverallReliability, EstPctSeen) %>% 
  mutate(across(c(LiveAdults:ExpDeadJacks), ~round(., 0))) %>% 
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1:4), valign="middle", target=1) 
```

<br>

Table: Escapement estimate options (AUC/PL+D) for each system.   

```{r}
escEstSpp %>% 
  filter(ShortSpecies=="CN", AREA!="20") %>% 
  select(-c(WatershedCode, contains("Recommend"), EstimateConfidence, OptimumEscapement, n, 
            contains("Raw"), contains("FishDays"))) %>% 
  relocate(c(SystemName, AREA), .before=ShortSpecies) %>% 
  rename(FinalAdultEstimate = AdultNaturalReco,
         FinalJackEstimate = JackNaturalReco) %>% 
  mutate(across(FinalJackEstimate:FinalAdultEstimate, ~case_when(.<0 ~ 0,
                                                                 TRUE ~ .))) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1:4), valign="middle", target=1) 
```

<br>

### Estimate decision:   

For 2024, suggest that swim-ins be subtracted from the mid-point AUC estimate to get to ~10k spawners ultimately. NRH observations fall closer to ~10-11k, and we only saw about 9k adults on swims. The Hatchery also struggled to get broodstock this year and did not meet their brood targets, whereas last year they had no issue and the escapement estimated landed around ~15k. Therefore escapement this year should be considerably lower. 
Looking at the swim-in timing and spawning, spawning started up after most of the fish swam into the hatchery, which suggests some of the mainstem fish counted on Sept 19 (lower) and even Oct 1 (minimal spawning in the lower). Most swim-ins were into the hatchery by the Oct 11 survey which had a lot of spawning. I would recommend subtracting the swim-ins - even the late bump ~Oct 19 because i think the AUC curve covers this component within the area integrated under the curve.
Given this, if we took the mid point estimate of `r escEstSpp %>% filter(ShortSpecies=="CN", SystemName=="Nitinat River, Nitinat Lake") %>% group_by(AdultExpAUCMidValue_R) %>% summarize() %>% pull()` minus `r nrh.cn %>% filter(ParentActivityType=="Adult Capture", grepl("Swim Ins", InventoryLot), MaturityClass!="Jack") %>% summarize(sum(TotalCount)) %>% pull()` adult swim-ins leaves `r (escEstSpp %>% filter(ShortSpecies=="CN", SystemName=="Nitinat River, Nitinat Lake") %>% group_by(AdultExpAUCMidValue_R) %>% summarize() %>% pull()) - (nrh.cn %>% filter(ParentActivityType=="Adult Capture", grepl("Swim Ins", InventoryLot), MaturityClass!="Jack") %>% summarize(sum(TotalCount)) %>% pull())` natural adult spawners. 
Likewise, jacks would end up being `r (escEstSpp %>% filter(ShortSpecies=="CN", SystemName=="Nitinat River, Nitinat Lake") %>% group_by(JackExpAUCMidValue_R) %>% summarize() %>% pull()) - (nrh.cn %>% filter(ParentActivityType=="Adult Capture", grepl("Swim Ins", InventoryLot), MaturityClass=="Jack") %>% summarize(sum(TotalCount)) %>% pull())` natural jack spawners. 
*This is subject to change; see EscBatchHardCopy report for specific estimate abundance.*  

<br>

<br>

## `r analysis_year` compared to historical run timing and abundances

```{r}
ggplot() +
  geom_point(data=nit.rtStWk%>%filter(species=="chinook"),
             aes(x=stat_week, y=count, colour=plot_group, fill=plot_group, size=plot_group),
             shape=21, alpha=0.7) +
  scale_fill_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_colour_manual(breaks=waiver(), values=c("gray60", "dodger blue")) +
  scale_size_manual(breaks=waiver(), values=c(1.5,3.5)) +
  labs(x="Stat week", y="Live adult Chinook", fill="Year:", colour="Year:", size="Year:") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.box = "horizontal")
```

Figure: Raw swim counts (blue) from this year compared to historical raw swim counts. Stat weeks indicate the month (8=August, 12=December) and week of momth (1=first week, 2=2nd week, etc.), e.g., 81=First week of August, 91=First week of September, etc. 

<br>

```{r}
ggplot()  +
  geom_hline(data=nit.esc.goal %>% 
               filter(RP=="SMSY"), 
             aes(yintercept=Value)) +
  geom_bar(data=nit.escHistorical %>% 
             filter(`Waterbody Name`=="NITINAT RIVER", `Species Qualified`=="CK"), 
           aes(x=`Analysis Year`, y=`Natural Adult Spawners`), stat="identity", colour="dodger blue", fill="dodger blue", alpha=0.8) +
  geom_bar(data=nit.escHistorical %>% 
             filter(`Waterbody Name`=="NITINAT RIVER", `Species Qualified`=="CK"), 
           aes(x=`Analysis Year`, y=`Unspecified Return`), stat="identity", colour="gray80", fill="gray80", alpha=0.8) +  
  geom_bar(data=escEstSpp %>% 
             filter(ShortSpecies=="CN", AREA!="20", grepl("Nitinat", SystemName)) %>% 
             select(Year, SystemName, AdultNaturalReco) %>% 
             summarize(n=sum(AdultNaturalReco)), 
           aes(x=analysis_year, y=n), stat="identity", colour="red", fill="dodger blue", alpha=0.4) +  scale_x_continuous(breaks=seq(min(nit.escHistorical$`Analysis Year`), analysis_year, by=2)) +
  labs(x="Return year", y="Chinook spawners") +
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1))
```

Figure: `r analysis_year` preliminary adult Chinook escapement estimate (red outline) relative to historical adult (blue) and unspecified (gray) escapement estimates.

<br>

<br>

<br>














# **Pink** 

No consistent WCVI pink runs. 

## Area 21-22 preliminary escapement estimates 

<br>

Table: Escapement estimates for each system.   

```{r}
escEstSpp %>% 
  filter(ShortSpecies=="PK", AREA!="20") %>% 
  select(-c(WatershedCode, contains("Recommend"), EstimateConfidence, OptimumEscapement, n, contains("Raw"), contains("FishDays"))) %>% 
  relocate(c(SystemName, AREA), .before=ShortSpecies) %>% 
  rename(FinalAdultEstimate = AdultNaturalReco,
         FinalJackEstimate = JackNaturalReco) %>% 
  mutate(across(FinalJackEstimate:FinalAdultEstimate, ~case_when(.<0 ~ 0,
                                                                 TRUE ~ .))) %>%
  kableExtra::kbl(align="c") %>%
  kableExtra::kable_paper("hover", full_width=T, position = "center") %>%
  kableExtra::collapse_rows(columns=c(1:4), valign="middle", target=1) 
```







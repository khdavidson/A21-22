---
title: "Area 21/121 Fishery Summary"
date: 'Last update: `r format(Sys.time(), sep="_", "%Y-%m-%d %H:%M")`'
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_collapsed: false 
    toc_depth: 5
    number_sections: true
---

```{r setup, include=F}
# title: "part3-fisheries-knitable"

knitr::opts_chunk$set(echo=F,  message=F, warning=F)


# Load libraries ------------------
library(tidyverse)
# library(here)
# library(readxl)
# library(scales)
# library(plotly)
# library(bookdown)
# library(kableExtra)


# Load helpers ------------------
"%notin%" <- Negate("%in%")








# ============================ Load data ============================

# Biodata w results ----------------------
WCVIcrestBDWR <- readxl::read_excel(path=list.files(path=#"//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/PBS/Operations/SCA/SCD_Stad/WCVI/CHINOOK/WCVI_TERMINAL_RUN/Annual_data_summaries_for_RunRecons/CREST-BDWRcompile_base-files/2-Export-from-R/",
                                            here::here("data", "fisheries"),
                                          pattern="^R_OUT - Biological_Data_With_Results \\(.*\\) \\d{4}-\\d{4}\\.xlsx$", 
                                          full.names=T), 
                          sheet="CREST Biodata Compiled", guess_max = 10000) %>%
  mutate(yday = lubridate::yday(COLLECTION_DATE),
         LEGAL_STATUS = case_when(LENGTH_MM > 450 & LENGTH_MM < 800 ~ "LEGAL",
                                  LENGTH_MM <= 450 ~ "SUBLEGAL",
                                  LENGTH_MM >= 800 & yday%in%c(196:212) ~ "SUPERLEGAL",
                                  LENGTH_MM >= 800 & yday%notin%c(196:212) ~ "LEGAL"),
         isNit1 = case_when(grepl("Nitinat", RESOLVED_STOCK_ORIGIN) ~ paste0(`(R) Origin`, " ", RESOLVED_STOCK_ORIGIN),
                           !grepl("Nitinat", RESOLVED_STOCK_ORIGIN) & `(R) Origin`!="Unknown" ~ 
                             paste0(`(R) Origin`, " Other"),
                           !grepl("Nitinat", RESOLVED_STOCK_ORIGIN) & `(R) Origin`=="Unknown" ~ 
                             "Unknown Other"),
         isNit2 = case_when(grepl("Nitinat", isNit1) ~ "Nitinat (all)",
                            TRUE ~ "Other"),
         isNit3 = case_when(isNit1=="Hatchery Nitinat River" ~ "Nitinat (hatchery)",
                             TRUE ~ "Other")) %>% 
  filter(!(RESOLVED_STOCK_SOURCE=="DNA" & PROB_1<0.75)) %>%
  print()


# Catch estimates ----------------------
catEst <- readxl::read_excel(path="//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/Reg_Shares/FHM/SMCS/Salmon/FMCR_Fishery_Monitoring_Catch_Reporting/Recreational_CM/Catch_Data/SC Sport Catch Creel Sub-area Disposition (Master Do No Edit).xlsx", 
                             sheet="YTD") %>%
  filter(grepl("127|27|126|26|125|25|124|24|123|23|121|21|22|20", PFMA), YEAR>=2017, SPECIES=="CHINOOK SALMON") 




# CREST biodata joined to catch ------------------------
WCVIcrestBDWR.catEst.Nit <- left_join(WCVIcrestBDWR %>% 
                                        mutate_at("AREA", as.character) %>% 
                                        filter(SAMPLE_TYPE=="Sport", SPECIES==124, DISPOSITION=="Kept", LEGAL_STATUS=="LEGAL") %>% 
                                        group_by(YEAR, MONTH, AREA, isNit1, isNit2, isNit3) %>% 
                                        summarize(n_lvl1 = n()), 
                                      
                                      catEst %>% 
                                        mutate(PFMA = str_sub(PFMA, start=6, end=9)) %>%
                                        group_by(YEAR, PFMA, MONTH, DISPOSITION) %>% 
                                        summarize(Est = sum(ESTIMATE, na.rm=T),
                                                  SE = sum(STANDARD_ERROR, na.rm=T)) %>% 
                                        pivot_wider(names_from=DISPOSITION, values_from=c(Est, SE)) %>%
                                        select(YEAR, PFMA, MONTH, Est_Kept, `Est_Released Legal`),
                                      
                                      by=c("YEAR", 
                                           "MONTH", 
                                           "AREA" = "PFMA")) %>%
  full_join(data.frame(AREA=c("127", "27", "126", "26", "125", "25", "124", "24", "123", "23", "121", "22", "21", "20")),
            .,
            by="AREA") %>%
  print()




# ================================= Spatial data =================================

# DFO PFMA spatial files -----------------------
DFOcentroids <- read.csv(here::here("data", "fisheries", "spatial", "MRP_PFMA_spatial.csv")) %>%
  rename(`R (RC) Recovery PSC Location-L4`=PFMA_resolved)

pfmaPOLY <- rgdal::readOGR(dsn=here::here("data", "fisheries", "spatial"), layer="pfma1", verbose=F)
wcviPFMApoly <- pfmaPOLY[pfmaPOLY@data$STATAREA%in%c(20:27,121:127),]
pfma_sf <- sf::st_read(dsn=here::here("data", "fisheries", "spatial"), layer="pfma1")

creelSubAreaPOLY <- rgdal::readOGR(dsn=here::here("data", "fisheries", "spatial"), layer="Creel_Survey_Areas", verbose=F)
creelSubAreaPOLY_sf <- sf::st_read(dsn=here::here("data", "fisheries", "spatial"), layer="Creel_Survey_Areas")
creelSubAreaPOLY_sf <- sf::st_as_sf(x = creelSubAreaPOLY_sf,                         
                  coords = c("longitude", "latitude"),
                  crs = "+proj=utm +zone=10")
sfc = sf::st_transform(creelSubAreaPOLY_sf, crs = "+proj=longlat +datum=WGS84")
creelSubAreaPOLY_sfdf <- as.data.frame(sfc)
  
# Load "UScentroids" -----------------------
#source(here("scripts", "misc-helpers", "UScentroidCompile.R"))




# Join Catch Est data to Spatial data ------------------
wcviPFMA_NitCatEst <- left_join(pfma_sf,
                                
                               WCVIcrestBDWR.catEst.Nit %>% 
                                 group_by(YEAR, MONTH, AREA, isNit3) %>% 
                                 summarize(n_lvl3 = sum(n_lvl1, na.rm=T),
                                           Est_Kept = unique(Est_Kept),
                                           `Est_Released Legal` = unique(`Est_Released Legal`))  %>%
                                 group_by(YEAR, MONTH, AREA) %>% 
                                 mutate(AreaMonthTotalSamples = sum(n_lvl3, na.rm=T),
                                        propn_AreaMonth = n_lvl3/AreaMonthTotalSamples,
                                        estKeptByID = propn_AreaMonth*Est_Kept,
                                        NitOnly_forPlot = case_when(grepl("Other", isNit3) ~ Est_Kept-estKeptByID,
                                                                    TRUE ~ estKeptByID),
                                        NitOnly_forPlot = case_when(NitOnly_forPlot==0 ~ NA,
                                                                    TRUE ~ NitOnly_forPlot)) %>%
                                 filter(!is.na(YEAR),
                                        !(isNit3=="Other" & propn_AreaMonth<1 & estKeptByID!=NitOnly_forPlot)) %>%
                                 ungroup() %>%
                                 full_join(data.frame(AREA=c("127", "27", "126", "26", "125", "25", "124", "24", 
                                                             "123", "23", "121", "22", "21", "20")) %>%
                                             mutate(YEAR=rep(2023, nrow(.)),
                                                    MONTH=rep("May", nrow(.))),
                                           .,
                                           by=c("YEAR", "MONTH", "AREA")) %>%
                                 complete(., YEAR, MONTH, AREA) %>% 
                                 ungroup() %>%
                                 mutate_at("AREA", as.character) %>%
                                 mutate_at("AREA", as.integer), 
                               
                               by=c("STATAREA"="AREA")
)

```

<br> 



# Sport Fishery Biodata Results

<br>

## Assumptions and caveats

Definitions of natural, hatchery and unknown origin Chinook:

- A fish is assumed Natural origin if an otolith is returned as "Not Marked" and the adipose fin is intact. PBT is not currently considered as it is stock/facility-specific, and would likely only apply to very recent RYs (2022/2023). 
  + This assumption may not be appropriate in cases where hatchery fish are not thermally marked AND have no other identifier (probably rare? Perhaps US?).
  + Intact adipose fins *alone* are NOT evidence of a natural fish, and are considered "Unknown" origin unless accompanied by more data
- A fish is Hatchery origin if it has an adipose clip, a thermal mark, a CWT, and/or a PBT BY assignment (in recent years).
  + Note there are some rare cases of CWT wild-tagging programs in Yukon/Alaska, but these are not expected to show up in great numbers for Chinook. 
- A fish is Unknown origin if it has an intact adipose and no other mark or tag to inform further, e.g., destroyed or missing otolith, missing or lost tag, no  samples analyzed, etc.) 
- Stock ID is assigned in order of reliability: CWT > PBT > Otolith > GSI. This is determined in the CREST database but is currently under review (PBT may shift to be more reliable). 

<br>

The following caveats/assumptions must be taken into consideration when interpreting the recreational fishery data presented below:

- A genetic stock ID is only included if it has >= 75% certainty.
- It is assumed that biosampling is representative of kept catch, but this varies year to year as sample sizes are low. 
- Biosamples represent kept, legal catch and therefore do not represent the portions of populations <45cm or >80cm
  + Only legal sized Chinook are included here (> 45cm). Extra-legal (aka Super-legal) Chinook (>80cm) have also been excluded as current regs exclude these fish from the fishery.
- **No corrections are done to account for thermal mark issues from any facility in any given year. Missing  thermal marks would show up as "Not Marked" and bias results towards reporting more natural-origin Chinook than may in fact exist.**
- No GSI results are available prior to 2020 in Area 21/121. 
- Considerable changes to the recreational fishery along SWVI came into effect around 2018-2019 so comparisons across these years should be careful. 
- Unknown stock IDs were excluded from the following analyses. Results are expressed as regional population IDs as a proportion of known samples. 

<br>

**Please keep in mind sample rates for these areas are below ideal levels, so conclusions drawn should be very careful. Please read the last section that lays out the sample rates (i.e., % of kept catch sampled) by month and year!"**

<br>

<br>

## WCVI: Nitinat catch across all WCVI PFMAs (27-20 and offshore) 

Proportion of legal sized biosamples that return as Nitinat in each Area applied to kept, legal catch estimates for 2017-2023 (note 2023 biodata still incomplete). 

<br>

### All Nitinat-origin across WCVI (Hatchery Nit + Natural Nit)

Applying stock comp %s from creel biosamples to estimated catch by Month/Area/Year. Note 2023 and 2024 are incomplete as of January 2025. 

```{r nitHeat, out.width='800px', out.height='1200px', fig.cap='Kept catch estimates of legal size (>45cm and <=80cm) Nitinat-origin Chinook across WCVI PFMAs, organized from north (PFMA 127) to south (PFMA 20). Estimates calculated by applying the proportion of Nitinat chinook detected in creel biosamples to total year-month-area catch estimates. Interactive plot; hover over data points on heat map to see sample sizes and catch estimates. **NOTE 2023 and 2024 samples are incomplete as of January 2025.**'}

# Heatmap of all WCVI Nitinat catch estimates all years ------------------


# pdf(file = here::here("outputs", "figures", "WCVI Nitinat catch estimate heatmap 2017-2023.pdf"),   
#     width = 11, # The width of the plot in inches
#     height = 8.5) # The height of the plot in inches



plotly::ggplotly(
  ggplot(data = WCVIcrestBDWR.catEst.Nit %>% 
           group_by(YEAR, MONTH, AREA, isNit2) %>% 
           summarize(n_lvl2 = sum(n_lvl1, na.rm=T),
                     Est_Kept = unique(Est_Kept),
                     `Est_Released Legal` = unique(`Est_Released Legal`))  %>%
           group_by(YEAR, MONTH, AREA) %>% 
           mutate(AreaMonthTotalSamples = sum(n_lvl2, na.rm=T),
                  propn_AreaMonth = n_lvl2/AreaMonthTotalSamples,
                  estKeptByID = propn_AreaMonth*Est_Kept,
                  NitOnly_forPlot = case_when(grepl("Other", isNit2) ~ Est_Kept-estKeptByID,
                                              TRUE ~ estKeptByID),
                  NitOnly_forPlot = case_when(NitOnly_forPlot==0 ~ NA,
                                              TRUE ~ NitOnly_forPlot)) %>%
           filter(!is.na(YEAR),
                  !(grepl("Other", isNit2) & propn_AreaMonth<1 & estKeptByID!=NitOnly_forPlot)) %>%
           ungroup() %>%
           full_join(data.frame(AREA=c("127", "27", "126", "26", "125", "25", "124", "24", "123", "23", "121", "22", "21", "20")) %>%
                       mutate(YEAR=rep(2023, nrow(.)),
                              MONTH=rep("May", nrow(.))),
                     .,
                     by=c("YEAR", "MONTH", "AREA")) %>%
           complete(., YEAR, MONTH, AREA)) +
    # geom_rect(data=WCVIcrestBDWR.catEst.Nit %>% 
    #           filter(YEAR %in% c(2023, 2024)) %>%
    #           group_by(YEAR) %>%
    #           summarize(unique(YEAR)), 
    #         aes(), fill="red", xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf, alpha=0.1) +
    geom_tile(aes(y=AREA, x=factor(MONTH, levels=month.name), fill=NitOnly_forPlot, colour=NitOnly_forPlot,
                  text=paste("Estimated # kept Nitinat CN=", round(estKeptByID,0), "\nBased on # confirmed biosamples, n=", n_lvl2)), 
              stat="identity", alpha=0.9) +
    paletteer::scale_fill_paletteer_c("viridis::plasma", na.value = alpha("white", 0.1)) +
    paletteer::scale_colour_paletteer_c("viridis::plasma", na.value = alpha("gray80", 0.3)) +
    scale_x_discrete(limits = c("May", "June", "July", "August", "September"), 
                     labels=c("May", "Jun", "Jul", "Aug", "Sept")) +
    scale_y_discrete(limits = rev(c("127", "27", "126", "26", "125", "25", "124", "24", "123", "23", "121", "22", "21", "20"))) +
    labs(x="", y="Area", fill="Estimated # kept legal \nNitinat-origin Chinook", 
         colour="Estimated # kept legal \nNitinat-origin Chinook") +
    theme_bw() +
    facet_wrap(~YEAR, ncol=2, strip.position = "right") + 
    theme(axis.title = element_text(face="bold", size=10),
          axis.text.y = element_text(colour="black", size=8),
          axis.text.x = element_text(colour="black", size=9),
          legend.title = element_text(face="bold", size=12),
          legend.text = element_text(size=8),
          #legend.key.size = unit(5, "mm"),
          #legend.position = "bottom",
          #legend.direction = "horizontal",
          strip.text = element_text(size=10)),
  
  tooltip = c("AREA", "MONTH", "text")
)

#dev.off()
```


<br>

<br>


### Hatchery Nitinat across WCVI 

#### 2023 Catch estimate map

```{r wcvi23, out.width='1000px', out.height='600px', fig.cap='Kept catch estimates of legal sized (>45cm and <=80cm) Nitinat Hatchery Chinook across WCVI in 2023. Estimates calculated by applying the proportion of Nitinat chinook detected in creel biosamples to total year-month-area catch estimates. **NOTE 2023 and 2024 samples are incomplete as of January 2025.**'}

#pdf(file = here::here("outputs", "figures", "WCVI Nitinat catch estimate map 2023.pdf"),   
#    width = 11, # The width of the plot in inches
#    height = 8.5) # The height of the plot in inches

#htmltools::save_html(
#plotly::ggplotly(
ggplot() +
  geom_sf(data=wcviPFMA_NitCatEst %>% 
            sf::st_set_crs(.,"WGS84") %>% 
            filter(YEAR=="2023") %>%
            filter(MONTH%in%c("May", "June", "July", "August", "September")), 
          aes(fill=round(NitOnly_forPlot, 0), 
              text=paste("Estimated # kept Nitinat CN=", round(NitOnly_forPlot,0), 
                         "\nBased on # confirmed biosamples, n=", n_lvl3)), 
          colour=alpha("gray60", 0.5), linewidth=0.5) +
  paletteer::scale_fill_paletteer_c("viridis::plasma", na.value = NA) +
  geom_sf(data=rnaturalearth::ne_countries(type="countries", scale="large", returnclass="sf"), 
          colour="transparent", fill="black") +
  coord_sf(crs="+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0", xlim=c(-129, -123), ylim=c(51.5, 48)) +
  labs(fill="Estimated number of kept legal \nHatchery Nitinat Chinook 2023") +
  theme_bw() +
  theme(axis.text = element_blank(),
        legend.title = element_text(face="bold", size=10),
        legend.text = element_text(size=9),
        legend.position = c(0.85, 0.2),
        panel.grid.major = element_blank(),
        panel.background = element_rect(fill="white")) +
  facet_wrap(~factor(MONTH, levels=c("May", "June", "July", "August", "September", ordered=T)))
#,
#  tooltip = c("text")
#),

#file = here::here("outputs", "figures", "WCVI Nitinat catch estimate map 2023.html")
#)


#dev.off()
```

<br>

#### 2022 Catch estimate map

```{r wcvi22, out.width='1000px', out.height='600px', fig.cap='Kept catch estimates of legal sized (>45cm and <=80cm) Nitinat Hatchery Chinook across WCVI in 2022. Estimates calculated by applying the proportion of Nitinat chinook detected in creel biosamples to total year-month-area catch estimates.'}
#pdf(file = here::here("outputs", "figures", "WCVI Nitinat catch estimate map 2022.pdf"),   
#    width = 11, # The width of the plot in inches
#    height = 8.5) # The height of the plot in inches

#plotly::ggplotly(
ggplot() +
  geom_sf(data=wcviPFMA_NitCatEst %>% 
            sf::st_set_crs(.,"WGS84") %>% 
            filter(YEAR=="2022") %>%
            filter(MONTH%in%c("May", "June", "July", "August", "September")), 
          aes(fill=round(NitOnly_forPlot, 0), 
              text=paste("Estimated # kept Nitinat CN=", round(NitOnly_forPlot,0), 
                         "\nBased on # confirmed biosamples, n=", n_lvl3)), 
          colour=alpha("gray60", 0.5), linewidth=0.5) +
  paletteer::scale_fill_paletteer_c("viridis::plasma", na.value = NA) +
  geom_sf(data=rnaturalearth::ne_countries(type="countries", scale="large", returnclass="sf"), 
          colour="transparent", fill="black") +
  coord_sf(crs="+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0", xlim=c(-129, -123), ylim=c(51.5, 48)) +
  labs(fill="Estimated number of kept legal \nHatchery Nitinat Chinook 2022") +
  theme_bw() +
  theme(axis.text = element_blank(),
        legend.title = element_text(face="bold", size=10),
        legend.text = element_text(size=9),
        legend.position = c(0.85, 0.2),
        panel.grid.major = element_blank(),
        panel.background = element_rect(fill="white")) +
  facet_wrap(~factor(MONTH, levels=c("May", "June", "July", "August", "September", ordered=T)))
#,
#  tooltip = c("text")
#)

#dev.off()
```

<br>

#### 2021 Catch estimate map

```{r wcvi21, out.width='1000px', out.height='600px', fig.cap='Kept catch estimates of legal sized (>45cm and <=80cm) Nitinat Hatchery Chinook across WCVI in 2021. Estimates calculated by applying the proportion of Nitinat chinook detected in creel biosamples to total year-month-area catch estimates.'}


#pdf(file = here::here("outputs", "figures", "WCVI Nitinat catch estimate map 2021.pdf"),   
#    width = 11, # The width of the plot in inches
#    height = 8.5) # The height of the plot in inches

#plotly::ggplotly(
ggplot() +
  geom_sf(data=wcviPFMA_NitCatEst %>% 
            sf::st_set_crs(.,"WGS84") %>% 
            filter(YEAR=="2021") %>%
            filter(MONTH%in%c("May", "June", "July", "August", "September")), 
          aes(fill=round(NitOnly_forPlot, 0), 
              text=paste("Estimated # kept Nitinat CN=", round(NitOnly_forPlot,0), 
                         "\nBased on # confirmed biosamples, n=", n_lvl3)), 
          colour=alpha("gray60", 0.5), linewidth=0.5) +
  paletteer::scale_fill_paletteer_c("viridis::plasma", na.value = NA) +
  geom_sf(data=rnaturalearth::ne_countries(type="countries", scale="large", returnclass="sf"), 
          colour="transparent", fill="black") +
  coord_sf(crs="+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0", xlim=c(-129, -123), ylim=c(51.5, 48)) +
  labs(fill="Estimated number of kept legal \nHatchery Nitinat Chinook 2021") +
  theme_bw() +
  theme(axis.text = element_blank(),
        legend.title = element_text(face="bold", size=10),
        legend.text = element_text(size=9),
        legend.position = c(0.85, 0.2),
        panel.grid.major = element_blank(),
        panel.background = element_rect(fill="white")) +
  facet_wrap(~factor(MONTH, levels=c("May", "June", "July", "August", "September", ordered=T)))
#,
#  tooltip = c("text")
#)

#dev.off()
```

<br>

#### 2020 Catch estimate map

```{r wcvi20, out.width='1000px', out.height='600px', fig.cap='Kept catch estimates of legal sized (>45cm and <=80cm) Nitinat Hatchery Chinook across WCVI in 2020. Estimates calculated by applying the proportion of Nitinat chinook detected in creel biosamples to total year-month-area catch estimates.'}


#pdf(file = here::here("outputs", "figures", "WCVI Nitinat catch estimate map 2020.pdf"),   
#    width = 11, # The width of the plot in inches
#    height = 8.5) # The height of the plot in inches

#plotly::ggplotly(
ggplot() +
  geom_sf(data=wcviPFMA_NitCatEst %>% 
            sf::st_set_crs(.,"WGS84") %>% 
            filter(YEAR=="2020") %>%
            filter(MONTH%in%c("May", "June", "July", "August", "September")), 
          aes(fill=round(NitOnly_forPlot, 0), 
              text=paste("Estimated # kept Nitinat CN=", round(NitOnly_forPlot,0), 
                         "\nBased on # confirmed biosamples, n=", n_lvl3)), 
          colour=alpha("gray60", 0.5), linewidth=0.5) +
  paletteer::scale_fill_paletteer_c("viridis::plasma", na.value = NA) +
  geom_sf(data=rnaturalearth::ne_countries(type="countries", scale="large", returnclass="sf"), 
          colour="transparent", fill="black") +
  coord_sf(crs="+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0", xlim=c(-129, -123), ylim=c(51.5, 48)) +
  labs(fill="Estimated number of kept legal \nHatchery Nitinat Chinook 2020") +
  theme_bw() +
  theme(axis.text = element_blank(),
        legend.title = element_text(face="bold", size=10),
        legend.text = element_text(size=9),
        legend.position = c(0.85, 0.2),
        panel.grid.major = element_blank(),
        panel.background = element_rect(fill="white")) +
  facet_wrap(~factor(MONTH, levels=c("May", "June", "July", "August", "September", ordered=T)))
#,
#  tooltip = c("text")
#)

#dev.off()
```




















## Area 21/121 Heatmaps (Regional IDs)

```{r echo=T, message=F, warning=F, eval=F}
# ================= Region-level monthly % composition =================
area21offshoreREGION.BDWR <- crestBDWR %>% 
  filter(AREA %in% c("21", "121"), SAMPLE_TYPE=="Sport", SPECIES==124, DISPOSITION=="Kept", LEGAL_STATUS=="LEGAL", 
         `(R) RESOLVED ORIGIN-REGION ID`%notin%c("Unknown NA", "Unknown Unknown (<75% GSI assignment)")) %>% 
  group_by(YEAR, MONTH, AREA, `(R) RESOLVED ORIGIN-REGION ID`) %>% 
  summarize(n = n()) %>% 
  group_by(YEAR, MONTH, AREA) %>%
  mutate(AreaMonthSampleTotal = sum(n),
         AreaPropnMonthlySamples=n/AreaMonthSampleTotal) 



# ================= Stock-level monthly % composition =================
# FOCUS ON NITINAT SPECIFICALLY
# 1. Summarize biosampling results and group as Nitinat, Non-Nitinat, and Unknown -----------------
area21offshoreSTOCK.BDWR <- crestBDWR %>% 
  filter(AREA %in% c("21", "121"), SAMPLE_TYPE=="Sport", SPECIES==124, DISPOSITION=="Kept", LEGAL_STATUS=="LEGAL", `(R) RESOLVED ORIGIN-STOCK ID`%notin%c("Unknown NA", "Unknown Unknown (<75% GSI assignment)")) %>% 
  mutate(isNitinat = case_when(grepl("Nitinat", `(R) RESOLVED ORIGIN-STOCK ID`) ~ `(R) RESOLVED ORIGIN-STOCK ID`,
                               !grepl("Nitinat", `(R) RESOLVED ORIGIN-STOCK ID`) & `(R) Origin`!="Unknown" ~ 
                                 paste0(`(R) Origin`, " ", "Non-Nitinat"),
                               !grepl("Nitinat", `(R) RESOLVED ORIGIN-STOCK ID`) & `(R) Origin`=="Unknown" ~ 
                                 "Unknown Non-Nitinat")) %>% 
  group_by(YEAR, AREA, MONTH, isNitinat) %>% 
  summarize(n = n()) %>% 
  group_by(YEAR, MONTH, AREA) %>%
  mutate(AreaMonthSampleTotal = sum(n),
         PropnMonthlySamplesNitinat=n/AreaMonthSampleTotal)  

# 2. Join Biodata composition to catch and calculate # caught by ID -----------------
a21.121catchComp <- left_join(area21offshoreSTOCK.BDWR,
                              catEst %>% 
                                rename(AREA=PFMA) %>% 
                                mutate(AREA = str_sub(AREA, start=6, end=9)) %>%
                                group_by(YEAR, AREA, MONTH, DISPOSITION) %>% 
                                summarize(Est = sum(ESTIMATE),
                                          `%SE` = sum(PERCENT_STANDARD_ERROR)) %>% 
                                pivot_wider(names_from=DISPOSITION, values_from=c(Est, `%SE`)) %>%
                                select(YEAR, AREA, MONTH, Est_Kept, `%SE_Kept`, `Est_Released Legal`, `%SE_Released Legal`, 
                                       `Est_Released Sub-legal`, `%SE_Released Sub-legal`),
                              by=c("AREA", "YEAR", "MONTH")) %>% 
  mutate(estKeptByID = PropnMonthlySamplesNitinat*Est_Kept) 
```


```{r a21comp, out.width='1300px', out.height='500px', fig.align='left', fig.cap='Region-level ID of Chinook caught in Area 21. Data are expressed as a proportion of the number of biological samples collected each month. Results are from creel survey data and therefore only represent legal (<45cm, >80cm), kept catch. Gray shaded area indicates years with no GSI sampling, in which case Natural-origin stock ID is not possible. Red shading indicates 2023 results are incomplete.', eval=F}

# Region rollup stock comp --------------------

# AREA 21
ggplotly(
  ggplot() +
    geom_ribbon(data=area21offshoreREGION.BDWR %>%
                  filter(AREA=="21", YEAR%in%c(2017:2019)),
                aes(ymin="Unknown SWVI", ymax="Natural (assumed) California", x=factor(MONTH, levels=month.name)), 
                fill="gray60", colour="gray60", alpha=0.1, size=100) +
    geom_ribbon(data=area21offshoreREGION.BDWR %>%
                  filter(AREA=="21", YEAR==2023),
                aes(ymin="Unknown SWVI", ymax="Hatchery California", x=factor(MONTH, levels=month.name)), 
                fill="red", colour="red", alpha=0.1, size=100) +
    geom_point(data=area21offshoreREGION.BDWR%>%filter(AREA=="21"),
               aes(x=factor(MONTH, levels=month.name), y=`(R) RESOLVED ORIGIN-REGION ID`,  fill=AreaPropnMonthlySamples, text=paste0("n=",n)),
               shape=22, size=3.5, colour="transparent") +
    scale_fill_viridis_b(breaks=seq(0,1,by=0.1), labels=scales::percent) +
    labs(x="", y="", fill="Proportion of biosamples \nby month for Area 21") +
    facet_wrap(~YEAR, nrow=1) +
    theme_bw() +
    theme(axis.text.x = element_text(angle=45, hjust=1),
          legend.title =  element_text(face="bold")),
  tooltip = c("MONTH", "(R) RESOLVED ORIGIN-REGION ID", "AreaPropnMonthlySamples", "text")) 
```

<br>

<br>

```{r a121comp, out.width='1300px', out.height='500px', fig.cap='Region-level ID of Chinook caught in Area 121. Data are expressed as a proportion of the number of biological samples collected each month. Results are from creel survey data and therefore only represent legal (<45cm, >80cm), kept catch. Gray shaded area indicates years with no GSI sampling, in which case Natural-origin stock ID is not possible. Red shading indicates 2023 results are incomplete.', eval=F}

# AREA 121

ggplotly(
  ggplot() +
geom_ribbon(data=a21.121catchComp %>%
                    filter(AREA=="21", YEAR%in%c(2017:2019)),
                  aes(ymin=-Inf, ymax=Inf, 
                      x=factor(MONTH, levels=month.name)), 
                  fill="gray60", colour="gray60", alpha=0.1, size=100) +
    geom_ribbon(data=area21offshoreREGION.BDWR %>%
                  filter(AREA=="121", YEAR==2023),
                aes(x=factor(MONTH, levels=month.name),#(c("June","July", "August", "September"), month.name), 
                    ymin="Unknown SWVI", ymax="Hatchery California"), 
                fill="red", colour="red", alpha=0.1, size=100) +
    geom_point(data=area21offshoreREGION.BDWR%>%filter(AREA=="121"), 
               aes(x=factor(MONTH, levels=month.name), y=`(R) RESOLVED ORIGIN-REGION ID`,  fill=AreaPropnMonthlySamples, text=paste0("n=",n)),
               shape=22, size=3.5, colour="transparent") +
    scale_fill_viridis_b(breaks=seq(0,1,by=0.1), labels=scales::percent) +
    labs(x="", y="", fill="Proportion of biosamples \nby month for Area 121") +
    facet_wrap(~YEAR, nrow=1) +
    theme_bw() +
    theme(axis.text.x = element_text(angle=45, hjust=1)),
  tooltip = c("MONTH", "(R) RESOLVED ORIGIN-REGION ID", "AreaPropnMonthlySamples", "text")) 
```

<br>

## Area 21/121 Heatmaps (Nitinat/stock-specific)

```{r a21comp-NIT, out.width='1300px', out.height='500px', fig.align='left', fig.cap='ID of Chinook caught in Area 21 by Nitinat, non-Nitinat, or Unknown. The proportion of the number of biological samples collected each month by ID group was applied to kept, legal Chinook catch estimates. Results are from creel survey data and therefore only represent legal (<45cm, >80cm), kept catch. Gray shaded area indicates years with no GSI sampling, in which case Natural-origin stock ID is less certain. Red shading indicates 2023 results are incomplete.', eval=F}

# Region rollup stock comp --------------------

# AREA 21
ggplotly(
  ggplot() +
      geom_ribbon(data=a21.121catchComp %>%
                    filter(AREA=="21", YEAR%in%c(2017:2019)),
                  aes(ymin=-Inf, ymax=Inf, 
                      x=factor(MONTH, levels=month.name)), 
                  fill="gray60", colour="gray60", alpha=0.1, size=100) +
      geom_ribbon(data=a21.121catchComp %>%
                    filter(AREA=="21", YEAR==2023),
                  aes(ymin="Unknown Non-Nitinat", ymax="Hatchery Nitinat River", x=factor(MONTH, levels=month.name)), 
                  fill="red", colour="red", alpha=0.1, size=100) +
    geom_point(data=a21.121catchComp%>%filter(AREA=="21"),
               aes(x=factor(MONTH, levels=month.name), y=isNitinat, fill=estKeptByID, text=paste0("n=",n)),
               shape=22, size=3.5, colour="transparent") +
    scale_fill_viridis_b(breaks=seq(0,1000,by=100)) +
    labs(x="", y="", fill="Kept, legal Chinook \nby stock ID group for Area 21") +
    facet_wrap(~YEAR, nrow=1) +
    theme_bw() +
    theme(axis.text.x = element_text(angle=45, hjust=1),
          legend.title =  element_text(face="bold")),
  tooltip = c("MONTH", "isNitinat", "estKeptByID", "text")) 
```

<br>

Above figure in table format: 

```{r, eval=F}
a21.121catchComp %>% 
  filter(AREA=="21") %>% 
  kbl(align="c", caption="Estimates and % Standard Error of Chinook caught and released by size status (legal/sublegal) in Area 21 and 121. Final column 'estKeptByID' multiplies the stock ID % from PropnMonthlySamplesNitinat by total kept monthly catch in Est_Kept.") %>%
  kable_paper("hover", full_width=T, position = "center")
```

<br>

```{r a121comp-NIT, out.width='1300px', out.height='500px', fig.align='left', fig.cap='ID of Chinook caught in Area 121 by Nitinat, non-Nitinat, or Unknown. The proportion of the number of biological samples collected each month by ID group was applied to kept, legal Chinook catch estimates. Results are from creel survey data and therefore only represent legal (<45cm, >80cm), kept catch. Gray shaded area indicates years with no GSI sampling, in which case Natural-origin stock ID is less certain. Red shading indicates 2023 results are incomplete. KD note: I find >10k caught in July 2017 surprising, but I confirmed this is the official estimate out of CREST. Most (9889) were from 121B, of which most were adipose-clipped (~6600).', eval=F}

# Region rollup stock comp --------------------

# AREA 21
ggplotly(
  ggplot() +
    geom_ribbon(data=a21.121catchComp %>%
                  filter(AREA=="21", YEAR%in%c(2017:2019)),
                aes(ymin=-Inf, ymax=Inf, 
                    x=factor(MONTH, levels=month.name)), 
                fill="gray60", colour="gray60", alpha=0.1, size=100) +
    geom_ribbon(data=a21.121catchComp %>%
                  filter(AREA=="21", YEAR==2023),
                aes(ymin="Unknown Non-Nitinat", ymax="Hatchery Nitinat River", x=factor(MONTH, levels=month.name)), 
                fill="red", colour="red", alpha=0.1, size=100) +
    geom_point(data=a21.121catchComp%>%filter(AREA=="121"),
               aes(x=factor(MONTH, levels=month.name), y=isNitinat, fill=estKeptByID, text=paste0("n=",n)),
               shape=22, size=3.5, colour="transparent") +
    scale_fill_viridis_b() +
    labs(x="", y="", fill="Kept, legal Chinook \nby stock ID group for Area 121") +
    facet_wrap(~YEAR, nrow=1) +
    theme_bw() +
    theme(axis.text.x = element_text(angle=45, hjust=1),
          legend.title =  element_text(face="bold")),
  tooltip = c("MONTH", "isNitinat", "estKeptByID", "text")) 
```

<br>

Above figure in table format: 

```{r, eval=F}
a21.121catchComp %>% 
  filter(AREA=="121") %>% 
  kbl(align="c", caption="Estimates and % Standard Error of Chinook caught and released by size status (legal/sublegal) in Area 121 and 121. Final column 'estKeptByID' multiplies the stock ID % from PropnMonthlySamplesNitinat by total kept monthly catch in Est_Kept.") %>%
  kable_paper("hover", full_width=T, position = "center")
```

<br>

## Sample Rate

Sample rate is simply the number of samples collected divided by the estimated kept catch, calculated for each month/area/year. It can give an indication of sampling effort to interpret catch trends. 

```{r include=F}
samp_Rate <- left_join(catEst %>% 
                         filter(DISPOSITION=="Kept", SPECIES=="CHINOOK SALMON") %>%
                         group_by(YEAR, MONTH, PFMA) %>%
                         summarize(TotalCatch = sum(ESTIMATE, na.rm=T)) %>%
                         arrange(YEAR, PFMA, match(MONTH, month.name)) %>%
                         mutate(PFMA = str_sub(PFMA, 6,9)) ,
                       WCVIcrestBDWR %>% 
                         filter(SAMPLE_TYPE=="Sport", SPECIES==124, DISPOSITION=="Kept", LEGAL_STATUS=="LEGAL") %>% 
                         group_by(YEAR, MONTH, AREA) %>% 
                         summarize(n = n()) ,
                       by=c("PFMA"="AREA", "YEAR", "MONTH")) %>%
  mutate(SampleRate = round(n/TotalCatch,3)) %>%
  print()
```


```{r sampRateFig, fig.cap='Sample rate of Chinook kept legal catch in Area 21 and 121 (i.e., % of kept legal catch sampled each month). Note that September 2018 sample rate was removed as it was highly uncertain. Sample rate represents the number of samples taken compared to CREST catch point estimates and does not take into account catch uncertainty.'}

ggplot(data=samp_Rate %>%
         filter(MONTH%in%c("May", "June", "July", "August", "September")), 
       aes(x=factor(MONTH, levels=month.name), y=SampleRate, group=as.factor(YEAR), colour=as.factor(YEAR), fill=as.factor(YEAR), 
           #text=paste0(MONTH, sep=" ", YEAR)
       )) +
  geom_line(size=1, alpha=0.9) +
  geom_point(size=3, alpha=0.8, shape=21) +
  scale_y_continuous(labels = scales::percent, limits = c(0,0.3)) +
  labs(x="", y="Sample Rate", fill="", colour="") +
  theme_bw() +
  theme(axis.text = element_text(size=15, colour="black"),
        axis.title = element_text(size=17, face="bold"),
        legend.position = c(0.9,0.2),
        legend.text = element_text(size=12),
        strip.text = element_text(size=14)) +
  facet_wrap(~PFMA, nrow=2, scales="free_y") 
```

<br>

## Area 21 and 121 Chinook catch and release data

```{r sampRate, eval=F}
samp_Rate %>%
  kbl(align="c", caption="Chinook caught and released by size status (legal/sublegal) in Area 21 and 121 and associated sample rates. Note though there are extra-legal designations that may not be represented in catch estimates. Sample rate of NA indicates no samples were taken for that area-month-year.") %>%
  kable_paper("hover", full_width=T, position = "center") 
```








```{r include=F}
# ========================= DATA EXPORT =========================

readme <- data.frame("x1" = c("Last update: ",
                              "Created by: ",
                              "Source biodata from: ",
                              "Source biodata last download: ",
                              "Source catch data from: "),
                     "x2" = c(as.character(Sys.Date()),
                              Sys.info()[7][[1]],
                              "CREST 'Biological Data With Results'",
                              "January 2025",
                              "//ENT.dfo-mpo.ca/DFO-MPO/GROUP/PAC/Reg_Shares/FHM/SMCS/Salmon/FMCR_Fishery_Monitoring_Catch_Reporting/Recreational_CM/Catch_Data/SC Sport Catch Creel Sub-area Disposition (Master Do No Edit).xlsx"
                              )
                     )

# ==================== CREATE EXCEL FILE ==================== 

# Create Workbook ---------------------------
Nit.WCVIrec <- openxlsx::createWorkbook()

# Add tabs to Workbook ---------------------------
openxlsx::addWorksheet(Nit.WCVIrec, "readme")
openxlsx::addWorksheet(Nit.WCVIrec, "All Nitinat catch estimates")
openxlsx::addWorksheet(Nit.WCVIrec, "Nitinat Hatchery catch estimates")



# Add data to tabs ---------------------------
openxlsx::writeData(Nit.WCVIrec, sheet="readme", x=readme)
openxlsx::writeData(Nit.WCVIrec, sheet="All Nitinat catch estimates", 
                    x = WCVIcrestBDWR.catEst.Nit %>% 
                      group_by(YEAR, MONTH, AREA, isNit2) %>% 
                      summarize(`Stock ID2 n` = sum(n_lvl1, na.rm=T),
                                `Total Kept Legal Catch per Area-Month-Year` = unique(Est_Kept),
                                #`Est_Released Legal` = unique(`Est_Released Legal`)
                                )  %>%
                      group_by(YEAR, MONTH, AREA) %>% 
                      mutate(`Total Samples per Area-Month-Year` = sum(`Stock ID2 n`, na.rm=T),
                             `Stock ID2 % (n/Total)` = `Stock ID2 n`/`Total Samples per Area-Month-Year`,
                             `Estimated Kept Legal Catch by Stock ID2 (%*total catch)` = 
                               round(`Stock ID2 % (n/Total)`*`Total Kept Legal Catch per Area-Month-Year`, 0),
                             #NitOnly_forPlot = case_when(grepl("Other", isNit2) ~ Est_Kept-estKeptByID,
                            #                             TRUE ~ estKeptByID),
                            # NitOnly_forPlot = case_when(NitOnly_forPlot==0 ~ NA,
                             #                            TRUE ~ NitOnly_forPlot)
                            ) %>%
                      rename(`Stock ID2` = isNit2) %>%
                      ungroup() %>%
                      full_join(data.frame(AREA=c("127", "27", "126", "26", "125", "25", "124", "24", "123", "23", "121", "22", 
                                                  "21", "20")) %>%
                                  mutate(YEAR=rep(2023, nrow(.)),
                                         MONTH=rep("May", nrow(.))),
                                .,
                                by=c("YEAR", "MONTH", "AREA")) %>%
                      complete(., YEAR, MONTH, AREA)
                    )

openxlsx::writeData(Nit.WCVIrec, sheet="Nitinat Hatchery catch estimates", 
                    x = WCVIcrestBDWR.catEst.Nit %>% 
                      group_by(YEAR, MONTH, AREA, isNit3) %>% 
                      summarize(`Stock ID3 n` = sum(n_lvl1, na.rm=T),
                                `Total Kept Legal Catch per Area-Month-Year` = unique(Est_Kept),
                                #`Est_Released Legal` = unique(`Est_Released Legal`)
                                )  %>%
                      group_by(YEAR, MONTH, AREA) %>% 
                      mutate(`Total Samples per Area-Month-Year` = sum(`Stock ID3 n`, na.rm=T),
                             `Stock ID3 % (n/Total)` = `Stock ID3 n`/`Total Samples per Area-Month-Year`,
                             `Estimated Kept Legal Catch by Stock ID3 (%*total catch)` = 
                               round(`Stock ID3 % (n/Total)`*`Total Kept Legal Catch per Area-Month-Year`, 0),
                             #NitOnly_forPlot = case_when(grepl("Other", isNit2) ~ Est_Kept-estKeptByID,
                            #                             TRUE ~ estKeptByID),
                            # NitOnly_forPlot = case_when(NitOnly_forPlot==0 ~ NA,
                             #                            TRUE ~ NitOnly_forPlot)
                            ) %>%
                      rename(`Stock ID3` = isNit3) %>%
                      ungroup() %>%
                      full_join(data.frame(AREA=c("127", "27", "126", "26", "125", "25", "124", "24", "123", "23", "121", "22", 
                                                  "21", "20")) %>%
                                  mutate(YEAR=rep(2023, nrow(.)),
                                         MONTH=rep("May", nrow(.))),
                                .,
                                by=c("YEAR", "MONTH", "AREA")) %>%
                      complete(., YEAR, MONTH, AREA)
                    )



# ==================== EXPORT EXCEL FILE ==================== 

# To github ---------------------------
openxlsx::saveWorkbook(Nit.WCVIrec,
                       file=paste0(here::here("outputs"),
                                   "/R_OUT - Biological_Data_With_Results (WCVI GROUPED) ",
                                   min(crestBDWR_CNgrouped$YEAR),
                                   "-",
                                   max(crestBDWR_CNgrouped$YEAR),
                                   ".xlsx"),
                       overwrite=T,
                       returnValue=T)






```

